<!DOCTYPE html>
<html lang="en" data-style-rollout="modern">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E8LNVNG5M1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-E8LNVNG5M1');
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">RKL Season 7 Player</title>
    <link rel="stylesheet" href="/css/global-styles.css">
    <link rel="stylesheet" href="/css/player.css">
    <link rel="icon" href="/rklfavicon.ico" type="image/x-icon" />
    <style id="team-icon-styles"></style>
    <style>
        /* S7-specific badge styles */
        .all-star-badge {
            color: gold;
            text-shadow: 0 0 3px #a18000;
            font-size: 0.8em;
            margin-left: 8px;
            vertical-align: text-top;
        }
        .rookie-badge {
            background-color: #6c757d;
            color: white;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.65em;
            font-weight: bold;
            margin-left: 8px;
            line-height: 1;
        }
        .player-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .modal-content {
            background-color: #fff;
            margin: 2rem auto;
            border-radius: 8px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: background-color 0.3s;
        }
        .modal-header {
            background-color: #333;
            color: white;
            padding: 1.5rem;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            color: white;
            margin: 0;
            font-size: 1.4rem;
        }
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .close-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .modal-body {
            padding: 2rem;
        }
        .game-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .team-breakdown {
            background-color: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .team-breakdown.winner {
            border-color: #28a745;
            border-width: 2px;
        }
        .modal-team-header {
            background-color: #333;
            color: white;
            padding: 1.5rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            flex-direction: column;
            transition: background-color 0.3s;
        }
        .modal-team-header.winner {
            background-color: #28a745;
        }
        .modal-team-header .team-logo {
            width: 48px;
            height: 48px;
            border-radius: 4px;
        }
        .modal-team-header h4 {
            color: white;
        }
        .team-total {
            background-color: #e9ecef;
            padding: 1rem;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            border-bottom: 2px solid #ddd;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .lineup-table {
            width: 100%;
            border-collapse: collapse;
        }
        .lineup-table th {
            background-color: #f8f9fa;
            padding: 0.8rem 0.5rem;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            font-size: 0.9rem;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .lineup-table td {
            padding: 0.8rem 0.5rem;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
            text-align: center;
            transition: border-color 0.3s;
        }
        .lineup-table th:first-child, .lineup-table td:first-child {
            text-align: left;
        }
        .captain-badge {
            background-color: #ffc107;
            color: #333;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        .captain-bonus {
            font-size: 0.75rem;
            color: #ffc107;
            font-weight: 500;
            margin-top: 0.2rem;
        }
        .player-name-cell {
            font-weight: 500;
        }
        .player-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .player-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }
        .points-cell {
            text-align: center;
            font-weight: bold;
        }
        .rank-cell {
            text-align: center;
            color: #666;
            transition: color 0.3s;
        }
        /* Dark mode for modal */
        .dark-mode .modal-content {
            background-color: #1e1e1e;
        }
        .dark-mode .close-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .dark-mode .team-breakdown {
            background-color: #2c2c2c;
            border-color: #444;
        }
        .dark-mode .team-breakdown.winner {
            border-color: #66bb6a;
        }
        .dark-mode .modal-team-header.winner {
            background-color: #2e7d32;
        }
        .dark-mode .team-total {
            background-color: #333;
            border-bottom-color: #444;
        }
        .dark-mode .lineup-table th {
            background-color: #2c2c2c;
            border-bottom-color: #444;
        }
        .dark-mode .lineup-table td {
            border-color: #333;
        }
        .dark-mode .lineup-table tr:hover {
            background-color: #383838;
        }
        .dark-mode .player-link {
            color: #8ab4f8;
        }
        .dark-mode .player-link:hover {
            color: #a7c7fa;
        }
        .dark-mode .rank-cell {
            color: #aaa;
        }
        /* Responsive modal */
        @media (max-width: 768px) {
            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
            .game-details-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .modal-body {
                padding: 1rem;
            }
            .lineup-table th, .lineup-table td {
                padding: 0.5rem 0.3rem;
                font-size: 0.8rem;
            }
            .modal-team-header .team-logo {
                width: 36px;
                height: 36px;
            }
        }
    </style>
    <script>
        // Apply theme from local storage before page loads to prevent flashing
        (function () {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>
    <header>
        <button id="theme-toggle-btn" aria-label="Toggle Theme">
            <span class="sun-icon">‚òÄÔ∏è</span>
            <span class="moon-icon">üåô</span>
        </button>
        <h1>
            <a href="/index.html" class="header-link">
                <img src="/icons/RKL.webp" alt="RKL Logo" class="header-logo" onerror="this.style.display='none'" loading="lazy">
                <span class="header-text">Real Karma League</span>
            </a>
        </h1>
        <nav>
            <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">&#9776;</button>
            <ul id="nav-menu">
                <li class="dropdown">
                    <a href="RKL-S7.html" class="dropbtn">S7 Home &#9662;</a>
                    <div class="dropdown-content">
                        <a href="/S9/RKL-S9.html">S9 Home</a>
                        <a href="/S8/RKL-S8.html">S8 Home</a>
                        <a href="/S7/RKL-S7.html">S7 Home</a>
                    </div>
                </li>
                <li><a href="standings.html">Standings & Rankings</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0);" class="dropbtn">Stats Hub &#9662;</a>
                    <div class="dropdown-content">
                        <a href="leaderboards.html">Leaderboards</a>
                        <a href="compare.html">Comparison Tool</a>
                    </div>
                </li>
                <li><a href="schedule.html">Schedule</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0);" class="dropbtn">Draft Central &#9662;</a>
                    <div class="dropdown-content">
                        <a href="draft-capital.html">Draft Capital</a>
                        <a href="draft-results.html">Draft Results</a>
                        <a href="draft-lottery.html">Draft Lottery</a>
                    </div>
                </li>
                <li><a href="transactions.html">Transactions</a></li>
                <li><a href="teams.html">Teams</a></li>
                <li><a href="/S9/players.html">Players</a></li>
                <li><a href="trophy-case.html">Trophy Case</a></li>
                <li><a href="/common/changelog.html">Changelog</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <a href="#" id="postseason-btn" class="back-button" style="background-color: #6c757d;">View Postseason Profile</a>
        <a href="leaderboards.html" class="back-button">Leaderboards</a>

        <div class="player-header">
            <div class="player-main-info" id="player-main-info">
                <div class="loading">Loading player information...</div>
            </div>
            <div class="player-stats-grid" id="player-stats" style="display: none;"></div>
        </div>

        <div class="content-grid">
            <div class="performance-section">
                <div class="section-header"><h3>Weekly Performance</h3></div>
                <div class="performance-table-container">
                    <table class="performance-table">
                        <thead><tr><th>Week</th><th>Points</th><th>Rank</th><th>Role</th></tr></thead>
                        <tbody id="performance-table"><tr><td colspan="4" class="loading">Loading performance data...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div class="performance-section">
                <div class="section-header"><h3>Game History</h3></div>
                <div class="game-history" id="game-history">
                    <div class="loading">Loading game history...</div>
                </div>
            </div>
        </div>
    </main>

    <div id="game-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-title">Game Details</h3><button class="close-btn" onclick="closeGameModal()">&times;</button></div>
            <div class="modal-body"><div id="modal-content"> <div class="loading">Loading game details...</div></div></div>
        </div>
    </div>

    <footer>
        <p>@caustic on Real</p>
        <a href="/common/trade-block.html">GM Portal</a> | <a href="/commish/dashboard.html">Commish</a>
    </footer>

    <script src="../js/main.js" type="module"></script>
    <script>
        const SHEET_ID = '12EembQnztbdKx2-buv00--VDkEFSTuSXTRdOnTnRxq4';
        const BASE_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=`;

        let playerHandle = null;
        let playerData = null;
        let allTeams = [];
        let allLineups = [];
        let allScheduleData = [];
        let allTransactionsLogData = [];
        let allPlayersProcessed = [];

        function parseNumber(value) {
            if (value === null || typeof value === 'undefined' || String(value).trim() === '') return 0;
            const cleaned = String(value).replace(/,/g, '');
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? 0 : parsed;
        }

        async function fetchSheetData(sheetName) {
            try {
                const response = await fetch(BASE_URL + encodeURIComponent(sheetName));
                const csvText = await response.text();
                return parseCSV(csvText);
            } catch (error) {
                console.error(`Error fetching ${sheetName}:`, error);
                return null;
            }
        }
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = parseCSVLine(lines[0]);
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => { row[header] = values[index] || ''; });
                data.push(row);
            }
            return data;
        }
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') { inQuotes = !inQuotes; }
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else { current += char; }
            }
            result.push(current.trim());
            return result.map(field => field.replace(/^"(.*)"$/, '$1'));
        }
        function generateIconStylesheet(teams) {
            let iconStyles = '.team-logo-css { background-size: cover; background-position: center; background-repeat: no-repeat; display: inline-block; vertical-align: middle; flex-shrink: 0; border-radius: 4px; }\n';
            teams.forEach(team => {
                const className = `icon-${team.team_id.replace(/[^a-zA-Z0-9]/g, '')}`;
                iconStyles += `.${className} { background-image: url('/icons/${team.team_id}.webp'); }\n`;
            });
            const styleElement = document.getElementById('team-icon-styles');
            if (styleElement) {
                styleElement.innerHTML = iconStyles;
            }
        }
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        function getTeamName(teamId) {
            const team = allTeams.find(t => t.team_id === teamId);
            return team ? team.team_name : teamId;
        }
        function getOrdinal(numInput) {
            const n = parseInt(String(numInput));
            if (isNaN(n) || n <= 0) return String(numInput);
            const suffix = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return n + (suffix[(v - 20) % 10] || suffix[v] || suffix[0]);
        }

        function calculateAllPlayerStats(players, weeklyAverages, lineups) {
            if (!players || !weeklyAverages || !lineups) {
                return players || [];
            }
            const weeklyAveragesMap = {};
            weeklyAverages.forEach(week => {
                if (week.date) {
                    weeklyAveragesMap[week.date] = {
                        mean_score: parseNumber(week.mean_score),
                        median_score: parseNumber(week.median_score)
                    };
                }
            });

            return players.map(player => {
                const playerGames = lineups.filter(lineup =>
                    lineup.player_handle === player.player_handle &&
                    (String(lineup.started).toUpperCase() === 'TRUE')
                );

                let totalPlayerKarmaRawForREL = 0;
                let totalMeanKarma = 0;
                let totalMedianKarma = 0;
                let validGamesForREL = 0;
                const ranks = [];
                let t100_finishes = 0;
                let t50_finishes = 0;

                playerGames.forEach(game => {
                    const gameDate = game.date;
                    const playerKarmaRawForRELCalculation = parseNumber(game.points_raw);
                    const globalRank = parseNumber(game.global_rank);

                    if (weeklyAveragesMap[gameDate]) {
                        totalPlayerKarmaRawForREL += playerKarmaRawForRELCalculation;
                        totalMeanKarma += weeklyAveragesMap[gameDate].mean_score;
                        totalMedianKarma += weeklyAveragesMap[gameDate].median_score;
                        validGamesForREL++;
                    }
                    if (globalRank > 0) {
                        ranks.push(globalRank);
                        if (globalRank <= 100) {
                            t100_finishes++;
                        }
                        if (globalRank <= 50) {
                            t50_finishes++;
                        }
                    }
                });

                const avgPlayerRawKarmaForREL = validGamesForREL > 0 ? totalPlayerKarmaRawForREL / validGamesForREL : 0;
                const avgMeanKarma = validGamesForREL > 0 ? totalMeanKarma / validGamesForREL : 0;
                const avgMedianKarma = validGamesForREL > 0 ? totalMedianKarma / validGamesForREL : 0;

                const calculated_rel_mean = avgMeanKarma > 0 ? (avgPlayerRawKarmaForREL / avgMeanKarma) : 0;
                const calculated_rel_median = avgMedianKarma > 0 ? (avgPlayerRawKarmaForREL / avgMedianKarma) : 0;

                let calculated_median_rank = Infinity;
                if (ranks.length > 0) {
                    ranks.sort((a, b) => a - b);
                    const mid = Math.floor(ranks.length / 2);
                    calculated_median_rank = ranks.length % 2 === 0 ? (ranks[mid - 1] + ranks[mid]) / 2 : ranks[mid];
                }

                const games_played_count = parseInt(player.games_played || 0);

                return {
                    ...player,
                    calculated_rel_mean: calculated_rel_mean,
                    calculated_rel_median: calculated_rel_median,
                    calculated_median_rank: calculated_median_rank,
                    aag_mean: parseNumber(player.aag_mean),
                    aag_mean_pct: parseNumber(player.aag_mean_pct),
                    aag_median: parseNumber(player.aag_median),
                    aag_median_pct: parseNumber(player.aag_median_pct),
                    t100_finishes: t100_finishes,
                    t100_finishes_pct: games_played_count > 0 ? (t100_finishes / games_played_count) : 0,
                    t50_finishes: t50_finishes,
                    t50_finishes_pct: games_played_count > 0 ? (t50_finishes / games_played_count) : 0,
                    total_points: parseNumber(player.total_points),
                    games_played: games_played_count,
                    WAR: parseNumber(player.WAR),
                    gem: parseNumber(player.GEM)
                };
            });
        }


        function calculatePlayerRankings(playerDataToRank, allActivePlayers, is3GPMinimumActive) {
            const rankings = {};
            const playerGamesPlayed = parseInt(playerDataToRank.games_played || 0);

            const getSpecificStatRankingPool = (players) => {
                if (is3GPMinimumActive) {
                    return players.filter(p => parseInt(p.games_played || 0) >= 3);
                }
                return players.filter(p => parseInt(p.games_played || 0) > 0);
            };

            let rankNum; // Reusable rank number

            // WAR Ranking
            const warPool = allActivePlayers.filter(p => parseInt(p.games_played || 0) >= 1);
            const warPlayersSorted = [...warPool].sort((a, b) => (b.WAR || 0) - (a.WAR || 0));
            rankNum = warPlayersSorted.findIndex(p => p.player_handle === playerDataToRank.player_handle) + 1;
            rankings.war = rankNum > 0 ? `${getOrdinal(rankNum)} Overall` : 'Unranked';

            // REL Median
            if (is3GPMinimumActive && playerGamesPlayed < 3) {
                rankings.relMedian = "Unranked (3 GP req)";
            } else {
                const pool = getSpecificStatRankingPool(allActivePlayers);
                if (playerDataToRank.calculated_rel_median === 0 && playerGamesPlayed === 0) {
                    rankings.relMedian = "Unranked";
                } else {
                    const sortedPool = [...pool].sort((a, b) => parseFloat(b.calculated_rel_median || 0) - parseFloat(a.calculated_rel_median || 0));
                    rankNum = sortedPool.findIndex(p => p.player_handle === playerDataToRank.player_handle) + 1;
                    rankings.relMedian = rankNum > 0 ? `${getOrdinal(rankNum)} Overall` : (pool.some(p => p.player_handle === playerDataToRank.player_handle) ? 'Not Ranked' : 'Unranked');
                }
            }

            // Median Gameday Rank
            if (is3GPMinimumActive && playerGamesPlayed < 3) {
                rankings.medianRank = "Unranked (3 GP req)";
            } else {
                if (playerDataToRank.calculated_median_rank === Infinity || playerGamesPlayed === 0) {
                    rankings.medianRank = "Unranked";
                } else {
                    const pool = getSpecificStatRankingPool(allActivePlayers).filter(p => p.calculated_median_rank !== Infinity);
                    const sortedPool = [...pool].sort((a, b) => parseFloat(a.calculated_median_rank || Infinity) - parseFloat(b.calculated_median_rank || Infinity));
                    rankNum = sortedPool.findIndex(p => p.player_handle === playerDataToRank.player_handle) + 1;
                    rankings.medianRank = rankNum > 0 ? `${getOrdinal(rankNum)} Overall` : (pool.some(p => p.player_handle === playerDataToRank.player_handle) ? 'Not Ranked' : 'Unranked');
                }
            }

            // GEM Ranking
            if (is3GPMinimumActive && playerGamesPlayed < 3) {
                rankings.gem = "Unranked (3 GP req)";
            } else {
                const pool = getSpecificStatRankingPool(allActivePlayers).filter(p => p.gem > 0);
                if (playerDataToRank.gem > 0) {
                    const sortedPool = [...pool].sort((a, b) => parseFloat(a.gem || Infinity) - parseFloat(b.gem || Infinity));
                    rankNum = sortedPool.findIndex(p => p.player_handle === playerDataToRank.player_handle) + 1;
                    rankings.gem = rankNum > 0 ? `${getOrdinal(rankNum)} Overall` : 'Not Ranked';
                } else {
                    rankings.gem = "Unranked";
                }
            }

            // Games Above Median Ranking
            const gamesAboveMedianPool = allActivePlayers.filter(p => parseInt(p.games_played || 0) > 0);
            const sortedPool = [...gamesAboveMedianPool].sort((a, b) => {
                const valA = parseInt(a.aag_median || 0);
                const valB = parseInt(b.aag_median || 0);
                if (valB !== valA) return valB - valA;

                const pctA = parseFloat(a.aag_median_pct || 0);
                const pctB = parseFloat(b.aag_median_pct || 0);
                return pctB - pctA;
            });

            if (sortedPool.length > 0) {
                // Assign ranks, handling ties
                sortedPool[0].rank = 1;
                for (let i = 1; i < sortedPool.length; i++) {
                    const current = sortedPool[i];
                    const prev = sortedPool[i - 1];
                    if (parseInt(current.aag_median || 0) === parseInt(prev.aag_median || 0) && parseFloat(current.aag_median_pct || 0) === parseFloat(prev.aag_median_pct || 0)) {
                        current.rank = prev.rank;
                    } else {
                        current.rank = i + 1;
                    }
                }

                const rankedPlayer = sortedPool.find(p => p.player_handle === playerDataToRank.player_handle);
                if (rankedPlayer && rankedPlayer.rank > 0) {
                    rankings.gamesAboveMedian = `${getOrdinal(rankedPlayer.rank)} Overall`;
                } else {
                    rankings.gamesAboveMedian = "Unranked";
                }
            } else {
                rankings.gamesAboveMedian = "Unranked";
            }

            return rankings;
        }

        async function loadPlayerData() {
            const playerHandleParam = getUrlParameter('player');
            const playerIdParam = getUrlParameter('id');

            if (!playerHandleParam && !playerIdParam) {
                document.getElementById('player-main-info').innerHTML = '<div class="error">No player handle or ID specified in URL.</div>';
                return;
            }

            const [playersRaw, teams, weeklyAveragesRaw, lineupsRaw, schedule, transactions] = await Promise.all([
                fetchSheetData('Players'), fetchSheetData('Teams'),
                fetchSheetData('Weekly_Averages'), fetchSheetData('Lineups'),
                fetchSheetData('Schedule'),
                fetchSheetData('Transaction_Log')
            ]);

            if (!playersRaw || !teams || !weeklyAveragesRaw || !lineupsRaw) {
                document.getElementById('player-main-info').innerHTML = '<div class="error">Error loading critical player data</div>';
                return;
            }
            allTeams = teams;
            allLineups = lineupsRaw;
            allScheduleData = schedule || [];
            allTransactionsLogData = transactions || [];

            // Generate team icon styles
            generateIconStylesheet(teams);

            allPlayersProcessed = calculateAllPlayerStats(playersRaw, weeklyAveragesRaw, lineupsRaw);

            // Find player data by ID first, then fall back to handle
            if (playerIdParam) {
                playerData = allPlayersProcessed.find(p => p.player_id === playerIdParam);
            } else if (playerHandleParam) {
                playerData = allPlayersProcessed.find(p => p.player_handle === playerHandleParam);
            }

            if (!playerData) {
                document.getElementById('player-main-info').innerHTML = '<div class="error">Player not found</div>';
                return;
            }
            
            // Set the global playerHandle from the found player data
            playerHandle = playerData.player_handle;

            // Update postseason button link now that we have the correct handle
            if (playerHandle) {
                const postseasonBtn = document.getElementById('postseason-btn');
                if (postseasonBtn) {
                    postseasonBtn.href = `postseason-player.html?player=${encodeURIComponent(playerHandle)}`;
                }
            }
            
            // Continue with the rest of the page load
            const playersMeeting3Games = allPlayersProcessed.filter(p => p.player_status === 'ACTIVE' && parseInt(p.games_played || 0) >= 3).length;
            const is3GPMinimumActive = playersMeeting3Games >= 120;

            const allActivePlayers = allPlayersProcessed.filter(p => p.player_status === 'ACTIVE');
            const rankings = calculatePlayerRankings(playerData, allActivePlayers, is3GPMinimumActive);

            displayPlayerHeader(rankings);
            await Promise.all([loadPerformanceData(), loadGameHistory()]);
        }

        function getGamesPlayedForTeam(pHandle, tId, lineupsData) {
            return lineupsData.filter(l =>
                l.player_handle === pHandle &&
                l.team_id === tId &&
                (String(l.started).toLowerCase() === 'true' || l.started === true || l.started === 1)
            ).length;
        }

        function displayPlayerHeader(rankings) {
            document.getElementById('page-title').textContent = `${playerData.player_handle} - RKL Season 7`;

            let teamLogoHTML = '';
            let teamInfoHTML = '';
            let previousTeamsHTML = '';

            const isFreeAgent = !playerData.current_team_id || playerData.current_team_id === 'FREE_AGENT';
            const teamId = isFreeAgent ? 'FREE_AGENT' : playerData.current_team_id;
            const teamName = isFreeAgent ? 'Free Agent' : getTeamName(teamId);
            const teamIdClassName = `icon-${teamId.replace(/[^a-zA-Z0-9]/g, '')}`;

            teamLogoHTML = `<div class="team-logo-css team-logo-large ${teamIdClassName}" role="img" aria-label="${teamName}"></div>`;

            if (!isFreeAgent) {
                teamInfoHTML = `<a href="team.html?id=${playerData.current_team_id}" class="team-info">Current Team: ${teamName}</a>`;
            } else {
                teamInfoHTML = `<div class="team-info" style="color:#6c757d; cursor:default;">Current Team: Free Agent</div>`;
            }

            const playedForTeamsSet = new Set();
            (allLineups || []).forEach(l => {
                if (l.player_handle === playerHandle && (String(l.started).toLowerCase() === 'true' || l.started === true || l.started === 1) && l.team_id) {
                    playedForTeamsSet.add(l.team_id);
                }
            });

            const previousTeamInfoArray = [];
            playedForTeamsSet.forEach(teamIdPlayedFor => {
                if (teamIdPlayedFor !== playerData.current_team_id && teamIdPlayedFor && teamIdPlayedFor.toUpperCase() !== 'FA' && teamIdPlayedFor.toUpperCase() !== 'FREE_AGENT' && teamIdPlayedFor.toUpperCase() !== 'RETIRED') {
                    const gp = getGamesPlayedForTeam(playerHandle, teamIdPlayedFor, allLineups);
                    if (gp > 0) {
                        previousTeamInfoArray.push({ teamId: teamIdPlayedFor, teamName: getTeamName(teamIdPlayedFor), gp: gp });
                    }
                }
            });

            if (previousTeamInfoArray.length > 0) {
                const prefix = previousTeamInfoArray.length > 1 ? "Previous Teams: " : "Previous Team: ";
                const teamsStr = previousTeamInfoArray.map(pt => `<a href="team.html?id=${pt.teamId}" style="color: #666; text-decoration:none;" onmouseover="this.style.textDecoration='underline';" onmouseout="this.style.textDecoration='none';">${pt.teamName}</a> (${pt.gp} GP)`).join(", ");
                previousTeamsHTML = `<div class="player-previous-teams">${prefix}${teamsStr}</div>`;
            }

            const gamesPlayed = parseInt(playerData.games_played || 0);
            const isAllStar = playerData.all_star === '1';
            const isRookie = playerData.rookie === '1';

            document.getElementById('player-main-info').innerHTML = `
              ${teamLogoHTML}
              <div class="player-details">
                <h2>${playerData.player_handle}${isRookie ? '<span class="rookie-badge">R</span>' : ''}${isAllStar ? ' <span class="all-star-badge">‚òÖ</span>' : ''}</h2>
                <div class="player-subtitle">${playerData.player_status} ‚Ä¢ ${gamesPlayed} games played</div>
                ${teamInfoHTML}
                ${previousTeamsHTML}
              </div>`;

            const warValue = playerData.WAR || 0;
            const relMedian = playerData.calculated_rel_median || 0;
            const gemValue = playerData.gem || 0;
            const gamesAboveMedian = playerData.aag_median || 0;

            let medianRankValueForDisplay = '-';
            if (playerData.calculated_median_rank !== Infinity && playerData.calculated_median_rank > 0) {
                const roundedRank = Math.round(playerData.calculated_median_rank);
                medianRankValueForDisplay = roundedRank > 0 ? roundedRank : '-';
            }

            const rankClass = (rankText) => String(rankText).includes("req") ? "stat-rank unranked-gp-required" : "stat-rank";

            document.getElementById('player-stats').innerHTML = `
              <a href="leaderboards.html?category=war" class="stat-card-link"><div class="stat-card">
                <div class="stat-value">${warValue.toFixed(2)}</div><div class="stat-label">WAR</div><div class="${rankClass(rankings.war)}">${rankings.war}</div></div></a>
              <a href="leaderboards.html?category=rel_median" class="stat-card-link"><div class="stat-card">
                <div class="stat-value">${relMedian.toFixed(3)}</div><div class="stat-label">REL Median</div><div class="${rankClass(rankings.relMedian)}">${rankings.relMedian}</div></div></a>
              <a href="leaderboards.html?category=median_gameday_rank" class="stat-card-link"><div class="stat-card">
                <div class="stat-value">${medianRankValueForDisplay}</div><div class="stat-label">Median Gameday Rank</div><div class="${rankClass(rankings.medianRank)}">${rankings.medianRank}</div></div></a>
              <a href="leaderboards.html?category=gem" class="stat-card-link"><div class="stat-card">
                <div class="stat-value">${gemValue > 0 ? gemValue.toFixed(1) : '-'}</div><div class="stat-label">GEM</div><div class="${rankClass(rankings.gem)}">${rankings.gem}</div></div></a>
              <a href="leaderboards.html?category=aag_median" class="stat-card-link"><div class="stat-card"> <div class="stat-value">${gamesAboveMedian}</div><div class="stat-label">Games Above Median</div><div class="${rankClass(rankings.gamesAboveMedian)}">${rankings.gamesAboveMedian || 'Unranked'}</div></div></a>
              `;
            document.getElementById('player-stats').style.display = 'grid';
        }

        function formatWeeklyPerformanceRank(globalRankStr) {
            const rank = parseInt(globalRankStr);
            if (isNaN(rank) || rank <= 0) return '-';
            if (rank === 1) return `<span class="rank-badge rank-gold">1</span>`;
            if (rank === 2) return `<span class="rank-badge rank-silver">2</span>`;
            if (rank === 3) return `<span class="rank-badge rank-bronze">3</span>`;
            if (rank >= 4 && rank <= 100) return `<span class="rank-badge rank-skyblue">${rank}</span>`;
            return rank;
        }

        async function loadPerformanceData() {
            if (!allLineups || !allScheduleData) {
                document.getElementById('performance-table').innerHTML = '<tr><td colspan="4" class="error">Error loading performance data</td></tr>';
                return;
            }
            const playerLineups = allLineups
                .filter(lineup => lineup.player_handle === playerHandle && (String(lineup.started).toLowerCase() === 'true' || lineup.started === true || lineup.started === 1))
                .sort((a, b) => parseInt(a.week || 0) - parseInt(b.week || 0));

            if (playerLineups.length === 0) {
                document.getElementById('performance-table').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: #666;">No games played yet</td></tr>';
                return;
            }

            const performanceHTML = playerLineups.map(lineup => {
                const isCaptain = String(lineup.captain).toLowerCase() === 'true' || lineup.captain === true || lineup.captain === 1;
                const pointsRaw = parseNumber(lineup.points_raw);
                const globalRank = parseNumber(lineup.global_rank);

                const gameForLineup = allScheduleData.find(g => g.date === lineup.date && (g.team1_id === lineup.team_id || g.team2_id === lineup.team_id));

                let onclickAttr = '';
                if (gameForLineup && gameForLineup.completed === 'TRUE') {
                    onclickAttr = `onclick="showGameDetails(
                  '${gameForLineup.team1_id}',
                  '${gameForLineup.team2_id}',
                  '${gameForLineup.date}'
                )"`;
                }

                return `<tr class="${isCaptain ? 'captain-row' : ''} ${gameForLineup && gameForLineup.completed === 'TRUE' ? 'clickable-row' : ''}" ${onclickAttr}>
                        <td>Week ${lineup.week}${isCaptain ? '<span class="captain-badge-small">C</span>' : ''}</td>
                        <td>${Math.round(pointsRaw).toLocaleString()}${isCaptain ? ` (+${Math.round(pointsRaw * 0.5).toLocaleString()})` : ''}</td>
                        <td>${formatWeeklyPerformanceRank(globalRank)}</td>
                        <td>${isCaptain ? 'Captain' : 'Starter'}</td>
                      </tr>`;
            }).join('');
            document.getElementById('performance-table').innerHTML = performanceHTML;
        }

        async function loadGameHistory() {
            if (!allScheduleData || !allLineups || !allTeams) {
                document.getElementById('game-history').innerHTML = '<div class="error">Error loading game history data.</div>';
                return;
            }
            const playerStartedLineups = allLineups.filter(lineup => lineup.player_handle === playerHandle && (String(lineup.started).toLowerCase() === 'true' || lineup.started === true || lineup.started === 1));
            if (playerStartedLineups.length === 0) {
                document.getElementById('game-history').innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No game history found (player has not started any games).</div>';
                return;
            }

            const gamesWithPerformance = playerStartedLineups.map(lineup => {
                const gameForThisLineup = allScheduleData.find(sGame => sGame.date === lineup.date && (sGame.team1_id === lineup.team_id || sGame.team2_id === lineup.team_id) && String(sGame.completed).toLowerCase() === 'true');
                if (!gameForThisLineup) return null;

                const playerTeamId = lineup.team_id;
                const opponentId = gameForThisLineup.team1_id === playerTeamId ? gameForThisLineup.team2_id : gameForThisLineup.team1_id;

                return { ...gameForThisLineup, playerTeamId, opponentId, lineup: lineup };
            }).filter(game => game !== null).sort((a, b) => {
                const dateA = new Date(a.date); const dateB = new Date(b.date);
                if (dateA.getTime() !== dateB.getTime()) return dateA - dateB;
                const weekA = parseInt(a.lineup.week || '0'); const weekB = parseInt(b.lineup.week || '0');
                return weekA - weekB;
            });

            if (gamesWithPerformance.length === 0) {
                document.getElementById('game-history').innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No completed game history found for started games.</div>';
                return;
            }

            const historyHTML = gamesWithPerformance.map(game => {
                const isCaptain = String(game.lineup.captain).toLowerCase() === 'true' || game.lineup.captain === true || game.lineup.captain === 1;
                const pointsRaw = parseNumber(game.lineup.points_raw);
                const globalRank = parseNumber(game.lineup.global_rank);

                const playerTeamName = getTeamName(game.playerTeamId);
                const opponentTeamName = getTeamName(game.opponentId);
                const playerTeamIdClassName = `icon-${game.playerTeamId.replace(/[^a-zA-Z0-9]/g, '')}`;
                const opponentIdClassName = `icon-${game.opponentId.replace(/[^a-zA-Z0-9]/g, '')}`;

                let playerTeamResultIndicator = '';
                let opponentTeamResultIndicator = '';

                if (game.winner === game.playerTeamId) {
                    playerTeamResultIndicator = '<span class="game-result-indicator game-result-win">(W)</span>';
                    opponentTeamResultIndicator = '<span class="game-result-indicator game-result-loss">(L)</span>';
                } else if (game.winner === game.opponentId) {
                    playerTeamResultIndicator = '<span class="game-result-indicator game-result-loss">(L)</span>';
                    opponentTeamResultIndicator = '<span class="game-result-indicator game-result-win">(W)</span>';
                }

                return `
                <div class="game-item" onclick="showGameDetails(
                  '${game.team1_id}',
                  '${game.team2_id}',
                  '${game.date}'
                )">
                  <div class="game-history-main-content">
                    <div class="game-history-matchup-teams">
                        <span class="game-history-team-entry">
                          <div class="team-logo-css game-history-team-logo ${playerTeamIdClassName}" role="img" aria-label="${playerTeamName}"></div>
                          <span class="game-history-team-name">${playerTeamName} ${playerTeamResultIndicator}</span>
                        </span>
                        <span class="game-history-vs-separator">vs</span>
                        <span class="game-history-team-entry">
                          <div class="team-logo-css game-history-team-logo ${opponentIdClassName}" role="img" aria-label="${opponentTeamName}"></div>
                          <span class="game-history-team-name">${opponentTeamName} ${opponentTeamResultIndicator}</span>
                        </span>
                    </div>
                    <div class="game-history-date">${formatDate(game.date)} (Week ${game.lineup.week})</div>
                  </div>
                  <div class="game-performance">
                    <div class="performance-score ${isCaptain ? 'captain-performance' : ''}">${Math.round(pointsRaw).toLocaleString()}${isCaptain ? ' (C)' : ''}</div>
                    <div class="performance-rank">Rank: ${globalRank > 0 ? Math.round(globalRank) : '-'}</div>
                  </div>
                </div>`;
            }).join('');
            document.getElementById('game-history').innerHTML = historyHTML;
        }

        async function showGameDetails(team1Id, team2Id, date) {
            const modal = document.getElementById('game-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBodyContent = document.getElementById('modal-content');

            const team1Name = getTeamName(team1Id);
            const team2Name = getTeamName(team2Id);

            modal.style.display = 'block';
            modalTitle.textContent = `${team1Name} vs ${team2Name} - ${formatDate(date)}`;
            modalBodyContent.innerHTML = '<div class="loading">Loading game details...</div>';

            const game = allScheduleData.find(g => g.team1_id === team1Id && g.team2_id === team2Id && g.date === date);
            if (!game) { modalBodyContent.innerHTML = '<div class="error">Game not found in schedule</div>'; return; }

            const lineupsForModal = allLineups;
            if (!lineupsForModal) { modalBodyContent.innerHTML = '<div class="error">Error loading game details (lineups)</div>'; return; }

            const team1AllGameLineups = lineupsForModal.filter(lineup => lineup.team_id === team1Id && lineup.date === date);
            const team2AllGameLineups = lineupsForModal.filter(lineup => lineup.team_id === team2Id && lineup.date === date);

            const sortLogic = (a, b) => (String(a.captain).toLowerCase() === 'true' || a.captain === true || a.captain === 1 ? -1 : 1) - (String(b.captain).toLowerCase() === 'true' || b.captain === true || b.captain === 1 ? -1 : 1) || parseNumber(b.points_final) - parseNumber(a.points_final);

            const team1Lineups = team1AllGameLineups.filter(lineup => String(lineup.started).toLowerCase() === 'true' || lineup.started === true || lineup.started === 1).sort(sortLogic);
            const team2Lineups = team2AllGameLineups.filter(lineup => String(lineup.started).toLowerCase() === 'true' || lineup.started === true || lineup.started === 1).sort(sortLogic);

            const team1Total = team1Lineups.reduce((sum, player) => sum + parseNumber(player.points_final), 0);
            const team2Total = team2Lineups.reduce((sum, player) => sum + parseNumber(player.points_final), 0);
            const winner = game.winner;

            const generateLineupTable = (lineups, teamIdForTable, total, isWinner) => {
                const teamDetails = allTeams.find(t => t.team_id === teamIdForTable);
                const teamNameForTable = teamDetails ? teamDetails.team_name : teamIdForTable;
                const teamRecord = teamDetails ? `${teamDetails.wins || 0}-${teamDetails.losses || 0}` : '';

                const teamIdClassName = `icon-${teamIdForTable.replace(/[^a-zA-Z0-9]/g, '')}`;
                const teamLogoTagInModal = (teamIdForTable && teamIdForTable !== 'FREE_AGENT') ? `<div class="team-logo-css team-logo ${teamIdClassName}" role="img" aria-label="${teamNameForTable}"></div>` : '';

                if (lineups.length === 0) return `<div class="team-breakdown ${isWinner ? 'winner' : ''}"><div class="modal-team-header ${isWinner ? 'winner' : ''}" onclick="window.location.href='team.html?id=${teamIdForTable}'" style="cursor: pointer;">${teamLogoTagInModal}<div><h4>${teamNameForTable}</h4><div style="font-size: 0.9rem; opacity: 0.9;">${teamRecord}</div></div></div><div class="team-total">Total: ${Math.round(total).toLocaleString()}</div><div style="padding: 2rem; text-align: center; color: #666;">No lineup data available for this game.</div></div>`;

                const lineupRows = lineups.map(player => {
                    const isCaptain = String(player.captain).toLowerCase() === 'true' || player.captain === true || player.captain === 1;
                    const pointsRaw = parseNumber(player.points_raw);
                    const globalRank = parseNumber(player.global_rank);
                    const captainBonus = isCaptain ? Math.round(pointsRaw * 0.5) : 0;

                    const fullPlayerData = allPlayersProcessed.find(p => p.player_handle === player.player_handle);
                    const isPlayerAllStar = fullPlayerData && fullPlayerData.all_star === '1';
                    const isRookie = fullPlayerData && fullPlayerData.rookie === '1';
                    const allStarBadge = isPlayerAllStar ? '<span class="all-star-badge">‚òÖ</span>' : '';
                    const rookieBadge = isRookie ? '<span class="rookie-badge">R</span>' : '';

                    return `<tr class="${isCaptain ? 'captain-row' : ''}"><td class="player-name-cell"><a href="player.html?player=${encodeURIComponent(player.player_handle || 'Unknown')}" target="_blank" class="player-link"> ${player.player_handle || 'Unknown'}</a>${rookieBadge}${allStarBadge}${isCaptain ? '<span class="captain-badge">C</span>' : ''}</td><td class="points-cell">${Math.round(pointsRaw).toLocaleString()}${isCaptain ? `<div class="captain-bonus">+${captainBonus.toLocaleString()}</div>` : ''}</td><td class="rank-cell">${globalRank > 0 ? Math.round(globalRank) : '-'}</td></tr>`;
                }).join('');
                return `<div class="team-breakdown ${isWinner ? 'winner' : ''}"><div class="modal-team-header ${isWinner ? 'winner' : ''}" onclick="window.location.href='team.html?id=${teamIdForTable}'" style="cursor: pointer;">${teamLogoTagInModal}<div><h4>${teamNameForTable}</h4><div style="font-size: 0.9rem; opacity: 0.9;">${teamRecord}</div></div></div><div class="team-total">Total: ${isNaN(total) ? '-' : Math.round(total).toLocaleString()}</div><table class="lineup-table"><thead><tr><th>Player</th><th>Points</th><th>Rank</th></tr></thead><tbody>${lineupRows}</tbody></table></div>`;
            };
            modalBodyContent.innerHTML = `<div class="game-details-grid">${generateLineupTable(team1Lineups, team1Id, team1Total, winner === team1Id)}${generateLineupTable(team2Lineups, team2Id, team2Total, winner === team2Id)}</div>`;
        }

        function closeGameModal() {
            document.getElementById('game-modal').style.display = 'none';
        }
        window.onclick = function (event) {
            const modal = document.getElementById('game-modal');
            if (event.target === modal) closeGameModal();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadPlayerData();
        });
    </script>
</body>
</html>
