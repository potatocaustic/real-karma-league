<!DOCTYPE html>
<html lang="en" data-style-rollout="modern">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E8LNVNG5M1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-E8LNVNG5M1');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RKL Draft Lottery Simulator</title>
    <link rel="stylesheet" href="/css/global-styles.css">
    <link rel="stylesheet" href="/css/draft-lottery.css">
    <link rel="icon" href="/rklfavicon.ico" type="image/x-icon" />
    <script>
        // Apply theme from local storage before page loads to prevent flashing
        (function () {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>

    <header>
        <button id="theme-toggle-btn" aria-label="Toggle Theme">
            <span class="sun-icon">‚òÄÔ∏è</span>
            <span class="moon-icon">üåô</span>
        </button>
        <h1>
            <a href="/index.html" class="header-link">
                <img src="/icons/RKL.webp" alt="RKL Logo" class="header-logo" onerror="this.style.display='none'" loading="lazy">
                <span class="header-text">Real Karma League</span>
            </a>
        </h1>
        <nav>
            <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">&#9776;</button>
            <ul id="nav-menu">
                <li class="dropdown">
                    <a href="RKL-S7.html" class="dropbtn">S7 Home &#9662;</a>
                    <div class="dropdown-content">
                        <a href="/S9/RKL-S9.html">S9 Home</a>
                        <a href="/S8/RKL-S8.html">S8 Home</a>
                        <a href="/S7/RKL-S7.html">S7 Home</a>
                    </div>
                </li>
                <li><a href="standings.html">Standings & Rankings</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0);" class="dropbtn">Stats Hub &#9662;</a>
                    <div class="dropdown-content">
                        <a href="leaderboards.html">Leaderboards</a>
                        <a href="compare.html">Comparison Tool</a>
                    </div>
                </li>
                <li><a href="schedule.html">Schedule</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0);" class="dropbtn">Draft Central &#9662;</a>
                    <div class="dropdown-content">
                        <a href="draft-capital.html">Draft Capital</a>
                        <a href="draft-results.html">Draft Results</a>
                        <a href="draft-lottery.html">Draft Lottery</a>
                    </div>
                </li>
                <li><a href="transactions.html">Transactions</a></li>
                <li><a href="teams.html">Teams</a></li>
                <li><a href="/S9/players.html">Players</a></li>
                <li><a href="trophy-case.html">Trophy Case</a></li>
                <li><a href="/common/changelog.html">Changelog</a></li>
            </ul>
        </nav>
    </header>

    <main>

        <div class="page-header">
            <h2 id="table-title">S8 Lottery Odds</h2>
            <p id="table-description">S8 lottery odds for the 14 non-playoff teams.</p>
        </div>

        <div class="quick-links-container">
            <a href="draft-capital.html" class="quick-link-btn">Draft Capital</a>
            <a href="draft-results.html" class="quick-link-btn">S7 Draft Results</a>
        </div>

        <div class="lottery-container">
            <div class="lottery-header">
                <h3 class="lottery-card-title">Season 8 Draft</h3>
                <div id="button-container" class="button-container">
                </div>
            </div>

            <div class="table-container">
                <table id="lottery-table" class="lottery-table">
                    <thead id="lottery-table-head">
                    </thead>
                    <tbody id="lottery-table-body">
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <footer>
        <p>@caustic on Real</p>
        <a href="/common/trade-block.html">GM Portal</a> | <a href="/commish/dashboard.html">Commish</a>
    </footer>

    <script src="../js/main.js" type="module"></script>
    <script>
        // --- DATA AND CONFIGURATION ---
        const SHEET_ID = '12EembQnztbdKx2-buv00--VDkEFSTuSXTRdOnTnRxq4';
        const BASE_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=`;

        const lotteryOdds = [
            { seed: 1, chances: 140, pct1st: 14.0, pctTop4: 52.14 }, { seed: 2, chances: 140, pct1st: 14.0, pctTop4: 52.14 },
            { seed: 3, chances: 140, pct1st: 14.0, pctTop4: 52.14 }, { seed: 4, chances: 125, pct1st: 12.5, pctTop4: 48.08 },
            { seed: 5, chances: 105, pct1st: 10.5, pctTop4: 42.13 }, { seed: 6, chances: 90, pct1st: 9.0, pctTop4: 37.23 },
            { seed: 7, chances: 75, pct1st: 7.5, pctTop4: 31.96 }, { seed: 8, chances: 60, pct1st: 6.0, pctTop4: 26.30 },
            { seed: 9, chances: 45, pct1st: 4.5, pctTop4: 20.27 }, { seed: 10, chances: 30, pct1st: 3.0, pctTop4: 13.88 },
            { seed: 11, chances: 20, pct1st: 2.0, pctTop4: 9.41 }, { seed: 12, chances: 15, pct1st: 1.5, pctTop4: 7.12 },
            { seed: 13, chances: 10, pct1st: 1.0, pctTop4: 4.79 }, { seed: 14, chances: 5, pct1st: 0.5, pctTop4: 2.41 },
        ];
        const DRAFT_SEASON = 8;

        // --- STATE MANAGEMENT ---
        let initialLotteryTeams = [];
        let teamDataMap = {};
        let pickOwnership = {};
        let allPlayoffGames = [];
        let finalLotteryResults = null;

        // --- UTILITY FUNCTIONS ---
        async function fetchSheetData(sheetName) {
            try {
                const response = await fetch(`${BASE_URL}${encodeURIComponent(sheetName)}`);
                if (!response.ok) throw new Error(`Network response not OK for ${sheetName}`);
                return parseCSV(await response.text());
            } catch (error) {
                console.error(`Error fetching ${sheetName}:`, error);
                const tableBody = document.getElementById('lottery-table-body');
                if (tableBody) {
                    tableBody.innerHTML = `<tr><td colspan="5"><div class="error">Failed to load required data from sheet: ${sheetName}. Please try again later.</div></td></tr>`;
                }
                return null;
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            return lines.slice(1).map(line => {
                const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                const row = {};
                if (values.length === headers.length) {
                    headers.forEach((header, index) => {
                        row[header] = values[index].replace(/"/g, '').trim();
                    });
                }
                return row;
            }).filter(row => Object.keys(row).length > 0);
        }

        // --- PLAYOFF LOGIC ---
        function getSeries(seriesId) {
            return allPlayoffGames.find(g => g.series_id === seriesId);
        }

        function getWeekNameFromSeriesId(seriesId) {
            if (seriesId.includes('-PI-')) return 'Play-In';
            if (seriesId.includes('-R1-')) return 'Round 1';
            if (seriesId.includes('-R2-')) return 'Round 2';
            if (seriesId.includes('-CF')) return 'Conf Finals';
            if (seriesId.includes('FINALS')) return 'Finals';
            return '';
        }

        function getSeriesWinner(seriesId) {
            const series = getSeries(seriesId);
            if (!series) return null;

            const week = getWeekNameFromSeriesId(seriesId);
            const team1Wins = parseInt(series.team1_wins, 10) || 0;
            const team2Wins = parseInt(series.team2_wins, 10) || 0;

            if (week === 'Play-In') {
                return series.winner || null;
            }

            let win_condition = 0;
            if (week === 'Round 1' || week === 'Round 2') win_condition = 2;
            else if (week === 'Conf Finals') win_condition = 3;
            else if (week === 'Finals') win_condition = 4;

            if (team1Wins === win_condition) return series.team1_id;
            if (team2Wins === win_condition) return series.team2_id;

            return null;
        }

        // --- RENDERING FUNCTIONS ---
        function renderTableHeader(isSimulatedView = false) {
            const pickOrSeed = isSimulatedView ? 'Pick' : 'Seed';
            document.getElementById('lottery-table-head').innerHTML = `
                <tr>
                    <th scope="col">${pickOrSeed}</th>
                    <th scope="col">Team</th>
                    <th scope="col" class="text-center hidden-mobile">Record</th>
                    <th scope="col" class="text-center">#1 Pick Odds</th>
                    <th scope="col" class="text-center hidden-mobile">Top 4 Odds</th>
                </tr>
            `;
        }

        function getTeamCellHtml(ownerTeam, originalTeam, ownerId, isTraded) {
            const teamName = ownerTeam ? ownerTeam.team_name : 'Unknown';
            const originalTeamName = originalTeam ? originalTeam.team_name : 'Unknown';
            const teamLogoUrl = ownerId ? `icons/${ownerId}.webp` : '';

            if (isTraded) {
                return `
                    <a href="team.html?id=${ownerId}" class="team-cell">
                        <img src="${teamLogoUrl}" alt="${teamName}" class="team-logo" onerror="this.style.display='none'">
                        <div class="team-cell-content">
                            <span class="font-semibold">${teamName}</span>
                            <span class="original-team-traded">${originalTeamName}</span>
                        </div>
                    </a>
                `;
            } else {
                return `
                    <a href="team.html?id=${ownerId}" class="team-cell">
                        <img src="${teamLogoUrl}" alt="${teamName}" class="team-logo" onerror="this.style.display='none'">
                        <span class="font-semibold whitespace-nowrap">${teamName}</span>
                    </a>
                `;
            }
        }


        function renderLotteryOddsTable() {
            renderTableHeader(false);
            const tableBody = document.getElementById('lottery-table-body');
            let html = '';

            initialLotteryTeams.forEach(team => {
                const ownerId = pickOwnership[team.team_id] || team.team_id;
                const ownerTeam = teamDataMap[ownerId];
                const isTraded = team.team_id !== ownerId;
                const teamCellHtml = getTeamCellHtml(ownerTeam, team, ownerId, isTraded);

                html += `
                    <tr>
                        <td class="font-semibold">${team.seed}</td>
                        <td>${teamCellHtml}</td>
                        <td class="text-center hidden-mobile">${team.wins} - ${team.losses}</td>
                        <td class="text-center">${team.pct1st.toFixed(2)}%</td>
                        <td class="text-center hidden-mobile">${team.pctTop4.toFixed(2)}%</td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        }

        function renderSimulatedResults(finalOrder) {
            renderTableHeader(true);
            const tableBody = document.getElementById('lottery-table-body');
            let html = '';

            finalOrder.forEach((originalTeam, index) => {
                const pickNumber = index + 1;
                const ownerId = pickOwnership[originalTeam.team_id] || originalTeam.team_id;
                const ownerTeam = teamDataMap[ownerId];
                const isTraded = originalTeam.team_id !== ownerId;
                const movement = originalTeam.seed - pickNumber;

                let movementHtml;
                if (movement > 0) {
                    movementHtml = `<span class="move-up">‚ñ≤ ${movement}</span>`;
                } else if (movement < 0) {
                    movementHtml = `<span class="move-down">‚ñº ${Math.abs(movement)}</span>`;
                } else {
                    movementHtml = ``; // No indicator for no move
                }

                const teamCellHtml = getTeamCellHtml(ownerTeam, originalTeam, ownerId, isTraded);

                html += `
                    <tr class="fade-in" style="animation-delay: ${index * 50}ms;">
                        <td class="font-semibold">
                            <div style="display: flex; align-items: center; white-space: nowrap;">
                                <span>${pickNumber}</span>
                                ${movementHtml}
                            </div>
                        </td>
                        <td>${teamCellHtml}</td>
                        <td class="text-center hidden-mobile">${originalTeam.wins} - ${originalTeam.losses}</td>
                        <td class="text-center">${originalTeam.pct1st.toFixed(2)}%</td>
                        <td class="text-center hidden-mobile">${originalTeam.pctTop4.toFixed(2)}%</td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        }


        // --- SIMULATION LOGIC ---
        function runSimulation() {
            const combinations = [];
            initialLotteryTeams.forEach(team => {
                for (let i = 0; i < team.chances; i++) {
                    combinations.push(team.seed);
                }
            });

            const top4WinningSeeds = [];
            while (top4WinningSeeds.length < 4) {
                const randomIndex = Math.floor(Math.random() * combinations.length);
                const winningSeed = combinations[randomIndex];
                if (!top4WinningSeeds.includes(winningSeed)) {
                    top4WinningSeeds.push(winningSeed);
                }
            }

            const lotteryWinners = top4WinningSeeds.map(seed => initialLotteryTeams.find(t => t.seed === seed));
            const remainingTeams = initialLotteryTeams
                .filter(team => !top4WinningSeeds.includes(team.seed))
                .sort((a, b) => a.seed - b.seed);

            const finalOrder = [...lotteryWinners, ...remainingTeams];
            renderSimulatedResults(finalOrder);
        }

        // --- UI AND EVENT HANDLING ---
        const buttonContainer = document.getElementById('button-container');

        function renderInitialButtons() {
            buttonContainer.innerHTML = `
                <button id="simulateBtn" class="action-button">
                    Simulate Lottery
                </button>
            `;
        }

        function renderSimulatedButtons() {
            buttonContainer.innerHTML = `
                <button id="simulateAgainBtn" class="action-button">
                    Simulate Again
                </button>
                <button id="resetBtn" class="action-button">
                    Reset
                </button>
            `;
        }

        function disableSimulation() {
            const simulateBtn = document.getElementById('simulateBtn');
            if (simulateBtn) {
                simulateBtn.disabled = true;
            }
            const simulateAgainBtn = document.getElementById('simulateAgainBtn');
            if (simulateAgainBtn) {
                simulateAgainBtn.disabled = true;
            }
        }

        function resetView() {
            document.getElementById('table-title').textContent = 'S8 Lottery Odds';
            document.getElementById('table-description').textContent = 'S8 lottery odds for the 14 non-playoff teams.';
            renderLotteryOddsTable();
            renderInitialButtons();
        }

        function handleFirstSimulation() {
            document.getElementById('table-title').textContent = 'Lottery Simulation';
            document.getElementById('table-description').textContent = 'Projected draft order based on the simulation.';
            runSimulation();
            renderSimulatedButtons();
        }

        function setupButtonListeners() {
            buttonContainer.addEventListener('click', (event) => {
                const button = event.target.closest('button');
                if (!button) return;

                const buttonId = button.id;
                if (buttonId === 'simulateBtn') {
                    handleFirstSimulation();
                } else if (buttonId === 'simulateAgainBtn') {
                    runSimulation();
                } else if (buttonId === 'resetBtn') {
                    resetView();
                }
            });
        }


        // --- INITIALIZATION ---
        async function initializeApp() {
            const tableBody = document.getElementById('lottery-table-body');
            tableBody.innerHTML = `<tr><td colspan="5"><div class="loading">Loading Team Data...</div></td></tr>`;
            renderTableHeader();
            renderInitialButtons();
            document.getElementById('simulateBtn').disabled = true;

            // Set initial titles
            document.getElementById('table-title').textContent = 'S8 Lottery Odds';
            document.getElementById('table-description').textContent = 'S8 lottery odds for the 14 non-playoff teams.';

            // Attempt to load lottery_results.js
            try {
                const lotteryResultsScript = document.createElement('script');
                lotteryResultsScript.src = 'lottery_results.js';
                document.head.appendChild(lotteryResultsScript);
                lotteryResultsScript.onload = () => {
                    if (typeof lotteryResults !== 'undefined') {
                        finalLotteryResults = lotteryResults;
                    }
                    loadDataAndRender();
                };
                lotteryResultsScript.onerror = () => {
                    loadDataAndRender();
                };
            } catch (error) {
                loadDataAndRender();
            }
        }

        async function loadDataAndRender() {
            const [allTeams, draftPicks, playoffGames] = await Promise.all([
                fetchSheetData('Teams'),
                fetchSheetData('Draft_Capital'),
                fetchSheetData('Post_Schedule')
            ]);

            allPlayoffGames = playoffGames;

            if (!allTeams || !draftPicks) {
                // Error is already handled inside fetchSheetData
                renderInitialButtons(); // Render buttons even on fail, but they will be disabled.
                return;
            }

            // Define sets of team IDs and names to exclude from the lottery.
            const excludedTeamIds = new Set(['EGM', 'WGM', 'RSE', 'RSW', 'EAST', 'WEST', 'RETIRED', 'FREE_AGENT']);
            const excludedTeamNames = new Set(['East GMs', 'West GMs', 'East Rising Stars', 'West Rising Stars', 'East All-Stars', 'West All-Stars']);

            // Filter out excluded teams, parse data, and sort by the new logic.
            const sortedTeams = allTeams
                .filter(t => {
                    if (!t.team_id) return false; // Always exclude if no team_id
                    if (excludedTeamIds.has(t.team_id)) return false; // Exclude if ID is in the set
                    if (t.team_name && excludedTeamNames.has(t.team_name)) return false; // Exclude if name is in the set
                    return true; // Otherwise, include the team
                })
                .map(t => ({
                    ...t,
                    wins: parseInt(t.wins, 10) || 0,
                    losses: parseInt(t.losses, 10) || 0,
                    pam: parseFloat(t.pam || 0)
                }))
                .sort((a, b) => {
                    const totalGamesA = a.wins + a.losses;
                    const winPctA = totalGamesA > 0 ? a.wins / totalGamesA : 0;

                    const totalGamesB = b.wins + b.losses;
                    const winPctB = totalGamesB > 0 ? b.wins / totalGamesB : 0;

                    // Primary sort: Ascending win percentage (lower is better seed)
                    if (winPctA !== winPctB) {
                        return winPctA - winPctB;
                    }

                    // Tie-breaker 1: For teams with 0 wins, more losses is worse (gets better seed)
                    if (winPctA === 0) { // This implies winPctB is also 0
                        if (a.losses !== b.losses) {
                            return b.losses - a.losses; // Higher losses come first
                        }
                    }

                    // Tie-breaker 2: Ascending PAM (lower is better seed)
                    return a.pam - b.pam;
                });

            // Playoff teams and play-in teams
            const playoffTeams = new Set();
            for (let i = 1; i <= 6; i++) {
                const eastPlayoffTeam = allTeams.find(t => t.conference === 'Eastern' && parseInt(t.postseed) === i);
                if (eastPlayoffTeam) playoffTeams.add(eastPlayoffTeam.team_id);
                const westPlayoffTeam = allTeams.find(t => t.conference === 'Western' && parseInt(t.postseed) === i);
                if (westPlayoffTeam) playoffTeams.add(westPlayoffTeam.team_id);
            }

            const west7thSeed = getSeriesWinner('W-PI-7v8');
            if (west7thSeed) playoffTeams.add(west7thSeed);
            const west8thSeed = getSeriesWinner('W-PI-L78vW910');
            if (west8thSeed) playoffTeams.add(west8thSeed);

            const east7thSeed = getSeriesWinner('E-PI-7v8');
            if (east7thSeed) playoffTeams.add(east7thSeed);
            const east8thSeed = getSeriesWinner('E-PI-L78vW910');
            if (east8thSeed) playoffTeams.add(east8thSeed);

            // Take the bottom 14 teams for the lottery pool.
            initialLotteryTeams = sortedTeams.filter(team => !playoffTeams.has(team.team_id)).slice(0, 14).map((team, index) => ({
                ...team,
                seed: index + 1,
                ...lotteryOdds[index]
            }));

            // Create a map for quick team data lookup by ID.
            teamDataMap = allTeams.reduce((acc, team) => {
                acc[team.team_id] = team;
                return acc;
            }, {});

            // Process draft pick ownership for the relevant season and round.
            draftPicks.filter(p => parseInt(p.season) === DRAFT_SEASON && parseInt(p.round) === 1)
                .forEach(pick => { pickOwnership[pick.original_team] = pick.current_owner; });

            if (finalLotteryResults) {
                document.getElementById('table-title').textContent = 'Official S8 Lottery Results';
                document.getElementById('table-description').textContent = 'The official results of the Season 8 Draft Lottery.';
                const finalOrder = finalLotteryResults.map(teamId => initialLotteryTeams.find(t => t.team_id === teamId));
                renderSimulatedResults(finalOrder);
                buttonContainer.innerHTML = '';
            } else {
                renderLotteryOddsTable();
                document.getElementById('simulateBtn').disabled = false;
                setupButtonListeners();
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
