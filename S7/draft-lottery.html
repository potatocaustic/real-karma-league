<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S8 Draft Lottery | Real Karma League</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        :root {
            --gold: #ffb81c;
            --navy: #0c2340;
            --light-gray: #f0f0f0;
            --dark-gray: #333;
            --green: #28a745;
            --red: #dc3545;
        }

        body {
            font-family: 'Roboto', sans-serif;
            color: var(--dark-gray);
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 1rem;
        }

        .lottery-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-gray);
        }

            .lottery-header h1 {
                color: var(--navy);
                font-weight: 700;
            }

        .button-container {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .action-button {
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: var(--navy);
            color: white;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

            .action-button:hover {
                transform: translateY(-2px);
            }

            .action-button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
                transform: none;
            }

        #simulateBtn {
            background-color: #007bff;
        }

        #resetBtn {
            background-color: #6c757d;
        }

        .lottery-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 992px) {
            .lottery-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        .lottery-table-container {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

            .lottery-table-container h3 {
                color: var(--navy);
                margin-bottom: 1rem;
                text-align: center;
            }

            .lottery-table-container p {
                text-align: center;
                color: #6c757d;
                font-size: 0.9rem;
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background-color: var(--light-gray);
            font-weight: 600;
        }

        td.seed,
        td.pick {
            font-weight: 700;
            text-align: center;
        }

        .team-cell {
            display: flex;
            align-items: center;
        }

        .team-logo {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }

        .movement {
            display: flex;
            align-items: center;
            font-weight: 700;
        }

        .movement-green {
            color: var(--green);
        }

        .movement-red {
            color: var(--red);
        }

        #results-modal {
            margin-top: 2rem;
            padding: 2rem;
            background-color: #f3f4f6;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #results-form div {
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #results-form label {
            font-weight: 600;
            width: 80px;
        }

        #results-form select {
            width: 200px;
            padding: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="lottery-header">
            <h1>S8 Draft Lottery</h1>
            <p>The 14 non-playoff teams participate in a lottery to determine the top 4 picks of the S8 Draft. Remaining picks (5-14) are determined by inverse order of regular season record.</p>
            <div id="button-container" class="button-container">
                <button id="simulateBtn" class="action-button" disabled>Simulate Lottery</button>
                <button id="resetBtn" class="action-button" disabled>Reset</button>
                <div id="admin-controls" style="display: none;">
                    <button id="enterResultsBtn" class="action-button" style="background-color: #d97706;">Enter Official Results</button>
                </div>
            </div>
        </header>

        <main class="lottery-container">
            <div class="lottery-table-container">
                <h3 id="table-title">Lottery Odds</h3>
                <p id="table-description">Pre-lottery draft order and odds for the #1 pick.</p>
                <table id="lottery-odds-table"></table>
            </div>
            <div class="lottery-table-container">
                <h3>Simulated Results</h3>
                <table id="lottery-results-table">
                </table>
            </div>
        </main>

        <div id="results-modal" style="display:none;">
            <h4>Enter Official Lottery Order</h4>
            <div id="results-form"></div>
            <button id="saveResultsBtn" class="action-button">Save Results</button>
            <button id="cancelResultsBtn" class="action-button" style="background-color: #6b7280;">Cancel</button>
        </div>
    </div>

    <script>
        // --- State Variables ---
        let initialLotteryTeams = [];
        let officialResults = [];
        const lotteryOdds = [
            { top4: 47.9, num1: 14.0, num2: 13.4, num3: 12.7, num4: 11.9 },
            { top4: 47.9, num1: 14.0, num2: 13.4, num3: 12.7, num4: 11.9 },
            { top4: 47.9, num1: 14.0, num2: 13.4, num3: 12.7, num4: 11.9 },
            { top4: 40.7, num1: 12.5, num2: 12.2, num3: 11.9, num4: 11.5 },
            { top4: 31.6, num1: 10.5, num2: 10.5, num3: 10.6, num4: 0 },
            { top4: 25.4, num1: 9.0, num2: 9.2, num3: 9.4, num4: 0 },
            { top4: 19.0, num1: 7.5, num2: 7.8, num3: 8.1, num4: 0 },
            { top4: 13.9, num1: 6.0, num2: 6.3, num3: 6.7, num4: 0 },
            { top4: 9.4, num1: 4.5, num2: 4.8, num3: 5.2, num4: 0 },
            { top4: 6.1, num1: 3.0, num2: 3.3, num3: 3.6, num4: 0 },
            { top4: 4.0, num1: 2.0, num2: 2.2, num3: 2.4, num4: 0 },
            { top4: 2.9, num1: 1.5, num2: 1.7, num3: 1.8, num4: 0 },
            { top4: 1.8, num1: 1.0, num2: 1.1, num3: 1.2, num4: 0 },
            { top4: 0.9, num1: 0.5, num2: 0.5, num3: 0.6, num4: 0 },
        ];

        // --- Core Functions ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true') {
                document.getElementById('admin-controls').style.display = 'block';
            }

            // Load initial teams from lottery-specific sheet
            const lotterySheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR62qB5f_4-O2j3v4H3gVqG2iZKE6s2Y-wG-1222L_Ngn-w9w9iY_x0a-Coqj3a2s_O4G4P3d3z8Q8/pub?gid=1943825832&single=true&output=csv';
            const lotteryTeamsData = await fetch(lotterySheetUrl).then(res => res.text()).then(parseCSV);

            initialLotteryTeams = lotteryTeamsData.map((team, index) => ({
                ...team,
                seed: index + 1,
                ...lotteryOdds[index]
            }));

            const savedResults = localStorage.getItem('rkl_s8_lottery_results');
            if (savedResults) {
                officialResults = JSON.parse(savedResults);
                const finalOrder = officialResults.map(res => {
                    const team = initialLotteryTeams.find(t => t.team_id === res.team_id);
                    return { ...team, pick: res.pick };
                });

                document.getElementById('table-title').textContent = 'Official S8 Draft Lottery Results';
                document.getElementById('table-description').textContent = 'The simulation is now closed and results are final.';
                renderSimulatedResults(finalOrder);
                document.getElementById('button-container').innerHTML = '<p style="font-weight: 600;">Official Results Locked</p>';
                return; // Stop further execution
            }

            // Fetch main league data to adjust for play-in tournament
            const mainSheetUrl = 'https://docs.google.com/spreadsheets/d/12EembQnztbdKx2-buv00--VDkEFSTuSXTRdOnTnRxq4/gviz/tq?tqx=out:csv&sheet=';
            try {
                const [postScheduleData, mainTeamsData] = await Promise.all([
                    fetch(`${mainSheetUrl}Post_Schedule`).then(res => res.text()).then(parseCSV),
                    fetch(`${mainSheetUrl}Teams`).then(res => res.text()).then(parseCSV)
                ]);

                if (postScheduleData && mainTeamsData) {
                    adjustLotteryTeamsForPlayIn(initialLotteryTeams, postScheduleData, mainTeamsData);
                }
            } catch (error) {
                console.error("Could not load main league data for play-in adjustments. Using initial lottery list.", error);
            }

            renderLotteryOddsTable();
            document.getElementById('simulateBtn').disabled = false;
            setupButtonListeners();
        }

        function setupButtonListeners() {
            document.getElementById('simulateBtn').addEventListener('click', runSimulation);
            document.getElementById('resetBtn').addEventListener('click', resetSimulation);

            const enterResultsBtn = document.getElementById('enterResultsBtn');
            if (enterResultsBtn) {
                enterResultsBtn.addEventListener('click', showResultsEntryForm);
            }
            const saveResultsBtn = document.getElementById('saveResultsBtn');
            if (saveResultsBtn) {
                saveResultsBtn.addEventListener('click', saveOfficialResults);
            }
            const cancelResultsBtn = document.getElementById('cancelResultsBtn');
            if (cancelResultsBtn) {
                cancelResultsBtn.addEventListener('click', () => {
                    document.getElementById('results-modal').style.display = 'none';
                });
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, header, i) => {
                    obj[header] = values[i] ? values[i].trim() : '';
                    return obj;
                }, {});
            });
        }

        function getTeamName(teamId) {
            const team = initialLotteryTeams.find(t => t.team_id === teamId);
            return team ? team.team_name : 'Unknown';
        }

        function adjustLotteryTeamsForPlayIn(lotteryTeams, postSchedule, allTeams) {
            const playInGames = postSchedule.filter(g => g.week === 'Play-In' && g.completed === 'TRUE');
            if (playInGames.length === 0) return; // No play-in games completed yet

            const playoffTeams = new Set();
            const lotteryBoundTeams = new Set();

            const findGameResult = (seriesId) => {
                const game = playInGames.find(g => g.series_id === seriesId);
                if (!game || !game.winner) return { winner: null, loser: null };
                const loser = game.winner === game.team1_id ? game.team2_id : game.team1_id;
                return { winner: game.winner, loser: loser };
            };

            // Identify teams moving to playoffs from play-in
            playoffTeams.add(findGameResult('E-PI-7v8').winner);
            playoffTeams.add(findGameResult('W-PI-7v8').winner);
            playoffTeams.add(findGameResult('E-PI-L78vW910').winner);
            playoffTeams.add(findGameResult('W-PI-L78vW910').winner);

            // Identify teams falling into lottery from play-in
            lotteryBoundTeams.add(findGameResult('E-PI-9v10').loser);
            lotteryBoundTeams.add(findGameResult('W-PI-9v10').loser);
            lotteryBoundTeams.add(findGameResult('E-PI-L78vW910').loser);
            lotteryBoundTeams.add(findGameResult('W-PI-L78vW910').loser);

            let currentLotteryTeamIds = new Set(lotteryTeams.map(t => t.team_id));

            // Remove teams that made the playoffs
            playoffTeams.forEach(teamId => {
                if (teamId) currentLotteryTeamIds.delete(teamId);
            });

            // Add teams that dropped into the lottery
            lotteryBoundTeams.forEach(teamId => {
                if (teamId) currentLotteryTeamIds.add(teamId);
            });

            // Rebuild the initialLotteryTeams array
            const finalTeamData = Array.from(currentLotteryTeamIds)
                .map(id => allTeams.find(t => t.team_id === id))
                .filter(Boolean); // Ensure no undefined teams

            // Re-sort and assign new seeds and odds
            finalTeamData.sort((a, b) => {
                const winPctA = (parseInt(a.wins) || 0) / ((parseInt(a.wins) || 0) + (parseInt(a.losses) || 0));
                const winPctB = (parseInt(b.wins) || 0) / ((parseInt(b.wins) || 0) + (parseInt(b.losses) || 0));
                if (winPctA !== winPctB) return winPctA - winPctB;
                return (parseFloat(a.pam) || 0) - (parseFloat(b.pam) || 0);
            }).forEach((team, index) => {
                const newTeamData = {
                    ...team,
                    seed: index + 1,
                    ...lotteryOdds[index]
                };
                // Replace or update the team in the original array
                const existingIndex = lotteryTeams.findIndex(t => t.team_id === team.team_id);
                if (existingIndex !== -1) {
                    lotteryTeams[existingIndex] = newTeamData;
                } else {
                    lotteryTeams.push(newTeamData);
                }
            });

            // Trim the lottery teams array to 14, just in case
            initialLotteryTeams.length = 14;
            initialLotteryTeams.sort((a, b) => a.seed - b.seed);
        }

        // --- Rendering Functions ---
        function renderLotteryOddsTable() {
            const table = document.getElementById('lottery-odds-table');
            let tableHtml = `<thead><tr><th>Seed</th><th>Team</th><th>#1 Pick</th><th>Top 4</th></tr></thead><tbody>`;
            initialLotteryTeams.forEach(team => {
                tableHtml += `
                        <tr>
                            <td class="seed">${team.seed}</td>
                            <td class="team-cell">
                                <img src="${team.logo_url}" alt="${team.team_name}" class="team-logo">
                                ${team.team_name}
                            </td>
                            <td>${team.num1}%</td>
                            <td>${team.top4}%</td>
                        </tr>
                    `;
            });
            table.innerHTML = tableHtml + '</tbody>';
        }

        function renderSimulatedResults(finalOrder) {
            const table = document.getElementById('lottery-results-table');
            let tableHtml = `<thead><tr><th>Pick</th><th>Team</th><th>Original Seed</th><th>Movement</th></tr></thead><tbody>`;
            finalOrder.forEach((team, index) => {
                const pick = team.pick || (index + 1);
                const movement = team.seed - pick;
                let movementHtml = '';
                if (movement > 0) {
                    movementHtml = `<span class="movement-green">▲ ${movement}</span>`;
                } else if (movement < 0) {
                    movementHtml = `<span class="movement-red">▼ ${Math.abs(movement)}</span>`;
                } else {
                    movementHtml = `<span>–</span>`;
                }
                tableHtml += `
                        <tr>
                            <td class="pick">${pick}</td>
                            <td class="team-cell">
                                <img src="${team.logo_url}" alt="${team.team_name}" class="team-logo">
                                ${team.team_name}
                            </td>
                            <td style="text-align: center;">${team.seed}</td>
                            <td class="movement">${movementHtml}</td>
                        </tr>
                    `;
            });
            table.innerHTML = tableHtml + '</tbody>';
        }

        // --- Simulation Logic ---
        function runSimulation() {
            const teams = [...initialLotteryTeams];
            const lotteryPicks = [];

            // Determine top 4 picks
            const combos = Array(1001).fill(null).map((_, i) => i + 1);
            const teamAssignments = [];
            let currentCombo = 0;
            const oddsMap = [140, 140, 140, 125, 105, 90, 75, 60, 45, 30, 20, 15, 10, 5];

            teams.slice(0, 14).forEach((team, i) => {
                for (let j = 0; j < oddsMap[i]; j++) {
                    teamAssignments.push(team.team_id);
                }
            });

            while (lotteryPicks.length < 4) {
                const winningComboIndex = Math.floor(Math.random() * teamAssignments.length);
                const winningTeamId = teamAssignments[winningComboIndex];

                if (!lotteryPicks.find(p => p.team_id === winningTeamId)) {
                    const winningTeam = teams.find(t => t.team_id === winningTeamId);
                    lotteryPicks.push(winningTeam);
                }
            }

            // Fill remaining picks
            const remainingTeams = teams.filter(t => !lotteryPicks.includes(t));
            remainingTeams.sort((a, b) => a.seed - b.seed); // Sort by original seed

            const finalOrder = [...lotteryPicks, ...remainingTeams].map((team, index) => ({
                ...team,
                pick: index + 1
            }));

            renderSimulatedResults(finalOrder);
            document.getElementById('simulateBtn').disabled = true;
            document.getElementById('resetBtn').disabled = false;
        }

        function resetSimulation() {
            document.getElementById('lottery-results-table').innerHTML = '';
            document.getElementById('simulateBtn').disabled = false;
            document.getElementById('resetBtn').disabled = true;
        }

        // --- Admin Functions for Official Results ---
        function showResultsEntryForm() {
            const formContainer = document.getElementById('results-form');
            let formHTML = '';
            const options = initialLotteryTeams.map(team => `<option value="${team.team_id}">${team.team_name}</option>`).join('');

            for (let i = 1; i <= 14; i++) {
                formHTML += `
                        <div>
                            <label for="pick-${i}">Pick ${i}:</label>
                            <select id="pick-${i}">${options}</select>
                        </div>`;
            }
            formContainer.innerHTML = formHTML;
            document.getElementById('results-modal').style.display = 'block';
        }

        function saveOfficialResults() {
            const results = [];
            const selectedTeams = new Set();
            for (let i = 1; i <= 14; i++) {
                const select = document.getElementById(`pick-${i}`);
                const teamId = select.value;
                if (selectedTeams.has(teamId)) {
                    alert(`Error: Team "${getTeamName(teamId)}" has been selected more than once.`);
                    return;
                }
                selectedTeams.add(teamId);
                results.push({ pick: i, team_id: teamId });
            }

            if (confirm('Are you sure you want to save these results? This will permanently lock the lottery simulation page.')) {
                localStorage.setItem('rkl_s8_lottery_results', JSON.stringify(results));
                window.location.reload();
            }
        }

    </script>
</body>

</html>