<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">RKL Season 7 Team</title> 
    <link rel="stylesheet" href="../css/global-styles.css" />
    <link rel="icon" href="../rklfavicon.ico" type="image/x-icon" />
    <script>
      // Apply theme from local storage before page loads to prevent flashing
      (function() {
        const theme = localStorage.getItem('theme');
        if (theme === 'dark') {
          document.documentElement.classList.add('dark-mode');
        }
      })();
    </script>
    
    <style id="team-icon-styles"></style>

    <style>
      /* Page-specific styles for team.html (styles are unchanged) */
      .team-header-content {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: center;
        transition: background-color 0.3s, box-shadow 0.3s;
      }

      .team-main-info {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .team-logo-large {
        width: 120px;
        height: 120px;
        border-radius: 50% !important;
        border: 3px solid #ddd;
        object-fit: cover;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        transition: border-color 0.3s;
      }

      .team-details h2 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      .team-subtitle {
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 0.5rem;
        transition: color 0.3s;
      }

      .gm-info {
        font-size: 1.1rem;
        color: #007bff;
        font-weight: 500;
        transition: color 0.3s;
      }

      .team-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
      }

      .stat-card {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #ddd;
        transition: background-color 0.3s, border-color 0.3s;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #333;
        transition: color 0.3s;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.5rem;
        transition: color 0.3s;
      }
      
      .stat-rank {
        font-size: 0.8rem;
        color: #007bff;
        margin-top: 0.3rem;
        font-weight: 500;
        transition: color 0.3s;
      }
      
      .positive { color: #28a745; }
      .negative { color: #dc3545; }

      .stat-card-link {
          text-decoration: none;
          color: inherit;
          display: block; 
          border-radius: 6px; 
      }

      .stat-card-link .stat-card {
          transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
      }

      .stat-card-link:hover .stat-card {
          transform: translateY(-4px);
          box-shadow: 0 8px 16px rgba(0,0,0,0.12);
      }

      .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
        align-items: start;
      }

      .roster-section {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        height: fit-content;
        transition: background-color 0.3s, box-shadow 0.3s;
      }

      .section-header {
        background-color: #333;
        color: white;
        padding: 1.5rem;
        text-align: center;
      }

      .section-header h3 {
        color: white;
        margin: 0;
        font-size: 1.4rem;
      }

      .roster-list { padding: 0; }

      .roster-header {
        display: grid;
        grid-template-columns: 40px 1fr 80px 80px; 
        gap: 0.5rem; 
        align-items: center;
        padding: 1rem 1rem;
        background-color: #f8f9fa;
        border-bottom: 2px solid #ddd;
        font-weight: bold;
        font-size: 0.9rem;
        color: #666;
        transition: background-color 0.3s, border-color 0.3s, color 0.3s;
      }
      .roster-logo-header-col { /* For spacing */ }
      .roster-header .header-player { text-align: left; padding-left: 0; }
      .roster-header .header-rel, .roster-header .header-war { text-align: center; padding-right: 0; }
      .roster-header .sortable { cursor: pointer; transition: color 0.2s; }
      .roster-header .sortable:hover { color: #007bff; }
      .roster-header .sort-indicator { display: inline-block; margin-left: 5px; width: 1em; }

      .roster-content { padding: 0; }

      .player-item {
        display: grid;
        grid-template-columns: 40px 1fr 80px 80px; 
        gap: 0.5rem; 
        align-items: center;
        padding: 1rem 1rem;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s, border-color 0.3s;
      }
      .roster-player-logo-col {
        display: flex; align-items: center; justify-content: center;
      }
      
      .player-item:hover { background-color: #f8f9fa; }
      .player-item:last-child { border-bottom: none; }
      .player-info { display: flex; flex-direction: column; min-width: 0; padding-left: 0; }
      .player-rel, .player-war { font-weight: bold; font-size: 1.1rem; color: #333; text-align: center; min-width: 80px; padding-right: 0; transition: color 0.3s;}
      .player-name { font-weight: 500; font-size: 1.1rem; color: #007bff; text-decoration: none; cursor: pointer; transition: color 0.3s ease; }
      .player-name:hover { color: #0056b3; text-decoration: underline; }
      .all-star-badge { color: gold; text-shadow: 0 0 2px #a18000; font-size: 1em; margin-left: 5px; vertical-align: middle; }
      .rookie-badge { background-color: #6c757d; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; vertical-align: middle; }
      .player-stats { font-size: 0.9rem; color: #666; margin-top: 0.2rem; transition: color 0.3s;}

      .schedule-section {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        height: fit-content;
        min-height: 600px;
        transition: background-color 0.3s, box-shadow 0.3s;
      }

      .games-list { padding: 1.5rem; max-height: none; overflow-y: visible; }
      .game-item { display: flex; gap: 0; padding: 0; border-bottom: 1px solid #eee; transition: background-color 0.2s; margin-left: 0; position: relative; min-height: 70px; background-color: #fff; border-radius: 4px; margin-bottom: 0.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); transition: all 0.3s; }
      .game-item:hover { background-color: #f8f9fa; }
      .game-item:last-child { border-bottom: none; }
      .game-info-table { display: grid; grid-template-rows: 1fr 1fr; width: 45px; min-width: 45px; max-width: 45px; flex-shrink: 0; border-right: 1px solid #ddd; background-color: #f8f9fa; transition: background-color 0.3s, border-color 0.3s; }
      .week-cell { display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #ddd; padding: 0.5rem; transition: border-color 0.3s;}
      .date-cell { display: flex; align-items: center; justify-content: center; padding: 0.5rem; }
      .game-content-table { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 1rem; flex: 1; background-color: #fff; gap: 1rem; transition: background-color 0.3s; }
      .team-section { display: flex; align-items: center; gap: 0.75rem; min-width: 0; }
      .team-section.left { justify-content: flex-start; }
      .team-section.right { justify-content: flex-end; flex-direction: row-reverse; }
      .team-details { display: flex; flex-direction: column; min-width: 0; flex: 1; }
      .team-details.right { text-align: right; }
      .scores-section { display: flex; align-items: center; gap: 0.75rem; font-weight: bold; font-size: 1.1rem; white-space: nowrap; min-width: 120px; justify-content: center; }
      .score { min-width: 40px; text-align: center; }
      .vs-text { color: #666; font-weight: 500; font-size: 1rem; transition: color 0.3s; }
      .team-name-game { font-weight: 500; font-size: 0.95rem; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .team-record-game { font-size: 0.8rem; color: #666; line-height: 1; margin-top: 0.2rem; white-space: nowrap; transition: color 0.3s; }
      .win { color: #28a745; }
      .loss { color: #333; } 
      .upcoming { color: #333; font-weight: 500; }
      .team-matchup, .team, .team-info, .vs { display: none; }
      .game-matchup .week-badge { display: none; }
      .week-badge { background-color: #007bff; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; border: 1px solid white; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
      .date-badge { font-size: 0.65rem; color: #666; font-weight: 500; transition: color 0.3s; }

      .draft-capital { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; margin-top: 2rem; transition: background-color 0.3s, box-shadow 0.3s; }
      .picks-list { padding: 1.5rem; max-height: 400px; overflow-y: auto; }
      .pick-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; border-bottom: 1px solid #eee; font-family: monospace; font-size: 0.9rem; transition: border-color 0.3s; }
      .pick-item:last-child { border-bottom: none; }
      .pick-description { font-weight: 500; }
      .pick-origin { color: #666; font-size: 0.8rem; transition: color 0.3s; }
      .pick-origin a { color: #007bff; text-decoration: none; transition: color 0.3s;}
      .pick-origin a:hover { text-decoration: underline; }
      .pick-origin .pick-origin-stats { color: inherit; }
      .pick-origin-stats { font-size: 0.75rem; color: #007bff; margin-left: 0.5rem; }
      .game-item[onclick] { cursor: pointer; transition: all 0.3s ease; }
      .game-item[onclick]:hover { background-color: #e8f5e8 !important; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
      
      .draft-summary {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 6px;
        margin-bottom: 1.5rem;
        border: 1px solid #ddd;
        transition: background-color 0.3s, border-color 0.3s;
      }
      .draft-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        text-align: center;
      }
      .draft-summary-value {
        font-size: 1.5rem;
        font-weight: bold;
        transition: color 0.3s;
      }
      .draft-summary-label {
        font-size: 0.9rem;
        color: #666;
        transition: color 0.3s;
      }
      .draft-summary-value.total { color: #333; }
      .draft-summary-value.own { color: #28a745; }
      .draft-summary-value.acquired { color: #007bff; }
      .draft-summary-value.forfeiture { color: #dc3545; }

      .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto; }
      .modal-content { background-color: #fff; margin: 2rem auto; border-radius: 8px; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3); transition: background-color 0.3s;}
      .modal-header { background-color: #333; color: white; padding: 1.5rem; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
      .modal-header h3 { color: white; margin: 0; font-size: 1.4rem; }
      .close-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 4px; transition: background-color 0.3s; }
      .close-btn:hover { background-color: rgba(255,255,255,0.1); }
      .modal-body { padding: 2rem; }
      .game-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
      .team-breakdown { background-color: #f8f9fa; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; transition: background-color 0.3s, border-color 0.3s; }
      .team-breakdown.winner { border-color: #28a745; border-width: 2px; }
      .modal-team-header { background-color: #333; color: white; padding: 1.5rem; text-align: center; display: flex; align-items: center; justify-content: center; gap: 1rem; flex-direction: column; transition: background-color 0.3s;}
      .modal-team-header.winner { background-color: #28a745; }
      .team-total { background-color: #e9ecef; padding: 1rem; text-align: center; font-weight: bold; font-size: 1.1rem; border-bottom: 2px solid #ddd; transition: background-color 0.3s, border-color 0.3s;}
      .lineup-table { width: 100%; border-collapse: collapse; }
      .lineup-table th { background-color: #f8f9fa; padding: 0.8rem 0.5rem; text-align: center; font-weight: bold; border-bottom: 2px solid #ddd; font-size: 0.9rem; transition: background-color 0.3s, border-color 0.3s;}
      .lineup-table td { padding: 0.8rem 0.5rem; border-bottom: 1px solid #eee; font-size: 0.9rem; text-align: center; transition: border-color 0.3s;}
      .lineup-table th:first-child, .lineup-table td:first-child { text-align: left; }
      .captain-row { background-color: #fff3cd !important; font-weight: bold; }
      .captain-badge { background-color: #ffc107; color: #333; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: bold; margin-left: 0.5rem; }
      .captain-bonus { font-size: 0.75rem; color: #ffc107; font-weight: 500; margin-top: 0.2rem; }
      .player-name-cell { font-weight: 500; }
      .player-link { color: #007bff; text-decoration: none; font-weight: 500; transition: color 0.3s ease; }
      .player-link:hover { color: #0056b3; text-decoration: underline; }
      .points-cell { text-align: center; font-weight: bold; }
      .rank-cell { text-align: center; color: #666; transition: color 0.3s;} 

      /* Creates a flex container for the new logo and the text block */
      .pick-main-info {
        display: flex;
        align-items: center;
        gap: 0.75rem; /* Space between logo and text */
        flex: 1;
        min-width: 0;
      }

      /* Styles the original owner's team logo */
      .pick-team-logo {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        flex-shrink: 0;
      }

      /* A wrapper for the pick description and origin text */
      .pick-text-content {
        min-width: 0;
      }

      /* This makes the sub-label text lighter in dark mode for better visibility */
      .dark-mode .pick-origin {
        color: #bbb;
      }
      .dark-mode .pick-origin a {
        color: #8ab4f8; /* Ensures links within the origin text are still blue */
      }

      /* This handles the new layout on mobile devices */
      @media (max-width: 768px) {
        .pick-main-info {
          justify-content: center;
        }
        .pick-text-content {
          text-align: center;
        }
      }

      .pick-item-enhanced { transition: background-color 0.2s ease; display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; border-bottom: 1px solid #eee; transition: background-color 0.3s, border-color 0.3s; }
      .pick-item-enhanced > div:first-child { text-align: left; }
      .pick-item-enhanced:hover { background-color: #f8f9fa !important; }
      .pick-item-enhanced:last-child { border-bottom: none; }
      .pick-status { font-size: 0.8rem; color: #666; transition: color 0.3s; }
      .season-group { box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 6px; overflow: hidden; }
      .season-header { font-size: 1.1rem; text-transform: uppercase; letter-spacing: 0.5px; }
      .draft-capital .season-group .season-header .season-pick-count-badge { font-size: 0.9rem; white-space: nowrap; flex-shrink: 0; }
      .back-button { background-color: #007bff; color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 4px; text-decoration: none; font-size: 1rem; display: inline-block; margin-bottom: 2rem; transition: background-color 0.3s;}
      .back-button:hover { background-color: #0056b3; text-decoration: none; color: white; }
      .desktop-only-roster-logo { width: 30px; height: 30px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }

      /* Dark Mode Styles (styles are unchanged) */
      .dark-mode .back-button { background-color: #3b82f6; }
      .dark-mode .back-button:hover { background-color: #60a5fa; }
      .dark-mode .team-header-content, .dark-mode .roster-section, .dark-mode .schedule-section, .dark-mode .draft-capital { background-color: #1e1e1e; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
      .dark-mode .team-logo-large { border-color: #444; }
      .dark-mode .team-subtitle, .dark-mode .stat-label, .dark-mode .player-stats, .dark-mode .team-record-game, .dark-mode .vs-text, .dark-mode .date-badge, .dark-mode .pick-origin, .dark-mode .pick-status, .dark-mode .draft-summary-label { color: #aaa; }
      .dark-mode .gm-info, .dark-mode .stat-rank, .dark-mode .player-name, .dark-mode .pick-origin a { color: #8ab4f8; }
      .dark-mode .stat-card { background-color: #2c2c2c; border-color: #444; }
      .dark-mode .stat-value, .dark-mode .player-rel, .dark-mode .player-war { color: #e0e0e0; }
      .dark-mode .positive { color: #66bb6a; }
      .dark-mode .negative { color: #ef5350; }
      .dark-mode .roster-header { background-color: #2c2c2c; border-bottom-color: #444; color: #bbb; }
      .dark-mode .player-item { border-bottom-color: #333; }
      .dark-mode .player-item:hover { background-color: #2c2c2c; }
      .dark-mode .game-item, .dark-mode .game-content-table { background-color: #1e1e1e; border-bottom-color: #333; }
      .dark-mode .game-item:hover { background-color: #2c2c2c !important; }
      .dark-mode .game-info-table { background-color: #2c2c2c; border-right-color: #444; }
      .dark-mode .week-cell { border-bottom-color: #444; }
      .dark-mode .score.loss { color: #e0e0e0; }
      .dark-mode .team-name.loss, .dark-mode .team-score.loss { color: #ef5350; }
      .dark-mode .team-name.upcoming, .dark-mode .team-score.upcoming { color: #e0e0e0; }
      .dark-mode .pick-item, .dark-mode .pick-item-enhanced { border-bottom-color: #333; }
      .dark-mode .pick-item-enhanced:hover { background-color: #2c2c2c !important; }
      .dark-mode .draft-capital .season-group .season-header { }
      .dark-mode .draft-summary {
        background-color: #2c2c2c;
        border-color: #444;
      }
      .dark-mode .draft-summary-value.total { color: #e0e0e0; }
      .dark-mode .draft-summary-value.own { color: #66bb6a; }
      .dark-mode .draft-summary-value.acquired { color: #8ab4f8; }
      .dark-mode .draft-summary-value.forfeiture { color: #ef5350; }
      .dark-mode .modal-content { background-color: #1e1e1e; }
      .dark-mode .close-btn:hover { background-color: rgba(255,255,255,0.2); }
      .dark-mode .team-breakdown { background-color: #2c2c2c; border-color: #444; }
      .dark-mode .team-breakdown.winner { border-color: #66bb6a; }
      .dark-mode .modal-team-header.winner { background-color: #2e7d32; }
      .dark-mode .team-total { background-color: #333; border-bottom-color: #444; }
      .dark-mode .lineup-table th { background-color: #2c2c2c; border-bottom-color: #444; }
      .dark-mode .lineup-table td { border-color: #333; }
      .dark-mode .lineup-table tr:hover { background-color: #383838; }
      .dark-mode .captain-row { background-color: #4a4100 !important; }
      .dark-mode .player-link { color: #8ab4f8; }
      .dark-mode .player-link:hover { color: #a7c7fa; }
      .dark-mode .rank-cell { color: #aaa; }

      /* --- NEW CSS FOR DRAFT PICK STYLING --- */
      .pick-status-own {
        color: #28a745;
        font-weight: 500;
      }
      .dark-mode .pick-status-own {
        color: #66bb6a;
      }
      .pick-item-enhanced.pick-forfeiture {
        background-color: #f8d7da;
      }
      .dark-mode .pick-item-enhanced.pick-forfeiture {
        background-color: #5d1c21;
      }

      /* Responsive Styles */
      @media (max-width: 768px) {
        .content-grid { grid-template-columns: 1fr; }
        .team-main-info { flex-direction: column; gap: 1rem; }
        .team-logo-large { width: 80px; height: 80px; }
        .team-stats-grid { grid-template-columns: repeat(2, 1fr); }
        .player-item { padding: 0.75rem; grid-template-columns: 1fr 80px !important; }
        .roster-header { grid-template-columns: 1fr 80px !important; }
        .desktop-only-roster-logo, .header-war, .player-war { display: none; } 
        
        .game-item { padding: 0.75rem; margin-left: 0; position: relative; display: block; }
        .game-item .game-matchup { display: flex !important; } 
        .game-item .game-info-table, .game-item .game-content-table { display: none !important; }
        .game-matchup .week-badge { display: flex !important; position: absolute; top: 0.75rem; right: 0.75rem; left: auto; transform: none; width: 28px; height: 28px; font-size: 0.8rem; z-index: 2; background-color: #007bff; color: white; border-radius: 50%; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .game-matchup { display: flex; flex-direction: column; gap: 0.75rem; align-items: stretch; margin-top: 0; padding-right: 35px; }
        .team { display: flex; align-items: center; gap: 0.5rem; min-width: auto; width: 100%; }
        .team-info { display: flex; flex-direction: column; min-width: 0; flex: 1; }
        .team-name { font-weight: 500; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .team-name.win { color: #28a745; } .team-name.loss { color: #dc3545; }
        .team-record { font-size: 0.8rem; color: #666; }
        .team-score { font-weight: bold; color: #333; margin-left: auto; min-width: 35px; text-align: right; flex-shrink: 0; }
        .team-score.win { color: #28a745; } .team-score.loss { color: #dc3545; } .team-score.upcoming { color: #333; }
        .vs { display: none; }
        
        .modal-content { margin: 1rem; width: calc(100% - 2rem); }
        .modal-body { padding: 1rem; }
        .modal-header h3 { font-size: 1.1rem; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; min-width: 0; }
        .game-details-grid { grid-template-columns: 1fr !important; gap: 1rem !important; }
        .pick-item-enhanced { flex-direction: column; align-items: center; gap: 0.5rem; text-align: center; }
        .pick-item-enhanced > div:first-child { text-align: center; }
        .pick-description { display: block; margin: 0 auto; }
        .pick-origin { margin-top: 0.25rem; }
        .pick-status { align-self: center; margin-top: 0.5rem; }
        .draft-capital .season-group .season-header { padding: 0.75rem 1rem; }
        .draft-capital .season-group .season-header > span:first-child { font-size: 0.9rem; margin-right: 8px; flex-grow: 1; flex-shrink: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .draft-capital .season-group .season-header .season-pick-count-badge { font-size: 0.8rem; padding: 0.2rem 0.5rem; }
      }

      @media (max-width: 480px) {
        .team-stats-grid { grid-template-columns: 1fr; }
        .player-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
        .player-rel { align-self: flex-end; }
        .modal-header h3 { font-size: 1.0rem; }
      }
    </style>
  </head>
  <body>
    <header>
      <button id="theme-toggle-btn" aria-label="Toggle Theme">
        <span class="sun-icon">☀️</span>
        <span class="moon-icon">🌙</span>
      </button>
      <h1>
        <img src="icons/RKL.webp" alt="RKL Logo" class="header-logo" onerror="this.style.display='none'">
        <span class="header-text">Real Karma League</span>
      </h1>
      <nav>
        <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">&#9776;</button>
        <ul id="nav-menu">
            <li><a href="RKL-S7.html">S7 Home</a></li>
            <li><a href="standings.html">Standings & Rankings</a></li>
            <li class="dropdown">
                <a href="javascript:void(0);" class="dropbtn">Stats Hub &#9662;</a>
                <div class="dropdown-content">
                    <a href="leaderboards.html">Leaderboards</a>
                    <a href="compare.html">Comparison Tool</a>
                </div>
            </li>
            <li><a href="schedule.html">Schedule</a></li>
            <li class="dropdown">
                <a href="javascript:void(0);" class="dropbtn">Draft Central &#9662;</a>
                <div class="dropdown-content">
                    <a href="draft-capital.html">Draft Capital</a>
                    <a href="draft-results.html">Draft Results</a>
                    <a href="draft-lottery.html">Draft Lottery</a>
                </div>
            </li>
            <li><a href="transactions.html">Transactions</a></li>
            <li><a href="teams.html">Teams</a></li>
            <li><a href="changelog.html">Changelog</a></li>
        </ul>
       </nav>
    </header>
    
    <main>
      <a href="teams.html" class="back-button">← Back to All Teams</a>
      
      <div class="team-header-content"> 
        <div class="team-main-info" id="team-main-info">
          <div class="loading">Loading team information...</div>
        </div>
        
        <div class="team-stats-grid" id="team-stats" style="display: none;">
        </div>
      </div>

      <div class="content-grid">
        <div class="roster-section">
          <div class="section-header">
            <h3>Current Roster</h3>
          </div>
          <div class="roster-list" id="roster-list">
            <div class="loading">Loading roster...</div>
          </div>
        </div>

        <div class="schedule-section">
          <div class="section-header">
            <h3>Schedule</h3>
          </div>
          <div class="games-list" id="team-schedule">
            <div class="loading">Loading schedule...</div>
          </div>
        </div>
      </div>

      <div class="draft-capital">
        <div class="section-header">
          <h3>Draft Capital</h3>
        </div>
        <div class="picks-list" id="draft-picks">
          <div class="loading">Loading draft picks...</div>
        </div>
      </div>
    </main>

    <div id="game-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modal-title">Game Details</h3>
          <button class="close-btn" onclick="closeGameModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div id="modal-content">
            <div class="loading">Loading game details...</div>
          </div>
        </div>
      </div>
    </div>
    
    <footer>
      <p>@caustic on Real</p>
      <a href="trade-block.html">GM Portal</a>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script src="../js/firebase-init.js" defer></script>
    <script src="../js/main.js" defer></script>

    <script>
      // This entire script is now wrapped in a DOMContentLoaded listener to prevent race conditions.
      document.addEventListener('DOMContentLoaded', () => {
        let teamId = null;
        let teamData = null;
        let allTeams = [];
        let allScheduleData = [];
        let allWeeklyAverages = []; 
        let allTransactionsLogData = []; 
        let allLineups = []; 
        let allDraftPicks = []; 
        let processedPlayersData = [];
        let rosterSortState = { column: 'rel', direction: 'desc' };
        
        // --- NEW HELPER FUNCTION ---
        function generateIconStylesheet(allTeams) {
            const iconStyles = allTeams.map(team => {
                if (!team.team_id) return '';
                const className = `icon-${team.team_id.replace(/[^a-zA-Z0-9]/g, '')}`; 
                return `
                    .${className} {
                        background-image: url('icons/${team.team_id}.webp');
                    }
                `;
            }).join('');

            const styleElement = document.getElementById('team-icon-styles');
            if (styleElement) {
                styleElement.innerHTML = `
                    .team-logo-css {
                        width: 24px;
                        height: 24px;
                        background-size: cover;
                        background-position: center;
                        background-repeat: no-repeat;
                        display: inline-block;
                        vertical-align: middle;
                        flex-shrink: 0;
                        border-radius: 4px;
                    }
                    ${iconStyles}
                `;
            }
        }

        // --- Helper Functions (Full code included) ---
        function normalizeDate(dateInput) {
            if (!dateInput) return '';
            let date;
            if (typeof dateInput.toDate === 'function') {
                date = dateInput.toDate();
            } 
            else {
                let dateString = String(dateInput);
                if (dateString.includes('T')) {
                    date = new Date(dateString);
                } else if (dateString.includes('-')) {
                    date = new Date(dateString + 'T00:00:00Z');
                } else if (dateString.includes('/')) {
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        date = new Date(Date.UTC(parts[2], parts[0] - 1, parts[1]));
                    } else {
                        return '';
                    }
                } else {
                     date = new Date(dateString);
                }
            }
            if (isNaN(date.getTime())) return '';
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function formatInThousands(value) {
          const num = parseFloat(value);
          if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'k';
          }
          return Math.round(num).toLocaleString();
        }

        function formatDateMMDD(dateString) {
          const date = new Date(dateString + 'T00:00:00Z');
          const month = String(date.getUTCMonth() + 1).padStart(2, '0');
          const day = String(date.getUTCDate()).padStart(2, '0');
          return `${month}-${day}`;
        }

        function formatDateShort(dateString) {
          const date = new Date(dateString + 'T00:00:00Z');
          const month = String(date.getUTCMonth() + 1).padStart(2, '0');
          const day = String(date.getUTCDate()).padStart(2, '0');
          const year = String(date.getUTCFullYear()).slice(-2);
          return `${month}/${day}/${year}`;
        }
        
        function parseNumber(value) {
          if (value === null || typeof value === 'undefined' || String(value).trim() === '') return 0;
          const cleaned = value.toString().replace(/,/g, '');
          const parsed = parseFloat(cleaned);
          return isNaN(parsed) ? 0 : parsed;
        }

        function escapeHTML(str) {
          if (typeof str !== 'string') return str; 
          return str.replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
        }
        
        function getUrlParameter(name) {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get(name);
        }
        
        function getTeamName(teamIdToFind) { 
          const team = allTeams.find(t => t.team_id === teamIdToFind);
          return team ? team.team_name : teamIdToFind;
        }
        
        function getTeamRecordAtDate(teamIdForRecord, targetDate, schedule) { 
          const normalizedTargetDate = normalizeDate(targetDate);
          const completedGames = schedule.filter(game => {
            const normalizedGameDate = normalizeDate(game.date);
            return normalizedGameDate && normalizedGameDate <= normalizedTargetDate && 
                  game.completed === 'TRUE' && 
                  (game.team1_id === teamIdForRecord || game.team2_id === teamIdForRecord);
          });
          
          let wins = 0;
          let losses = 0;
          
          completedGames.forEach(game => {
            const winner = game.winner;
            if (winner === teamIdForRecord) {
              wins++;
            } else if (winner && (game.team1_id === teamIdForRecord || game.team2_id === teamIdForRecord)) {
              losses++;
            }
          });
          
          return `${wins}-${losses}`;
        }

        function calculateStatsForAllPlayers(players, weeklyAverages, lineups) {
            if (!players || !weeklyAverages || !lineups) {
                return players || []; 
            }
            const weeklyAveragesMap = {};
            weeklyAverages.forEach(week => {
              const normalizedDate = normalizeDate(week.date);
              if (normalizedDate) {
                weeklyAveragesMap[normalizedDate] = {
                  mean_score: parseNumber(week.mean_score),
                  median_score: parseNumber(week.median_score)
                };
              }
            });

            return players.map(player => {
              const playerGames = lineups.filter(lineup => 
                lineup.player_handle === player.player_handle && 
                (String(lineup.started).toUpperCase() === 'TRUE') 
              );
              
              let gamesAboveMean = 0, gamesAboveMedian = 0, t100_finishes = 0;
              const ranks = [];

              playerGames.forEach(game => {
                const normalizedGameDate = normalizeDate(game.date);
                const playerKarmaFinalForComparisons = parseNumber(game.points_final);
                const globalRank = parseNumber(game.global_rank);
                
                if (weeklyAveragesMap[normalizedGameDate]) {
                  if (playerKarmaFinalForComparisons > weeklyAveragesMap[normalizedGameDate].mean_score) gamesAboveMean++;
                  if (playerKarmaFinalForComparisons > weeklyAveragesMap[normalizedGameDate].median_score) gamesAboveMedian++;
                }
                if (globalRank > 0) { ranks.push(globalRank); if (globalRank <= 100) t100_finishes++; }
              });
              
              let calculated_median_rank = 0;
              if (ranks.length > 0) { ranks.sort((a, b) => a - b); const mid = Math.floor(ranks.length / 2); calculated_median_rank = ranks.length % 2 === 0 ? (ranks[mid - 1] + ranks[mid]) / 2 : ranks[mid]; }
              const games_played_count = parseInt(player.games_played || 0);
              return { ...player, calculated_median_rank: calculated_median_rank > 0 ? calculated_median_rank : Infinity, aag_mean: gamesAboveMean, aag_mean_pct: games_played_count > 0 ? gamesAboveMean / games_played_count : 0, aag_median: gamesAboveMedian, aag_median_pct: games_played_count > 0 ? gamesAboveMedian / games_played_count : 0, t100_finishes, t100_finishes_pct: games_played_count > 0 ? (t100_finishes / games_played_count) : 0, total_points: parseNumber(player.total_points), games_played: games_played_count, WAR: parseFloat(player.WAR || 0) };
            });
        }

        function getOrdinal(num) {
          const n = parseInt(num);
          if (n <= 0) return 'Unranked';
          const suffix = ['th', 'st', 'nd', 'rd'];
          const v = n % 100;
          return n + (suffix[(v - 20) % 10] || suffix[v] || suffix[0]);
        }
        
        function calculateTeamRankings(currentTeamData, allTeamsDataForRanking) { 
          const rankings = {};
          const conferenceTeams = allTeamsDataForRanking.filter(t => t.conference === currentTeamData.conference)
            .sort((a, b) => {
              const winsA = parseInt(a.wins || 0);
              const winsB = parseInt(b.wins || 0);
              if (winsB !== winsA) return winsB - winsA;
              return parseFloat(b.pam || 0) - parseFloat(a.pam || 0);
            });
          rankings.record = conferenceTeams.findIndex(t => t.team_id === currentTeamData.team_id) + 1;
          
          const pamTeams = [...allTeamsDataForRanking].sort((a, b) => parseFloat(b.pam || 0) - parseFloat(a.pam || 0));
          rankings.pam = pamTeams.findIndex(t => t.team_id === currentTeamData.team_id) + 1;
          
          const medRankTeams = allTeamsDataForRanking.filter(t => parseFloat(t.med_starter_rank || 0) > 0)
            .sort((a, b) => parseFloat(a.med_starter_rank || 999) - parseFloat(b.med_starter_rank || 999));
          const medRankIndex = medRankTeams.findIndex(t => t.team_id === currentTeamData.team_id);
          rankings.medRank = medRankIndex !== -1 ? medRankIndex + 1 : 0; 
          return rankings;
        }

        function countTransactionsForTeam(teamIdToCount, transactionLog) {
          if (!transactionLog || transactionLog.length === 0) return 0;
          const relevantTransactionIds = new Set();
          transactionLog.forEach(transaction => {
              const notes = transaction.notes ? transaction.notes.toLowerCase() : '';
              if (notes.includes('pre-database') || notes.includes('preseason')) {
                  return;
              }
              let involved = false;
              if (transaction.transaction_type === 'GM_RESIGNATION' && transaction.from_team === teamIdToCount) { involved = true; }
              else if (transaction.transaction_type === 'GM_HIRED' && transaction.to_team === teamIdToCount) { involved = true; }
              else if (transaction.from_team === teamIdToCount || transaction.to_team === teamIdToCount) { involved = true; }
              if (involved && transaction.transaction_id) {
                  relevantTransactionIds.add(transaction.transaction_id);
              }
          });
          return relevantTransactionIds.size;
        }

        function handleRosterSort(column) {
          if (rosterSortState.column === column) {
              rosterSortState.direction = rosterSortState.direction === 'desc' ? 'asc' : 'desc';
          } else {
              rosterSortState.column = column;
              rosterSortState.direction = 'desc';
          }
          loadRoster();
        }
        
        function displayTeamHeader(rankings) {
          document.getElementById('page-title').textContent = `${escapeHTML(teamData.team_name)} - RKL Season 7`;
          
          const wins = parseInt(teamData.wins || 0);
          const losses = parseInt(teamData.losses || 0);
          const pam = parseFloat(teamData.pam || 0);
          const totalTransactions = teamData.calculated_total_transactions || 0;
          
          document.getElementById('team-main-info').innerHTML = `
            <div style="display: flex; align-items: center; gap: 1.5rem;">
              <img src="icons/${teamData.team_id}.webp" alt="${escapeHTML(teamData.team_name)}" class="team-logo-large" onerror="this.style.display='none'">
              <div class="team-details">
                <h2>${escapeHTML(teamData.team_name)}</h2>
                <div class="team-subtitle">${escapeHTML(teamData.team_id)} • ${escapeHTML(teamData.conference)} Conference</div>
                <div class="gm-info">General Manager: ${escapeHTML(teamData.current_gm_handle)}</div>
              </div>
            </div>
          `;
          
          const medRank = parseFloat(teamData.med_starter_rank || 0); 
          const teamStatsContainer = document.getElementById('team-stats');
          teamStatsContainer.innerHTML = ''; 

          const recordLink = document.createElement('a');
          recordLink.href = 'standings.html'; 
          recordLink.className = 'stat-card-link';
          recordLink.innerHTML = `<div class="stat-card"><div class="stat-value ${wins > losses ? 'positive' : losses > wins ? 'negative' : ''}">${wins}-${losses}</div><div class="stat-label">Record</div><div class="stat-rank">${getOrdinal(rankings.record)} in ${escapeHTML(teamData.conference)} Conference</div></div>`;
          teamStatsContainer.appendChild(recordLink);

          const pamLink = document.createElement('a');
          pamLink.href = `standings.html?view=fullLeague&sortBy=pam&sortDirection=desc`;
          pamLink.className = 'stat-card-link';
          pamLink.innerHTML = `<div class="stat-card"><div class="stat-value ${pam > 0 ? 'positive' : pam < 0 ? 'negative' : ''}">${Math.round(pam).toLocaleString()}</div><div class="stat-label">PAM</div><div class="stat-rank">${getOrdinal(rankings.pam)} Overall</div></div>`;
          teamStatsContainer.appendChild(pamLink);

          const medRankLink = document.createElement('a');
          medRankLink.href = `standings.html?view=fullLeague&sortBy=med_starter_rank&sortDirection=asc`;
          medRankLink.className = 'stat-card-link';
          medRankLink.innerHTML = `<div class="stat-card"><div class="stat-value">${Math.round(medRank)}</div><div class="stat-label">Median Starter Rank</div><div class="stat-rank">${rankings.medRank > 0 ? `${getOrdinal(rankings.medRank)} Overall` : 'Not ranked'}</div></div>`;
          teamStatsContainer.appendChild(medRankLink);

          const transactionsLink = document.createElement('a');
          transactionsLink.href = `transactions.html?teamFilter=${teamData.team_id}`;
          transactionsLink.className = 'stat-card-link';
          transactionsLink.innerHTML = `<div class="stat-card"><div class="stat-value">${totalTransactions}</div><div class="stat-label">Transactions</div>${(totalTransactions) > 0 ? `<div class="stat-rank">&nbsp;</div>` : '<div class="stat-rank" style="height:1em;">&nbsp;</div>'}</div>`;
          teamStatsContainer.appendChild(transactionsLink);
          
          teamStatsContainer.style.display = 'grid';
        }
        
        async function loadRoster() {
          const teamPlayers = processedPlayersData
            .filter(player => player.current_team_id === teamId && player.player_status === 'ACTIVE');
          
          if (teamPlayers.length === 0) {
            document.getElementById('roster-list').innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No active players found</div>';
            return;
          }
          
          teamPlayers.sort((a, b) => {
              let valA, valB;
              if (rosterSortState.column === 'rel') {
                  valA = parseFloat(a.REL || 0);
                  valB = parseFloat(b.REL || 0);
              } else if (rosterSortState.column === 'war') {
                  valA = parseFloat(a.WAR || 0);
                  valB = parseFloat(b.WAR || 0);
              }
              const comparison = valA < valB ? -1 : (valA > valB ? 1 : 0);
              return rosterSortState.direction === 'desc' ? -comparison : comparison;
          });
          
          const teamIdClassName = `icon-${teamData.team_id.replace(/[^a-zA-Z0-9]/g, '')}`;
          const rosterHTML = teamPlayers.map(player => {
            const relMedian = parseFloat(player.REL || 0);
            const gamesPlayed = parseInt(player.games_played || 0);
            const isAllStar = player.all_star === '1';
            const isRookie = player.rookie === '1';
            const war = parseFloat(player.WAR || 0).toFixed(2);
            
            let medianRankDisplay = '-';
            if (player.calculated_median_rank !== Infinity && player.calculated_median_rank > 0) {
                const roundedRank = Math.round(player.calculated_median_rank);
                if (roundedRank > 0) medianRankDisplay = roundedRank;
            }
            const rookieBadge = isRookie ? ` <span class="rookie-badge">R</span>` : '';
            
            return `
              <div class="player-item">
                <div class="roster-player-logo-col desktop-only-roster-logo">
                  <div class="team-logo-css ${teamIdClassName}" style="width: 24px; height: 24px;"></div>
                </div>
                <div class="player-info">
                  <a href="player.html?player=${encodeURIComponent(player.player_handle)}" class="player-name">${escapeHTML(player.player_handle)}${rookieBadge}${isAllStar ? ' <span class="all-star-badge">★</span>' : ''}</a>
                  <div class="player-stats">${gamesPlayed} games • ${medianRankDisplay} med rank</div>
                </div>
                <div class="player-rel">${relMedian.toFixed(3)}</div>
                <div class="player-war">${war}</div>
              </div>`;
          }).join('');
          
          const relSortIndicator = rosterSortState.column === 'rel' ? (rosterSortState.direction === 'desc' ? ' ▼' : ' ▲') : '';
          const warSortIndicator = rosterSortState.column === 'war' ? (rosterSortState.direction === 'desc' ? ' ▼' : ' ▲') : '';

          const finalHTML = `
            <div class="roster-header">
              <span class="roster-logo-header-col desktop-only-roster-logo"></span>
              <span class="header-player">Player</span>
              <span class="header-rel sortable" onclick="handleRosterSort('rel')">REL Median<span class="sort-indicator">${relSortIndicator}</span></span>
              <span class="header-war sortable" onclick="handleRosterSort('war')">WAR<span class="sort-indicator">${warSortIndicator}</span></span>
            </div>
            <div class="roster-content">${rosterHTML}</div>`;
          
          document.getElementById('roster-list').innerHTML = finalHTML;
        }
        
        async function loadSchedule() {
          if (!allScheduleData) {
            document.getElementById('team-schedule').innerHTML = '<div class="error">Error loading schedule data</div>';
            return;
          }
          
          const teamGames = allScheduleData
            .filter(game => game.teams_in_game && game.teams_in_game.includes(teamId))
            .sort((a, b) => new Date(normalizeDate(a.date)) - new Date(normalizeDate(b.date))); 
          
          if (teamGames.length === 0) {
            document.getElementById('team-schedule').innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No games scheduled</div>';
            return;
          }
          
          const teamIdClassName = `icon-${teamId.replace(/[^a-zA-Z0-9]/g, '')}`;
          const gamesHTML = teamGames.map(game => {
            const isTeam1 = game.team1_id === teamId;
            const opponentId = isTeam1 ? game.team2_id : game.team1_id;
            const opponentName = getTeamName(opponentId);
            const isCompleted = game.completed === 'TRUE';
            const gameWeek = game.week || 'TBD';
            const gameDateFormatted = formatDateMMDD(normalizeDate(game.date)); 
            
            let opponentRecord = '';
            if (isCompleted) { opponentRecord = getTeamRecordAtDate(opponentId, game.date, allScheduleData); }
            else {
              const previousDate = new Date(normalizeDate(game.date) + 'T00:00:00Z');
              previousDate.setUTCDate(previousDate.getUTCDate() - 1);
              opponentRecord = getTeamRecordAtDate(opponentId, previousDate, allScheduleData);
            }
            let teamRecord = '';
            if (isCompleted) { teamRecord = getTeamRecordAtDate(teamId, game.date, allScheduleData); }
            else {
              const previousDate = new Date(normalizeDate(game.date) + 'T00:00:00Z');
              previousDate.setUTCDate(previousDate.getUTCDate() - 1);
              teamRecord = getTeamRecordAtDate(teamId, previousDate, allScheduleData);
            }
            
            let clickHandler = '', teamScoreText = '', oppScoreText = '', teamScoreClass = '', oppScoreClass = '', teamWon = false, oppWon = false, logoClickHandlers = '';
            
            if (isCompleted) {
              const teamScoreValue = parseFloat(isTeam1 ? game.team1_score : game.team2_score);
              const oppScoreValue = parseFloat(isTeam1 ? game.team2_score : game.team1_score);
              teamWon = teamScoreValue > oppScoreValue;
              oppWon = oppScoreValue > teamScoreValue;
              teamScoreText = formatInThousands(teamScoreValue);
              oppScoreText = formatInThousands(oppScoreValue);
              teamScoreClass = teamWon ? 'win' : 'loss';
              oppScoreClass = oppWon ? 'win' : 'loss';
              const normalizedDateForHandler = normalizeDate(game.date);
              clickHandler = `onclick="showGameDetails('${game.team1_id}', '${game.team2_id}', '${normalizedDateForHandler}')" style="cursor: pointer;"`;
            } else {
              teamScoreText = '-'; oppScoreText = '-'; teamScoreClass = 'upcoming'; oppScoreClass = 'upcoming';
              logoClickHandlers = `onclick="window.location.href='team.html?id=${opponentId}'" style="cursor: pointer;"`;
            }

            const opponentIdClassName = `icon-${opponentId.replace(/[^a-zA-Z0-9]/g, '')}`;
            
            return `
              <div class="game-item" ${clickHandler}>
                <div class="game-info-table"><div class="week-cell"><div class="week-badge">${gameWeek}</div></div><div class="date-cell"><div class="date-badge">${gameDateFormatted}</div></div></div>
                <div class="game-content-table">
                  <div class="team-section left">
                    <div class="team-logo-css ${teamIdClassName}" style="width: 32px; height: 32px; border-radius: 50%;"></div>
                    <div class="team-details"><div class="team-name-game">${escapeHTML(teamData.team_name)}</div><div class="team-record-game">${teamRecord}</div></div>
                  </div>
                  <div class="scores-section"><div class="score ${teamScoreClass}">${teamScoreText}</div><div class="vs-text">vs</div><div class="score ${oppScoreClass}">${oppScoreText}</div></div>
                  <div class="team-section right">
                    <div class="team-logo-css ${opponentIdClassName}" style="width: 32px; height: 32px; border-radius: 50%;" ${logoClickHandlers}></div>
                    <div class="team-details right"><div class="team-name-game">${escapeHTML(opponentName)}</div><div class="team-record-game">${opponentRecord}</div></div>
                  </div>
                </div>
                <div class="game-matchup"> 
                  <div class="week-badge">${gameWeek}</div> 
                  <div class="team ${teamWon ? 'winner' : oppWon ? 'loser' : 'upcoming'}">
                    <div class="team-logo-css ${teamIdClassName}" style="width: 32px; height: 32px;"></div>
                    <div class="team-info"><span class="team-name ${teamWon ? 'win' : oppWon ? 'loss' : 'upcoming'}">${escapeHTML(teamData.team_name)}</span><span class="team-record">${teamRecord}</span></div><span class="team-score ${teamScoreClass}">${teamScoreText}</span>
                  </div>
                  <span class="vs">vs</span>
                  <div class="team ${oppWon ? 'winner' : teamWon ? 'loser' : 'upcoming'}">
                    <div class="team-logo-css ${opponentIdClassName}" style="width: 32px; height: 32px;" ${logoClickHandlers}></div>
                    <div class="team-info"><span class="team-name ${oppWon ? 'win' : teamWon ? 'loss' : 'upcoming'}">${escapeHTML(opponentName)}</span><span class="team-record">${opponentRecord}</span></div><span class="team-score ${oppScoreClass}">${oppScoreText}</span>
                  </div>
                </div>
              </div>`;
          }).join('');
          document.getElementById('team-schedule').innerHTML = gamesHTML;
        }
        
        async function loadDraftCapital() {
            if (!allDraftPicks) {
              document.getElementById('draft-picks').innerHTML = '<div class="error">Error loading draft capital data</div>';
              return;
            }
            
            const teamPicks = allDraftPicks
              .filter(pick => pick.current_owner === teamId)
              .sort((a, b) => (parseInt(a.season || 0) - parseInt(b.season || 0)) || (parseInt(a.round || 0) - parseInt(b.round || 0)));
            
            if (teamPicks.length === 0) {
              document.getElementById('draft-picks').innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No draft picks owned</div>';
              return;
            }
            
            const picksBySeason = teamPicks.reduce((acc, pick) => {
                (acc[pick.season] = acc[pick.season] || []).push(pick);
                return acc;
            }, {});
            
            const seasonsHTML = Object.keys(picksBySeason)
              .sort((a, b) => parseInt(a) - parseInt(b))
              .map(season => {
                const picks = picksBySeason[season];
                const seasonColor = getSeasonColor(parseInt(season));
                
                const picksHTML = picks.map(pick => {
                  const isOriginalOwnerOfPick = pick.original_team === teamId;
                  const isPendingForfeiture = pick.notes && pick.notes.toUpperCase() === 'PENDING FORFEITURE';
                  
                  let originDisplayHTML = '';
                  let pickDescriptionText = escapeHTML(pick.pick_description);
                  let transactionForLink = null;
                  let originTextContent = '';

                  let containerClass = 'pick-item-enhanced';
                  let statusText = 'Acquired';

                  if (isPendingForfeiture) {
                      statusText = 'Pending Forfeiture';
                      containerClass += ' pick-forfeiture';
                  } else if (isOriginalOwnerOfPick) {
                      statusText = `<span class="pick-status-own">Own Pick</span>`;
                  }

                  if (!isOriginalOwnerOfPick && !isPendingForfeiture) { 
                    let viaTeamId = null;
                    let originalTeamForDisplayId = pick.original_team;
                    let originalTeamForDisplayName = getTeamName(originalTeamForDisplayId);
                    const relevantTransactions = allTransactionsLogData
                        .filter(t => t.draft_pick_id === pick.pick_id && t.to_team === teamId && t.transaction_type === 'TRADE')
                        .sort((a,b) => new Date(b.date) - new Date(a.date)); 
                    if (relevantTransactions.length > 0) { viaTeamId = relevantTransactions[0].from_team; transactionForLink = relevantTransactions[0]; }
                    const originalOwnerStats = allTeams.find(t => t.team_id === originalTeamForDisplayId);
                    let originalOwnerStatsStr = "";
                    if (originalOwnerStats) {
                        const pamFormatted = Math.abs(parseFloat(originalOwnerStats.pam || 0)) >= 1000 ? (parseFloat(originalOwnerStats.pam || 0) / 1000).toFixed(1) + 'k' : Math.round(parseFloat(originalOwnerStats.pam || 0)).toString();
                        originalOwnerStatsStr = ` (${parseInt(originalOwnerStats.wins || 0)}-${parseInt(originalOwnerStats.losses || 0)}, ${pamFormatted} PAM)`;
                    }
                    if (viaTeamId && viaTeamId !== originalTeamForDisplayId) { originTextContent = `via ${escapeHTML(getTeamName(viaTeamId))}; (${escapeHTML(originalTeamForDisplayName)}: ${escapeHTML(originalOwnerStatsStr)})`; }
                    else { originTextContent = `from ${escapeHTML(originalTeamForDisplayName)}${escapeHTML(originalOwnerStatsStr)}`; }
                    try {
                      if (transactionForLink && transactionForLink.date) {
                          const linkDate = new Date(transactionForLink.date).toISOString().split('T')[0];
                          const transactionsLink = `transactions.html?type=TRADE&date=${linkDate}&teamFilters=${transactionForLink.from_team},${transactionForLink.to_team}&pick_id=${encodeURIComponent(pick.pick_id || '')}`;
                          originDisplayHTML = `<div class="pick-origin"><a href="${transactionsLink}" title="View transaction">${originTextContent}</a></div>`;
                      } else { throw new Error("No valid transaction link found"); }
                    } catch (e) {
                      originDisplayHTML = `<div class="pick-origin">${originTextContent}</div>`;
                    }
                  } else if (isOriginalOwnerOfPick) { 
                      originDisplayHTML = `<div class="pick-origin">Original Pick</div>`;
                  }
                  
                  const originalTeamIdClassName = `icon-${pick.original_team.replace(/[^a-zA-Z0-9]/g, '')}`;
                  return `
                    <div class="${containerClass}">
                      <div class="pick-main-info">
                        <a href="team.html?id=${pick.original_team}">
                          <div class="team-logo-css pick-team-logo ${originalTeamIdClassName}"></div>
                        </a>
                        <div class="pick-text-content">
                          <span class="pick-description">${pickDescriptionText}</span>
                          ${originDisplayHTML}
                        </div>
                      </div>
                      <div class="pick-status">
                        ${statusText}
                      </div>
                    </div>
                  `;
                }).join('');
                
                return `<div class="season-group" style="margin-bottom: 1.5rem;"><div class="season-header" style="background-color: ${seasonColor}; color: white; padding: 1rem; border-radius: 6px 6px 0 0; font-weight: bold; display: flex; justify-content: space-between; align-items: center;"><span>Season ${season} Draft</span><span class="season-pick-count-badge" style="background-color: rgba(255,255,255,0.2); padding: 0.3rem 0.6rem; border-radius: 12px;">${picks.length} pick${picks.length !== 1 ? "s" : ""}</span></div><div class="season-picks" style="border: 1px solid ${seasonColor}; border-top: none; border-radius: 0 0 6px 6px;">${picksHTML}</div></div>`;
              }).join('');
            
            const totalPicks = teamPicks.length;
            const summaryPendingForfeitureCount = teamPicks.filter(p => p.notes && p.notes.toUpperCase() === 'PENDING FORFEITURE').length;
            const summaryOwnPicks = teamPicks.filter(p => p.original_team === teamId && !(p.notes && p.notes.toUpperCase() === 'PENDING FORFEITURE')).length;
            const summaryAcquiredPicks = teamPicks.filter(p => p.original_team !== teamId && !(p.notes && p.notes.toUpperCase() === 'PENDING FORFEITURE')).length;
            
            const summaryHTML = `<div class="draft-summary"><div class="draft-summary-grid"><div class="draft-summary-item"><div class="draft-summary-value total">${totalPicks}</div><div class="draft-summary-label">Total Picks</div></div><div class="draft-summary-item"><div class="draft-summary-value own">${summaryOwnPicks}</div><div class="draft-summary-label">Own Picks</div></div><div class="draft-summary-item"><div class="draft-summary-value acquired">${summaryAcquiredPicks}</div><div class="draft-summary-label">Acquired</div></div>${summaryPendingForfeitureCount > 0 ? `<div class="draft-summary-item"><div class="draft-summary-value forfeiture">${summaryPendingForfeitureCount}</div><div class="draft-summary-label">Pending Forfeiture</div></div>` : ''}</div></div>`;
            document.getElementById('draft-picks').innerHTML = summaryHTML + seasonsHTML;
        }

        function getSeasonColor(season) {
          const colors = { 8: '#007bff', 9: '#28a745', 10: '#ffc107', 11: '#dc3545', 12: '#6c757d' };
          return colors[season] || '#6c757d';
        }

        async function showGameDetails(team1Id, team2Id, date) {
          const modal = document.getElementById('game-modal');
          const modalTitle = document.getElementById('modal-title');
          const modalContentEl = document.getElementById('modal-content'); 
          
          modal.style.display = 'block';
          modalTitle.textContent = `${escapeHTML(getTeamName(team1Id))} vs ${escapeHTML(getTeamName(team2Id))} - ${formatDateShort(date)}`;
          modalContentEl.innerHTML = '<div class="loading">Loading game details...</div>';
          
          const game = allScheduleData.find(g => g.team1_id === team1Id && g.team2_id === team2Id && normalizeDate(g.date) === date);
          if (!game) { modalContentEl.innerHTML = '<div class="error">Game not found</div>'; return; }
          
          const lineupsData = allLineups; 
          if (!lineupsData) { modalContentEl.innerHTML = '<div class="error">Error loading lineup data</div>'; return; }
          
          const team1Lineups = lineupsData.filter(l => l.team_id === team1Id && normalizeDate(l.date) === date && l.started === 'TRUE').sort((a,b) => (b.captain === 'TRUE' ? 1 : 0) - (a.captain === 'TRUE' ? 1 : 0) || parseNumber(b.points_final) - parseNumber(a.points_final));
          const team2Lineups = lineupsData.filter(l => l.team_id === team2Id && normalizeDate(l.date) === date && l.started === 'TRUE').sort((a,b) => (b.captain === 'TRUE' ? 1 : 0) - (a.captain === 'TRUE' ? 1 : 0) || parseNumber(b.points_final) - parseNumber(a.points_final));
          
          const team1Total = team1Lineups.reduce((sum, p) => sum + parseNumber(p.points_final), 0);
          const team2Total = team2Lineups.reduce((sum, p) => sum + parseNumber(p.points_final), 0);
          
          const generateLineupTable = (lineupsForTable, idOfTeam, total, isWinner) => { 
            const teamDetailsForModal = allTeams.find(t => t.team_id === idOfTeam); 
            const teamRecord = teamDetailsForModal ? `${teamDetailsForModal.wins || 0}-${teamDetailsForModal.losses || 0}` : '';
            const teamIdClassName = `icon-${idOfTeam.replace(/[^a-zA-Z0-9]/g, '')}`;

            if (lineupsForTable.length === 0) return `<div class="team-breakdown ${isWinner ? 'winner' : ''}"><div class="modal-team-header ${isWinner ? 'winner' : ''}" onclick="window.location.href='team.html?id=${idOfTeam}'" style="cursor: pointer;"><div class="team-logo-css ${teamIdClassName}" style="width: 48px; height: 48px;"></div><div><h4>${escapeHTML(getTeamName(idOfTeam))}</h4><div style="font-size: 0.9rem; opacity: 0.9;">${teamRecord}</div></div></div><div class="team-total">Total: ${Math.round(total).toLocaleString()}</div><div style="padding: 2rem; text-align: center; color: #666;">No lineup data available</div></div>`;
            
            const lineupRows = lineupsForTable.map(player => {
              const isCaptain = player.captain === 'TRUE';
              const pointsRaw = parseNumber(player.points_raw);
              const globalRank = parseNumber(player.global_rank);
              const captainBonus = isCaptain ? Math.round(pointsRaw * 0.5) : 0;
              const fullPlayerData = processedPlayersData.find(p => p.player_handle === player.player_handle);
              const allStarBadge = fullPlayerData && fullPlayerData.all_star === '1' ? '<span class="all-star-badge">★</span>' : '';
              const rookieBadge = fullPlayerData && fullPlayerData.rookie === '1' ? '<span class="rookie-badge">R</span>' : '';

              return `<tr class="${isCaptain ? 'captain-row' : ''}"><td class="player-name-cell"><a href="player.html?player=${encodeURIComponent(player.player_handle || 'Unknown')}" class="player-link">${escapeHTML(player.player_handle || 'Unknown')}</a>${rookieBadge}${allStarBadge}${isCaptain ? '<span class="captain-badge">C</span>' : ''}</td><td class="points-cell">${Math.round(pointsRaw).toLocaleString()}${isCaptain ? `<div class="captain-bonus">+${captainBonus.toLocaleString()}</div>` : ''}</td><td class="rank-cell">${globalRank > 0 ? Math.round(globalRank) : '-'}</td></tr>`;
            }).join('');
            
            return `<div class="team-breakdown ${isWinner ? 'winner' : ''}"><div class="modal-team-header ${isWinner ? 'winner' : ''}" onclick="window.location.href='team.html?id=${idOfTeam}'" style="cursor: pointer;"><div class="team-logo-css ${teamIdClassName}" style="width: 48px; height: 48px;"></div><div><h4>${escapeHTML(getTeamName(idOfTeam))}</h4><div style="font-size: 0.9rem; opacity: 0.9;">${teamRecord}</div></div></div><div class="team-total">Total: ${isNaN(total) ? '-' : Math.round(total).toLocaleString()}</div><table class="lineup-table"><thead><tr><th>Player</th><th>Points</th><th>Rank</th></tr></thead><tbody>${lineupRows}</tbody></table></div>`;
          };
          
          modalContentEl.innerHTML = `<div class="game-details-grid">${generateLineupTable(team1Lineups, team1Id, team1Total, game.winner === team1Id)}${generateLineupTable(team2Lineups, team2Id, team2Total, game.winner === team2Id)}</div>`;
        }
        
        function closeGameModal() {
          document.getElementById('game-modal').style.display = 'none';
        }
        
        window.onclick = (event) => {
          if (event.target === document.getElementById('game-modal')) closeGameModal();
        }
        
        async function fetchCollection(collectionName) {
          try {
              const snapshot = await db.collection(collectionName).get();
              return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          } catch (error) {
              console.error(`Error fetching ${collectionName}:`, error);
              const mainContent = document.querySelector('main');
              if(mainContent) {
                  mainContent.innerHTML = `<div class="error">Failed to load data from collection: ${collectionName}. Check Firestore permissions and connectivity.</div>` + mainContent.innerHTML;
              }
              return [];
          }
        }
        
        async function loadTeamData() {
          try {
              teamId = getUrlParameter('id');
              if (!teamId) {
                document.getElementById('team-main-info').innerHTML = '<div class="error">No team specified in URL.</div>';
                return;
              }

              const [
                teamsResult, playersResult, weeklyAveragesResult, 
                transactionsLogResult, lineupsResult, scheduleResult, draftPicksResult
              ] = await Promise.all([
                fetchCollection('teams'), fetchCollection('players'), fetchCollection('weekly_averages'),
                fetchCollection('transaction_log'), fetchCollection('lineups'), fetchCollection('schedule'),
                fetchCollection('draft_capital')
              ]);
              
              allTeams = teamsResult;
              // --- Generate the CSS for all team icons at once ---
              generateIconStylesheet(allTeams);

              allWeeklyAverages = weeklyAveragesResult;
              allTransactionsLogData = transactionsLogResult;
              allLineups = lineupsResult;
              allScheduleData = scheduleResult;
              allDraftPicks = draftPicksResult;

              processedPlayersData = calculateStatsForAllPlayers(playersResult, allWeeklyAverages, allLineups);
              teamData = allTeams.find(team => team.team_id === teamId);

              if (!teamData) {
                document.getElementById('team-main-info').innerHTML = '<div class="error">Team not found for ID: ' + escapeHTML(teamId) + '</div>';
                return;
              }

              teamData.calculated_total_transactions = countTransactionsForTeam(teamData.team_id, allTransactionsLogData);
              
              const activeTeamsForRanking = allTeams.filter(t => t.team_id && t.team_id.toUpperCase() !== 'RETIRED' && t.team_id.toUpperCase() !== 'FREE_AGENT' && t.conference);
              const rankings = calculateTeamRankings(teamData, activeTeamsForRanking);
              
              displayTeamHeader(rankings); 
              
              await Promise.all([
                loadRoster(),
                loadSchedule(),
                loadDraftCapital() 
              ]);
          } catch (error) {
              console.error("A critical error occurred during data loading:", error);
               document.querySelector('main').innerHTML = `<div class="error">A critical error occurred while loading the page. Please check the console for details.</div>` + document.querySelector('main').innerHTML;
          }
        }

        let hasLoaded = false;
        window.showGameDetails = showGameDetails;
        window.closeGameModal = closeGameModal;
        window.handleRosterSort = handleRosterSort;
        
        auth.onAuthStateChanged(user => {
            if (!hasLoaded) {
                hasLoaded = true;
                loadTeamData();
            }
        });
      });
    </script>
  </body>
</html>