<!DOCTYPE html>
<html lang="en" data-style-rollout="modern">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E8LNVNG5M1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-E8LNVNG5M1');
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real Karma League S7</title>
    <link rel="stylesheet" href="/css/global-styles.css">
    <link rel="stylesheet" href="/css/RKL-S9.css">
    <link rel="icon" href="/rklfavicon.ico" type="image/x-icon" />
    <script>
        // Apply theme from local storage before page loads to prevent flashing
        (function () {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>
    <header>
        <button id="theme-toggle-btn" aria-label="Toggle Theme">
            <span class="sun-icon">‚òÄÔ∏è</span>
            <span class="moon-icon">üåô</span>
        </button>
        <h1>
            <a href="/index.html" class="header-link">
                <img src="/icons/RKL.webp" alt="RKL Logo" class="header-logo" onerror="this.style.display='none'" loading="lazy">
                <span class="header-text">Real Karma League</span>
            </a>
        </h1>
        <nav>
            <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">&#9776;</button>
            <ul id="nav-menu">
                <li class="dropdown">
                    <a href="RKL-S7.html" class="dropbtn">S7 Home &#9662;</a>
                    <div class="dropdown-content">
                        <a href="/S9/RKL-S9.html">S9 Home</a>
                        <a href="/S8/RKL-S8.html">S8 Home</a>
                        <a href="/S7/RKL-S7.html">S7 Home</a>
                    </div>
                </li>
                <li><a href="standings.html">Standings & Rankings</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0);" class="dropbtn">Stats Hub &#9662;</a>
                    <div class="dropdown-content">
                        <a href="leaderboards.html">Leaderboards</a>
                        <a href="compare.html">Comparison Tool</a>
                    </div>
                </li>
                <li><a href="schedule.html">Schedule</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0);" class="dropbtn">Draft Central &#9662;</a>
                    <div class="dropdown-content">
                        <a href="draft-capital.html">Draft Capital</a>
                        <a href="draft-results.html">Draft Results</a>
                        <a href="draft-lottery.html">Draft Lottery</a>
                    </div>
                </li>
                <li><a href="transactions.html">Transactions</a></li>
                <li><a href="teams.html">Teams</a></li>
                <li><a href="trophy-case.html">Trophy Case</a></li>
                <li><a href="/common/changelog.html">Changelog</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="page-header">
            <h2>RKL Season 7</h2>
        </div>

        <div id="playoff-button-container" class="playoff-button-container" style="display: none;">
            <a href="playoff-bracket.html" class="playoff-button">View Playoff Bracket ‚ûî</a>
        </div>

        <div class="season-info">
            <div id="current-week-container">
                <p><strong>Current Week:</strong> <span id="current-week">Loading...</span></p>
            </div>
            <div id="season-stats">
                <p>Loading season statistics...</p>
            </div>
        </div>

        <div class="quick-nav">
            <div class="nav-card"><a href="standings.html">üìä Standings & Rankings</a></div>
            <div class="nav-card"><a href="leaderboards.html">üèÜ Player Leaderboards</a></div>
            <div class="nav-card"><a href="schedule.html">üìÖ Schedule & Results</a></div>
            <div class="nav-card"><a href="transactions.html">üîÑ Transactions</a></div>
            <div class="nav-card"><a href="trophy-case.html">üèÜ Trophy Case</a></div>
            <div class="nav-card"><a href="draft-capital.html">üìã Draft Central</a></div>
        </div>

        <div class="main-grid">
            <div class="standings-preview">
                <div class="standings-header"><h3>League Leaders</h3></div>
                <div class="conference-standings">
                    <div class="conference-title">Eastern Conference</div>
                    <table class="standings-table" id="eastern-standings-table">
                        <thead>
                            <tr>
                                <th>Team</th>
                                <th>W-L</th>
                                <th>PAM</th>
                                <th class="desktop-only-col">Med Rank</th>
                            </tr>
                        </thead>
                        <tbody id="eastern-standings">
                            <tr><td colspan="4" class="loading">Loading standings...</td></tr>
                        </tbody>
                    </table>

                    <div class="conference-title">Western Conference</div>
                    <table class="standings-table" id="western-standings-table">
                        <thead>
                            <tr>
                                <th>Team</th>
                                <th>W-L</th>
                                <th>PAM</th>
                                <th class="desktop-only-col">Med Rank</th>
                            </tr>
                        </thead>
                        <tbody id="western-standings">
                            <tr><td colspan="4" class="loading">Loading standings...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="view-full"><a href="standings.html">View Full Standings ‚Üí</a></div>
            </div>

            <div class="recent-games">
                <div class="games-header"><h3>Recent Games</h3></div>
                <div class="games-list" id="recent-games"><div class="loading">Loading recent games...</div></div>
                <div class="view-full"><a href="schedule.html">View Full Schedule ‚Üí</a></div>
            </div>
        </div>
    </main>

    <div id="game-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Game Details</h3>
                <button class="close-btn" onclick="closeGameModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="game-details-content-area">
                    <div class="loading">Loading game details...</div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>@caustic on Real</p>
        <a href="/common/trade-block.html">GM Portal</a> | <a href="/commish/dashboard.html">Commish</a>
    </footer>

    <script src="../js/main.js" type="module"></script>
    <script>
        const SHEET_ID = '12EembQnztbdKx2-buv00--VDkEFSTuSXTRdOnTnRxq4';
        const BASE_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=`;
        const POSTSEASON_WEEK_IDS = ['Play-In', 'Round 1', 'Round 2', 'Conf Finals', 'Finals'];

        let allTeams = [];
        let allPostSchedule = [];

        function getTeamName(teamId, teamsArray = allTeams) {
            const team = teamsArray.find(t => t.team_id === teamId);
            return team ? team.team_name : teamId;
        }

        function formatInThousands(value) {
            const num = parseFloat(value);
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return Math.round(num).toLocaleString();
        }

        function parseNumber(value) {
            if (!value) return 0;
            const cleaned = value.toString().replace(/,/g, '');
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? 0 : parsed;
        }

        async function fetchSheetData(sheetName) {
            try {
                const response = await fetch(BASE_URL + encodeURIComponent(sheetName));
                const csvText = await response.text();
                return parseCSV(csvText);
            } catch (error) {
                console.error(`Error fetching ${sheetName}:`, error);
                return null;
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = parseCSVLine(lines[0]);
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => { row[header] = values[index] || ''; });
                data.push(row);
            }
            return data;
        }

        function parseCSVLine(line) {
            const result = []; let current = ''; let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else current += char;
            }
            result.push(current.trim());
            return result.map(field => field.replace(/^"(.*)"$/, '$1'));
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatDateShort(dateString) {
            const date = new Date(dateString);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            return `${month}/${day}/${year}`;
        }

        async function loadStandingsPreview() {
            const teamsData = await fetchSheetData('Teams');
            if (!teamsData) {
                document.getElementById('eastern-standings').innerHTML = '<tr><td colspan="4" class="error">Error loading standings</td></tr>';
                document.getElementById('western-standings').innerHTML = '<tr><td colspan="4" class="error">Error loading standings</td></tr>';
                return;
            }

            if (allTeams.length === 0) allTeams = teamsData;

            const easternTeams = teamsData.filter(team => team.conference === 'Eastern')
                .sort((a, b) => {
                    const winsA = parseInt(a.wins || 0);
                    const lossesA = parseInt(a.losses || 0);
                    const totalGamesA = winsA + lossesA;
                    const winPctA = totalGamesA > 0 ? winsA / totalGamesA : 0;

                    const winsB = parseInt(b.wins || 0);
                    const lossesB = parseInt(b.losses || 0);
                    const totalGamesB = winsB + lossesB;
                    const winPctB = totalGamesB > 0 ? winsB / totalGamesB : 0;

                    if (winPctB !== winPctA) {
                        return winPctB - winPctA;
                    }
                    return parseFloat(b.pam || 0) - parseFloat(a.pam || 0);
                }).slice(0, 5);

            const westernTeams = teamsData.filter(team => team.conference === 'Western')
                .sort((a, b) => {
                    const winsA = parseInt(a.wins || 0);
                    const lossesA = parseInt(a.losses || 0);
                    const totalGamesA = winsA + lossesA;
                    const winPctA = totalGamesA > 0 ? winsA / totalGamesA : 0;

                    const winsB = parseInt(b.wins || 0);
                    const lossesB = parseInt(b.losses || 0);
                    const totalGamesB = winsB + lossesB;
                    const winPctB = totalGamesB > 0 ? winsB / totalGamesB : 0;

                    if (winPctB !== winPctA) {
                        return winPctB - winPctA;
                    }
                    return parseFloat(b.pam || 0) - parseFloat(a.pam || 0);
                }).slice(0, 5);

            const easternHTML = easternTeams.map(team => {
                const medRank = parseFloat(team.med_starter_rank || 0);
                let clinchBadgeHtml = '';
                if (team.playoffs === '1') {
                    clinchBadgeHtml = '<span class="clinch-badge clinch-playoff">x</span>';
                } else if (team.playin === '1') {
                    clinchBadgeHtml = '<span class="clinch-badge clinch-playin">p</span>';
                } else if (team.elim === '1') {
                    clinchBadgeHtml = '<span class="clinch-badge clinch-eliminated">e</span>';
                }
                return `
                          <tr>
                            <td>
                              <a href="team.html?id=${team.team_id}" class="team-link">
                                <img src="icons/${team.team_id}.webp" alt="${team.team_name}" class="team-logo" onerror="this.style.display='none'" loading="lazy">
                                <span>${team.team_name}</span>
                                ${clinchBadgeHtml}
                              </a>
                            </td>
                            <td>${team.wins || 0}-${team.losses || 0}</td>
                            <td>${Math.round(parseFloat(team.pam || 0)).toLocaleString()}</td>
                            <td class="desktop-only-col">${medRank > 0 ? Math.round(medRank) : '-'}</td>
                          </tr>
                        `}).join('');

            const westernHTML = westernTeams.map(team => {
                const medRank = parseFloat(team.med_starter_rank || 0);
                let clinchBadgeHtml = '';
                if (team.playoffs === '1') {
                    clinchBadgeHtml = '<span class="clinch-badge clinch-playoff">x</span>';
                } else if (team.playin === '1') {
                    clinchBadgeHtml = '<span class="clinch-badge clinch-playin">p</span>';
                } else if (team.elim === '1') {
                    clinchBadgeHtml = '<span class="clinch-badge clinch-eliminated">e</span>';
                }
                return `
                          <tr>
                            <td>
                              <a href="team.html?id=${team.team_id}" class="team-link">
                                <img src="icons/${team.team_id}.webp" alt="${team.team_name}" class="team-logo" onerror="this.style.display='none'" loading="lazy">
                                <span>${team.team_name}</span>
                                ${clinchBadgeHtml}
                              </a>
                            </td>
                            <td>${team.wins || 0}-${team.losses || 0}</td>
                            <td>${Math.round(parseFloat(team.pam || 0)).toLocaleString()}</td>
                            <td class="desktop-only-col">${medRank > 0 ? Math.round(medRank) : '-'}</td>
                          </tr>
                        `}).join('');

            document.getElementById('eastern-standings').innerHTML = easternHTML;
            document.getElementById('western-standings').innerHTML = westernHTML;
        }

        async function loadRecentGames() {
            const scheduleData = await fetchSheetData('Schedule');
            const postScheduleData = await fetchSheetData('Post_Schedule');
            const teamsData = await fetchSheetData('Teams');

            if (!scheduleData || !teamsData) {
                document.getElementById('recent-games').innerHTML = '<div class="error">Error loading recent games</div>';
                return;
            }

            if (allTeams.length === 0) allTeams = teamsData;
            if (allPostSchedule.length === 0 && postScheduleData) allPostSchedule = postScheduleData;

            const week15Games = scheduleData.filter(g => g.week === '15');
            const regSeasonComplete = week15Games.length > 0 && week15Games.every(g => g.completed === 'TRUE');

            let gamesToDisplay = [];
            let weekOfGames = null;
            let isPostseason = false;

            if (regSeasonComplete && postScheduleData) {
                const completedPostGames = postScheduleData.filter(game => game.completed === 'TRUE' && game.date);

                if (completedPostGames.length > 0) {
                    completedPostGames.sort((a, b) => new Date(b.date) - new Date(a.date));
                    const mostRecentDate = completedPostGames[0].date;

                    gamesToDisplay = completedPostGames.filter(game => game.date === mostRecentDate);
                    if (gamesToDisplay.length > 0) {
                        weekOfGames = gamesToDisplay[0].week;
                        isPostseason = POSTSEASON_WEEK_IDS.includes(weekOfGames);
                    }
                }
            }

            if (gamesToDisplay.length === 0) {
                gamesToDisplay = scheduleData
                    .filter(game => game.completed === 'TRUE')
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 5);
            }

            if (gamesToDisplay.length === 0) {
                document.getElementById('recent-games').innerHTML = '<div class="loading">No completed games yet</div>';
                return;
            }

            if (isPostseason) {
                const seriesRecords = {};
                const gamesWithSnapshots = [];
                const seriesIdsInView = [...new Set(gamesToDisplay.map(g => g.series_id))];

                seriesIdsInView.forEach(seriesId => {
                    const seriesGames = postScheduleData
                        .filter(g => g.series_id === seriesId)
                        .sort((a, b) => new Date(a.date) - new Date(b.date) || (parseInt(a.series_game, 10) || 99) - (parseInt(b.series_game, 10) || 99));

                    seriesGames.forEach(game => {
                        if (!seriesRecords[game.series_id]) {
                            seriesRecords[game.series_id] = { [game.team1_id]: { wins: 0, losses: 0 }, [game.team2_id]: { wins: 0, losses: 0 } };
                        }

                        if (game.completed === 'TRUE') {
                            const winnerId = game.winner;
                            const loserId = winnerId === game.team1_id ? game.team2_id : game.team1_id;
                            if (winnerId) {
                                if (seriesRecords[game.series_id][winnerId]) seriesRecords[game.series_id][winnerId].wins++;
                                if (seriesRecords[game.series_id][loserId]) seriesRecords[game.series_id][loserId].losses++;
                            }
                        }

                        const gameWithSnapshot = { ...game };

                        const team1Rec = seriesRecords[game.series_id][game.team1_id];
                        const team2Rec = seriesRecords[game.series_id][game.team2_id];

                        gameWithSnapshot.team1_record_snapshot = `${team1Rec.wins}-${team1Rec.losses}`;
                        gameWithSnapshot.team2_record_snapshot = `${team2Rec.wins}-${team2Rec.losses}`;

                        gamesWithSnapshots.push(gameWithSnapshot);
                    });
                });

                gamesToDisplay = gamesToDisplay.map(game => {
                    const snapshot = gamesWithSnapshots.find(gws => gws.date === game.date && gws.team1_id === game.team1_id && gws.team2_id === game.team2_id);
                    return snapshot || game;
                });
            }


            const finalSeedMap = {};
            const isPostseasonWeek = POSTSEASON_WEEK_IDS.includes(weekOfGames);

            if (isPostseasonWeek && weekOfGames !== 'Play-In') {
                const w7_final = getSeriesWinner('W-PI-7v8');
                const w8_final = getSeriesWinner('W-PI-L78vW910');
                const e7_final = getSeriesWinner('E-PI-7v8');
                const e8_final = getSeriesWinner('E-PI-L78vW910');

                if (w7_final) finalSeedMap[w7_final] = '7';
                if (w8_final) finalSeedMap[w8_final] = '8';
                if (e7_final) finalSeedMap[e7_final] = '7';
                if (e8_final) finalSeedMap[e8_final] = '8';
            }

            const gamesHTML = gamesToDisplay.map(game => {
                const team1Score = parseFloat(game.team1_score || 0);
                const team2Score = parseFloat(game.team2_score || 0);
                const winner = game.winner;
                const team1Name = getTeamName(game.team1_id, allTeams);
                const team2Name = getTeamName(game.team2_id, allTeams);

                let team1Record, team2Record;

                if (isPostseason) {
                    team1Record = game.team1_record_snapshot || '0-0';
                    team2Record = game.team2_record_snapshot || '0-0';
                } else {
                    const team1Data = allTeams.find(t => t.team_id === game.team1_id);
                    const team2Data = allTeams.find(t => t.team_id === game.team2_id);
                    team1Record = team1Data ? `${team1Data.wins || 0}-${team1Data.losses || 0}` : '';
                    team2Record = team2Data ? `${team2Data.wins || 0}-${team2Data.losses || 0}` : '';
                }

                let team1SeedHtml = '';
                let team2SeedHtml = '';

                if (isPostseason) {
                    let team1Seed = finalSeedMap[game.team1_id] || game.team1_seed;
                    let team2Seed = finalSeedMap[game.team2_id] || game.team2_seed;

                    if (team1Seed) {
                        team1SeedHtml = `<span class="team-seed">(${team1Seed})</span> `;
                    }
                    if (team2Seed) {
                        team2SeedHtml = `<span class="team-seed">(${team2Seed})</span> `;
                    }
                }

                return `
            <div class="game-item" onclick="showGameDetails('${game.team1_id}', '${game.team2_id}', '${game.date}', '${game.week}', '${team1Record}', '${team2Record}')">
              <div class="game-matchup">
                <div class="team ${winner === game.team1_id ? 'winner' : ''}">
                  <img src="icons/${game.team1_id}.webp" alt="${game.team1_id}" class="team-logo" onerror="this.style.display='none'" loading="lazy">
                  <div class="team-info">
                    <span class="team-name">${team1SeedHtml}${team1Name}</span>
                    <span class="team-record">${team1Record}</span>
                  </div>
                  <span class="team-score ${winner === game.team1_id ? 'winner' : ''}">${formatInThousands(team1Score)}</span>
                </div>
                <span class="vs">vs</span>
                <div class="team ${winner === game.team2_id ? 'winner' : ''}">
                  <img src="icons/${game.team2_id}.webp" alt="${game.team2_id}" class="team-logo" onerror="this.style.display='none'" loading="lazy">
                  <div class="team-info">
                    <span class="team-name">${team2SeedHtml}${team2Name}</span>
                    <span class="team-record">${team2Record}</span>
                  </div>
                  <span class="team-score ${winner === game.team2_id ? 'winner' : ''}">${formatInThousands(team2Score)}</span>
                </div>
              </div>
              <div class="game-date">
                ${formatDate(game.date)}
              </div>
            </div>
          `;
            }).join('');
            document.getElementById('recent-games').innerHTML = gamesHTML;
        }

        // --- HELPER FUNCTIONS FOR POSTSEASON LOGIC ---
        function getSeries(seriesId) {
            return allPostSchedule.find(g => g.series_id === seriesId);
        }

        function getWeekNameFromSeriesId(seriesId) {
            if (seriesId.includes('-PI-')) return 'Play-In';
            if (seriesId.includes('-R1-')) return 'Round 1';
            if (seriesId.includes('-R2-')) return 'Round 2';
            if (seriesId.includes('-CF')) return 'Conf Finals';
            if (seriesId.includes('FINALS')) return 'Finals';
            return '';
        }

        function getSeriesWinner(seriesId) {
            const series = getSeries(seriesId);
            if (!series) return null;

            const week = getWeekNameFromSeriesId(seriesId);
            const team1Wins = parseInt(series.team1_wins, 10) || 0;
            const team2Wins = parseInt(series.team2_wins, 10) || 0;

            if (week === 'Play-In') {
                return series.winner || null;
            }

            let win_condition = 0;
            if (week === 'Round 1' || week === 'Round 2') win_condition = 2;
            else if (week === 'Conf Finals') win_condition = 3;
            else if (week === 'Finals') win_condition = 4;

            if (team1Wins >= win_condition) return series.team1_id;
            if (team2Wins >= win_condition) return series.team2_id;

            return null;
        }

        function calculateTeamsRemaining() {
            const eliminatedTeamIds = new Set();
            // Correctly filter for the 20 teams (seeds 1-10 in each conference) that make the postseason.
            const playoffTeams = allTeams.filter(t => t.postseed && parseInt(t.postseed) >= 1 && parseInt(t.postseed) <= 10);

            if (allPostSchedule.length === 0) return playoffTeams.length;

            allPostSchedule.forEach(series => {
                const winner = getSeriesWinner(series.series_id);
                // Only count eliminations for completed series
                if (winner) {
                    // In the 7v8 play-in game, the loser is NOT eliminated. They get another chance.
                    // For all other completed series (9v10, L78vW910, R1, R2, CF, F), the loser is eliminated.
                    if (!series.series_id.includes('-PI-7v8')) {
                        const loser = series.team1_id === winner ? series.team2_id : series.team1_id;
                        // Add the loser to the set of eliminated teams.
                        if (loser && loser !== 'TBD' && !loser.includes('Winner of') && !loser.includes('Loser of')) {
                            eliminatedTeamIds.add(loser);
                        }
                    }
                }
            });
            return playoffTeams.length - eliminatedTeamIds.size;
        }

        // --- MAIN FUNCTION TO LOAD SEASON INFO ---
        async function loadSeasonInfo() {
            const [schedule, postSchedule, lineups, postLineups, transactions, teams] = await Promise.all([
                fetchSheetData('Schedule'),
                fetchSheetData('Post_Schedule'),
                fetchSheetData('Lineups'),
                fetchSheetData('Post_Lineups'),
                fetchSheetData('Transaction_Log'),
                fetchSheetData('Teams')
            ]);

            if (!schedule || !teams) {
                document.getElementById('current-week').textContent = 'Unknown';
                document.getElementById('season-stats').innerHTML = '<p>Error loading essential season information.</p>';
                return;
            }

            if (allTeams.length === 0) allTeams = teams;
            if (allPostSchedule.length === 0 && postSchedule) allPostSchedule = postSchedule;

            // --- REGULAR SEASON COMPLETION CHECK ---
            const week15Games = schedule.filter(g => g.week === '15');
            const regSeasonComplete = week15Games.length > 0 && week15Games.every(g => g.completed === 'TRUE');

            // --- CURRENT WEEK LOGIC ---
            const currentWeekContainer = document.getElementById('current-week-container');
            const currentWeekSpan = document.getElementById('current-week');

            if (regSeasonComplete) {
                document.getElementById('playoff-button-container').style.display = 'block';
                const stages = ['Play-In', 'Round 1', 'Round 2', 'Conf Finals', 'Finals'];
                const stageDisplayNames = {
                    'Play-In': 'Postseason Play-In',
                    'Round 1': 'Playoffs Round 1',
                    'Round 2': 'Playoffs Round 2',
                    'Conf Finals': 'Conference Finals',
                    'Finals': 'RKL Finals'
                };
                let currentStage = '';

                for (const stage of stages) {
                    const stageGames = postSchedule.filter(g => g.week === stage);
                    if (stageGames.length === 0 || !stageGames.every(g => g.completed === 'TRUE')) {
                        currentStage = stage;
                        break;
                    }
                }

                if (currentStage) {
                    currentWeekSpan.textContent = stageDisplayNames[currentStage];
                } else {
                    currentWeekContainer.innerHTML = `<p><strong>Season Complete!</strong></p>`;
                }
            } else {
                const gamesByWeek = {};
                schedule.forEach(game => {
                    const week = parseInt(game.week);
                    if (!gamesByWeek[week]) { gamesByWeek[week] = { total: 0, completed: 0 }; }
                    gamesByWeek[week].total++;
                    if (game.completed === 'TRUE') { gamesByWeek[week].completed++; }
                });

                let currentWeek = 1;
                const weeks = Object.keys(gamesByWeek).map(w => parseInt(w)).sort((a, b) => a - b);

                for (const week of weeks) {
                    if (gamesByWeek[week].completed < gamesByWeek[week].total) { currentWeek = week; break; }
                    currentWeek = week;
                }
                currentWeekSpan.textContent = `Week ${currentWeek}`;
            }

            // --- SEASON STATS LOGIC ---
            const seasonStatsContainer = document.getElementById('season-stats');
            let statsHTML = '';

            // Stat 1: Games Complete / Teams Remaining
            if (regSeasonComplete) {
                const finalsWinnerId = getSeriesWinner('FINALS');
                if (finalsWinnerId) {
                    const winnerData = allTeams.find(t => t.team_id === finalsWinnerId);
                    statsHTML += `<div class="champion-display"><span class="champion-label">üèÜ League Champion:</span><span class="champion-team"><img src="icons/${winnerData.team_id}.webp" onerror="this.style.display='none'"/ loading="lazy"> ${winnerData.team_name} <span class="champion-trophy">üèÜ</span></span></div>`;
                } else {
                    const teamsRemaining = calculateTeamsRemaining();
                    statsHTML += `<p><strong>${teamsRemaining}</strong> Postseason Teams Remaining</p>`;
                }
            } else {
                const completedGames = schedule.filter(game => game.completed === 'TRUE').length;
                statsHTML += `<p><strong>${completedGames} of ${schedule.length}</strong> regular season games complete</p>`;
            }

            // Stat 2: Transactions
            let uniqueTransactionCount = 0;
            if (transactions) {
                const uniqueTransactionIds = new Set();
                transactions.forEach(transaction => {
                    if (transaction.transaction_id && transaction.transaction_type && !transaction.notes?.toLowerCase().includes('pre-database') && !transaction.notes?.toLowerCase().includes('preseason')) {
                        uniqueTransactionIds.add(transaction.transaction_id);
                    }
                });
                uniqueTransactionCount = uniqueTransactionIds.size;
            }
            statsHTML += `<p><strong>${uniqueTransactionCount}</strong> transactions made (excludes pre-database moves)</p>`;

            // Stat 3: Total Karma
            let totalKarma = 0;
            if (lineups) {
                totalKarma += lineups.reduce((sum, entry) => sum + parseNumber(entry.points_raw), 0);
            }
            if (regSeasonComplete && postLineups) {
                totalKarma += postLineups.reduce((sum, entry) => sum + parseNumber(entry.points_raw), 0);
            }
            statsHTML += `<p><strong>${Math.round(totalKarma).toLocaleString()}</strong> total karma earned</p>`;

            seasonStatsContainer.innerHTML = statsHTML;
        }

        async function showGameDetails(team1Id, team2Id, date, week, t1Record, t2Record) {
            const modal = document.getElementById('game-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContentArea = document.getElementById('game-details-content-area');

            modal.style.display = 'block';
            const team1Name = getTeamName(team1Id, allTeams);
            const team2Name = getTeamName(team2Id, allTeams);
            modalTitle.textContent = `${team1Name} vs ${team2Name} - ${formatDateShort(date)}`;
            modalContentArea.innerHTML = '<div class="loading">Loading game details...</div>';

            const isPostseason = POSTSEASON_WEEK_IDS.includes(week);
            const scheduleSheet = isPostseason ? 'Post_Schedule' : 'Schedule';
            const lineupSheet = isPostseason ? 'Post_Lineups' : 'Lineups';

            const [scheduleData, lineupsData, playersData] = await Promise.all([
                fetchSheetData(scheduleSheet),
                fetchSheetData(lineupSheet),
                fetchSheetData('Players')
            ]);

            if (!scheduleData || !lineupsData || !playersData) {
                modalContentArea.innerHTML = '<div class="error">Error loading data for modal.</div>';
                return;
            }

            const game = scheduleData.find(g =>
                g.team1_id === team1Id &&
                g.team2_id === team2Id &&
                g.date === date
            );

            if (!game) {
                modalContentArea.innerHTML = '<div class="error">Game details not found.</div>';
                return;
            }

            // Use the passed-in records directly, bypassing the old calculation block.
            const team1Record = t1Record;
            const team2Record = t2Record;

            const team1AllLineups = lineupsData.filter(lineup =>
                lineup.team_id === team1Id && lineup.date === date
            );
            const team2AllLineups = lineupsData.filter(lineup =>
                lineup.team_id === team2Id && lineup.date === date
            );

            const sortLineup = (a, b) => {
                const aCaptain = a.captain === 'TRUE' || a.captain === true || a.captain === 'true';
                const bCaptain = b.captain === 'TRUE' || b.captain === true || b.captain === 'true';
                if (aCaptain && !bCaptain) return -1;
                if (!aCaptain && bCaptain) return 1;
                return parseNumber(b.points_raw) - parseNumber(a.points_raw);
            };

            const team1Lineups = team1AllLineups.filter(l => (l.started === 'TRUE' || l.started === true || l.started === 'true' || l.started === 1 || l.started === '1')).sort(sortLineup);
            const team2Lineups = team2AllLineups.filter(l => (l.started === 'TRUE' || l.started === true || l.started === 'true' || l.started === 1 || l.started === '1')).sort(sortLineup);

            const team1Total = team1Lineups.reduce((sum, p) => sum + parseNumber(p.points_final), 0);
            const team2Total = team2Lineups.reduce((sum, p) => sum + parseNumber(p.points_final), 0);
            const winner = game.winner;

            const generateLineupTable = (lineups, teamIdForTable, record, total, isWinner) => {
                if (lineups.length === 0) {
                    return `
                  <div class="team-breakdown ${isWinner ? 'winner' : ''}">
                    <div class="modal-team-header ${isWinner ? 'winner' : ''}" onclick="window.location.href='team.html?id=${teamIdForTable}'" style="cursor: pointer;">
                      <img src="icons/${teamIdForTable}.webp" alt="${getTeamName(teamIdForTable, allTeams)}" class="team-logo" onerror="this.style.display='none'" loading="lazy">
                      <div><h4>${getTeamName(teamIdForTable, allTeams)}</h4><div style="font-size: 0.9rem; opacity: 0.9;">(${record})</div></div>
                    </div>
                    <div class="team-total">Total: ${Math.round(total).toLocaleString()}</div>
                    <div style="padding: 2rem; text-align: center; color: #666;">No lineup data available</div>
                  </div>`;
                }
                const lineupRows = lineups.map(player => {
                    const isCaptain = player.captain === 'TRUE' || player.captain === true || player.captain === 'true';
                    const pointsRaw = parseNumber(player.points_raw);
                    const globalRank = parseNumber(player.global_rank);
                    const captainBonus = isCaptain ? Math.round(parseNumber(player.points_final) - pointsRaw) : 0;

                    const playerData = playersData.find(p => p.player_handle === player.player_handle);
                    const isRookie = playerData && playerData.rookie === '1';
                    const isAllStar = playerData && playerData.all_star === '1';
                    const rookieBadge = isRookie ? '<span class="rookie-badge">R</span>' : '';
                    const allStarBadge = isAllStar ? '<span class="all-star-badge">‚òÖ</span>' : '';

                    return `
                  <tr class="${isCaptain ? 'captain-row' : ''}">
                    <td class="player-name-cell"><a href="player.html?player=${encodeURIComponent(player.player_handle || 'Unknown')}" class="player-link">${player.player_handle || 'Unknown'}</a>${rookieBadge}${allStarBadge}</td>
                    <td class="points-cell">${Math.round(pointsRaw).toLocaleString()}${isCaptain && captainBonus > 0 ? `<div class="captain-bonus">+${captainBonus.toLocaleString()}</div>` : ''}</td>
                    <td class="rank-cell">${globalRank > 0 ? Math.round(globalRank) : '-'}</td>
                  </tr>`;
                }).join('');
                return `
                <div class="team-breakdown ${isWinner ? 'winner' : ''}">
                  <div class="modal-team-header ${isWinner ? 'winner' : ''}" onclick="window.location.href='team.html?id=${teamIdForTable}'" style="cursor: pointer;">
                    <img src="icons/${teamIdForTable}.webp" alt="${getTeamName(teamIdForTable, allTeams)}" class="team-logo" onerror="this.style.display='none'" loading="lazy">
                    <div><h4>${getTeamName(teamIdForTable, allTeams)}</h4><div style="font-size: 0.9rem; opacity: 0.9;">(${record})</div></div>
                  </div>
                  <div class="team-total">Total: ${isNaN(total) ? '-' : Math.round(total).toLocaleString()}</div>
                  <table class="lineup-table"><thead><tr><th>Player</th><th>Points</th><th>Rank</th></tr></thead><tbody>${lineupRows}</tbody></table>
                </div>`;
            };

            modalContentArea.innerHTML = `<div class="game-details-grid">${generateLineupTable(team1Lineups, team1Id, team1Record, team1Total, winner === team1Id)}${generateLineupTable(team2Lineups, team2Id, team2Record, team2Total, winner === team2Id)}</div>`;
        }

        function closeGameModal() {
            document.getElementById('game-modal').style.display = 'none';
        }
        window.onclick = function (event) {
            const modal = document.getElementById('game-modal');
            if (event.target === modal) { closeGameModal(); }
        }

        function initializePage() {
            loadStandingsPreview();
            Promise.all([
                loadRecentGames(),
                loadSeasonInfo()
            ]);
        }
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
