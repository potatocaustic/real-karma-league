<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RKL Season 8 Playoff Bracket</title>
    <link rel="stylesheet" href="/css/global-styles.css">
    <link rel="icon" href="/rklfavicon.ico" type="image/x-icon" />
    <script>
        window.firebasePageConfig = {
            useProdCollections: true 
        };
    </script>
    <script>
        (function () {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    <style>
        :root {
            --bracket-border-color: #ddd;
            --bracket-bg-color: #f8f9fa;
            --winner-color: #28a745;
            --winner-bg: #e8f5e8;
            --team-hover-bg: #e9ecef;
            --playin-bg-color: #fff;
            --bg-color: #fff; 
            --details-border-color: #ddd;
            --details-summary-bg: #f8f9fa;
            --details-summary-hover-bg: #e9ecef;
        }

        .dark-mode {
            --bracket-border-color: #444;
            --bracket-bg-color: #2c2c2c;
            --winner-color: #66bb6a;
            --winner-bg: #3a4a3a;
            --team-hover-bg: #383838;
            --playin-bg-color: #1e1e1e;
            --bg-color: #121212; 
            --details-border-color: #444;
            --details-summary-bg: #2c2c2c;
            --details-summary-hover-bg: #383838;
        }

        #play-in-details {
            border: 1px solid var(--details-border-color);
            border-radius: 8px;
            margin-bottom: 2rem;
            background-color: var(--playin-bg-color);
        }

        #play-in-summary {
            padding: 1rem 1.5rem;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            list-style: none; 
            background-color: var(--details-summary-bg);
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

            #play-in-summary::-webkit-details-marker {
                display: none; 
            }

            #play-in-summary:hover {
                background-color: var(--details-summary-hover-bg);
            }

        #play-in-details[open] #play-in-summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: 1px solid var(--details-border-color);
        }

        .play-in-content-wrapper {
            padding: 1.5rem;
        }

        .play-in-section {
            display: flex;
            justify-content: space-around;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .play-in-conference {
            background-color: var(--playin-bg-color);
            border: 1px solid var(--bracket-border-color);
            border-radius: 8px;
            padding: 1.5rem;
            width: 100%;
            max-width: 550px;
            flex-grow: 1;
        }

        .page-header + .play-in-section {
            margin-bottom: 2rem;
        }

        #play-in-details .play-in-conference {
            border: none;
            padding: 0;
        }

        #play-in-details .play-in-content-wrapper {
            padding: 1.5rem;
        }

        .play-in-title {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            font-weight: bold;
        }

        .play-in-matchup {
            margin-bottom: 1rem;
        }

            .play-in-matchup .matchup-label {
                font-size: 0.8rem;
                font-weight: bold;
                color: #666;
                margin-bottom: 0.25rem;
                text-align: center;
            }

        .dark-mode .play-in-matchup .matchup-label {
            color: #bbb;
        }

        .play-in-matchup .team {
            width: 100%;
        }

        .bracket-container {
            width: 100%;
            overflow-x: auto;
            padding: 1rem 0;
            -webkit-overflow-scrolling: touch;
        }

        .bracket {
            display: grid;
            grid-template-areas: "titles" "body";
            grid-template-rows: auto 1fr;
            min-width: 1140px;
        }

        .bracket-header-row {
            grid-area: titles;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
        }

        .bracket-body-row {
            grid-area: body;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
        }

        .round-title {
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
        }

            .round-title .series-format {
                display: block;
                font-size: 0.85rem;
                font-weight: normal;
                color: #6c757d;
                margin-top: 4px;
            }

        .dark-mode .round-title .series-format {
            color: #adb5bd;
        }

        .round-column {
            display: flex;
            flex-direction: column;
            padding: 0 0.75rem;
        }

        .conference-section {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .conference-subtitle {
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            color: #6c757d;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .dark-mode .conference-subtitle {
            color: #adb5bd;
        }

        .conference-group {
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex-grow: 1;
            align-items: center; 
        }

        .matchup-subgroup {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            flex-grow: 1;
            width: 100%;
            align-items: center; 
        }

        .matchup {
            display: inline-flex; 
            flex-direction: column;
            position: relative;
            margin: 0.75rem 0;
        }

        .team {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background-color: var(--bracket-bg-color);
            border: 1px solid var(--bracket-border-color);
            border-radius: 4px;
            width: 210px;
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
        }

            .team:hover {
                background-color: var(--team-hover-bg);
                border-color: #007bff;
            }

            .team:first-of-type {
                margin-bottom: 1rem;
            }

            .team.winner {
                font-weight: bold;
                border-color: var(--winner-color);
                background-color: var(--winner-bg);
            }

            .team.tbd {
                font-style: italic;
                color: #777;
            }

        .dark-mode .team.tbd {
            color: #aaa;
        }

        .team.non-interactive {
            pointer-events: none;
        }

        .team-logo {
            width: 24px;
            height: 24px;
            margin-right: 0.5rem;
            flex-shrink: 0;
        }

        .team-info {
            display: flex;
            justify-content: space-between;
            flex-grow: 1;
            align-items: center;
        }

        .team-seed {
            font-weight: bold;
            margin-right: 0.5rem;
            color: #666;
            min-width: 20px;
        }

        .dark-mode .team-seed {
            color: #bbb;
        }

        .team-name {
            font-size: 0.9rem;
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }

        .series-score {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .team-record {
            font-size: 0.85rem;
            color: #666;
            font-weight: normal;
            white-space: nowrap;
        }

        .dark-mode .team-record {
            color: #bbb;
        }

        .team.winner .series-score {
            color: var(--winner-color);
        }

        .is-clickable:hover {
            outline: 2px solid gold;
            border-radius: 8px;
            cursor: pointer;
        }

        .final-round {
            justify-content: center;
            align-items: center;
        }

        .finals-champion {
            text-align: center;
        }

        .champion-box {
            background-color: var(--bracket-bg-color);
            border: 2px solid gold;
            padding: 1.25rem;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

            .champion-box .team-logo {
                width: 60px;
                height: 60px;
                margin-bottom: 1rem;
            }

            .champion-box h3 {
                font-size: 1.3rem;
                white-space: nowrap;
            }

            .champion-box h4 {
                font-size: 1.2rem;
                margin-top: 0.5rem;
            }

        @media (max-width: 1140px) {
            .bracket {
                min-width: 1020px;
            }

            .team {
                width: 185px;
            }
        }

        @media (max-width: 768px) {
            .page-header h2 {
                font-size: 1.8rem;
            }

            main {
                padding: 1rem;
            }

            .play-in-section {
                flex-direction: column;
                gap: 1rem;
            }

            .play-in-title {
                font-size: 1.3rem;
            }

            #play-in-summary {
                font-size: 1.2rem;
            }

            .team-name {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <button id="theme-toggle-btn" aria-label="Toggle Theme">
            <span class="sun-icon">☀️</span>
            <span class="moon-icon">🌙</span>
        </button>
        <h1>
            <img src="/icons/RKL.webp" alt="RKL Logo" class="header-logo" onerror="this.style.display='none'">
            <span class="header-text">Real Karma League</span>
        </h1>
        <nav>
            <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">&#9776;</button>
            <ul id="nav-menu">
                <li><a href="RKL-S8.html">S8 Home</a></li>
                <li><a href="standings.html">Standings & Rankings</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0);" class="dropbtn">Stats Hub &#9662;</a>
                    <div class="dropdown-content">
                        <a href="leaderboards.html">Leaderboards</a>
                        <a href="compare.html">Comparison Tool</a>
                    </div>
                </li>
                <li><a href="schedule.html">Schedule</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0);" class="dropbtn">Draft Central &#9662;</a>
                    <div class="dropdown-content">
                        <a href="draft-capital.html">Draft Capital</a>
                        <a href="draft-results.html">Draft Results</a>
                        <a href="draft-lottery.html">Draft Lottery</a>
                    </div>
                </li>
                <li><a href="transactions.html">Transactions</a></li>
                <li><a href="teams.html">Teams</a></li>
                <li><a href="trophy-case.html">Trophy Case</a></li>
                <li><a href="/common/changelog.html">Changelog</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="page-header">
            <h2>Season 8 Playoff Picture</h2>
            <button id="testBracketButton">Run Bracket Advancement Test</button>
            <div id="testResult"></div>
        </div>

        <div id="play-in-container">
            <div id="play-in-section" class="play-in-section">
            </div>
        </div>

        <div class="bracket-container" id="bracket-container">
            <div class="loading">Loading Playoff Bracket...</div>
        </div>
    </main>

    <footer>
        <p>@caustic on Real</p>
        <a href="/common/trade-block.html">GM Portal</a>
    </footer>
    
    <script src="../js/main.js" type="module"></script>
    <script type="module">
        import { db, collection, getDocs, query, where, doc, getDoc } from '/js/firebase-init.js';

        const SEASON_ID = "S8";
        const USE_DEV_COLLECTIONS = false; 
        const getCollectionName = (baseName) => USE_DEV_COLLECTIONS ? `${baseName}_dev` : baseName;

        let allTeamsMap = new Map();
        let seriesMap = new Map();

        async function fetchAllData() {
            const container = document.getElementById('bracket-container');
            try {
                const teamsQuery = query(collection(db, getCollectionName('v2_teams')), where('conference', 'in', ['Eastern', 'Western']));
                const teamsSnap = await getDocs(teamsQuery);
                
                const teamRecordPromises = teamsSnap.docs.map(async (teamDoc) => {
                    try {
                        const teamData = { id: teamDoc.id, ...teamDoc.data() };
                        const teamDocRef = doc(db, getCollectionName('v2_teams'), teamDoc.id);
                        const recordRef = doc(teamDocRef, getCollectionName('seasonal_records'), SEASON_ID);
                        const recordSnap = await getDoc(recordRef);
                        
                        if (recordSnap.exists()) {
                            return {
                                ...teamData,
                                ...recordSnap.data()
                            };
                        }
                        return teamData;
                    } catch (error) {
                        console.error(`!!!!!! FAILED to fetch record for team: ${teamDoc.id} !!!!!!`);
                        console.error("The error was:", error);
                        return { id: teamDoc.id, ...teamDoc.data(), error: true };
                    }
                });
                
                const teamsWithRecords = await Promise.all(teamRecordPromises);
                teamsWithRecords.forEach(team => allTeamsMap.set(team.id, team));

                const seasonDocRef = doc(db, getCollectionName('seasons'), SEASON_ID);

                console.log("--- DEBUGGING PLAYOFF BRACKET ---");
                console.log("Is 'seasonDocRef' a valid object?", seasonDocRef);
                console.log("Collection name being used:", getCollectionName('post_games'));

                const postGamesQuery = collection(seasonDocRef, getCollectionName('post_games')); 
                const postGamesSnap = await getDocs(postGamesQuery);

                postGamesSnap.forEach(doc => {
                    const gameData = doc.data();
                    seriesMap.set(gameData.series_id, gameData);
                });

                return true; 
            } catch (error) {
                console.error("Error fetching Firestore data:", error);
                container.innerHTML = `<div class="error">Could not load playoff data from Firestore.</div>`;
                return false; 
            }
        }


        function getTeam(teamId) {
            if (!teamId || teamId === "TBD") return { id: "TBD", team_name: "TBD" };
            return allTeamsMap.get(teamId) || { id: teamId, team_name: teamId };
        }

        function getSeries(seriesId) {
            return seriesMap.get(seriesId);
        }

        function getSeriesWinner(seriesId) {
            const series = getSeries(seriesId);
            if (!series) return null;
            if (series.week === 'Play-In') return series.winner || null;
            return series.series_winner || null;
        }


        function createTeamHTML(teamId, series, displaySeed, isSeriesWinner) {
            const teamData = getTeam(teamId);
            const isWinner = isSeriesWinner && isSeriesWinner === teamId;
            const isTBD = !teamId || teamId === "TBD";
            const teamHref = isTBD ? 'javascript:void(0);' : `team.html?id=${teamData.id}`;
            const seedToShow = displaySeed || '';
            
            let scoreOrRecordHTML = '';
            const seriesHasStarted = series && (series.team1_wins > 0 || series.team2_wins > 0);

            if (seriesHasStarted) {
                const teamWins = (series.team1_id === teamId) ? series.team1_wins : series.team2_wins;
                scoreOrRecordHTML = `<span class="series-score">${teamWins || 0}</span>`;
            } else if (!isTBD && teamData.wins !== undefined && teamData.losses !== undefined) {
                scoreOrRecordHTML = `<span class="team-record">(${teamData.wins}-${teamData.losses})</span>`;
            }

            return `
                <a href="${teamHref}" class="team ${isWinner ? 'winner' : ''} ${isTBD ? 'tbd' : ''}">
                    <span class="team-seed">${seedToShow}</span>
                    <img src="/icons/${isTBD ? 'RKL' : teamData.id}.webp" alt="${teamData.team_name}" class="team-logo" onerror="this.onerror=null; this.src='/icons/RKL.webp';">
                    <div class="team-info">
                        <span class="team-name">${teamData.team_name}</span>
                        ${scoreOrRecordHTML}
                    </div>
                </a>`;
        }
        
        function createMatchupHTML(seriesId, defaultTeam1Id = 'TBD', defaultTeam2Id = 'TBD') {
            const series = getSeries(seriesId);
            const seriesWinner = getSeriesWinner(seriesId);
            
            const team1Id = series?.team1_id || defaultTeam1Id;
            const team2Id = series?.team2_id || defaultTeam2Id;
            const team1Seed = series?.team1_seed || '';
            const team2Seed = series?.team2_seed || '';

            const isClickable = series && (series.team1_wins > 0 || series.team2_wins > 0 || series.winner);
            const weekLink = isClickable ? `schedule.html#week-${encodeURIComponent(series.week)}` : null;
            const matchupClass = isClickable ? 'matchup is-clickable' : 'matchup';
            const clickHandler = isClickable ? `onclick="window.location.href='${weekLink}'"` : '';

            return `<div class="${matchupClass}" ${clickHandler}>
                        ${createTeamHTML(team1Id, series, team1Seed, seriesWinner)}
                        ${createTeamHTML(team2Id, series, team2Seed, seriesWinner)}
                    </div>`;
        }

        function createPlayInMatchupHTML(label, seriesId, defaultTeam1Id, defaultTeam2Id) {
            const series = getSeries(seriesId);
            const seriesWinner = getSeriesWinner(seriesId);
            
            const team1Id = series?.team1_id || defaultTeam1Id;
            const team2Id = series?.team2_id || defaultTeam2Id;
            const team1Seed = series?.team1_seed || '';
            const team2Seed = series?.team2_seed || '';

            const isClickable = !!seriesWinner;
            const weekLink = isClickable ? `schedule.html#week-Play-In` : null;
            const matchupClass = isClickable ? 'play-in-matchup is-clickable' : 'play-in-matchup';
            const clickHandler = isClickable ? `onclick="window.location.href='${weekLink}'"` : '';

            return `
                <div class="${matchupClass}" ${clickHandler}>
                    <div class="matchup-label">${label}</div>
                    ${createTeamHTML(team1Id, series, team1Seed, seriesWinner)}
                    ${createTeamHTML(team2Id, series, team2Seed, seriesWinner)}
                </div>`;
        }

        function renderPlayInTournament() {
            const playInContainer = document.getElementById('play-in-container');
            const playInSection = document.getElementById('play-in-section');
            const teams = Array.from(allTeamsMap.values());
            
            const westTeams = teams.filter(t => t.conference === 'Western').sort((a, b) => a.postseed - b.postseed);
            const eastTeams = teams.filter(t => t.conference === 'Eastern').sort((a, b) => a.postseed - b.postseed);

            const w7 = westTeams.find(t => t.postseed === 7)?.id;
            const w8 = westTeams.find(t => t.postseed === 8)?.id;
            const w9 = westTeams.find(t => t.postseed === 9)?.id;
            const w10 = westTeams.find(t => t.postseed === 10)?.id;
            
            const e7 = eastTeams.find(t => t.postseed === 7)?.id;
            const e8 = eastTeams.find(t => t.postseed === 8)?.id;
            const e9 = eastTeams.find(t => t.postseed === 9)?.id;
            const e10 = eastTeams.find(t => t.postseed === 10)?.id;

            const westHTML = `
                <div class="play-in-conference">
                    <h3 class="play-in-title">Western Conference Play-In</h3>
                    ${createPlayInMatchupHTML('7th Seed Game', 'W7vW8', w7, w8)}
                    ${createPlayInMatchupHTML('9th/10th Seed Game', 'W9vW10', w9, w10)}
                    ${createPlayInMatchupHTML('8th Seed Game', 'W8thSeedGame')}
                </div>`;
            const eastHTML = `
                 <div class="play-in-conference">
                    <h3 class="play-in-title">Eastern Conference Play-In</h3>
                    ${createPlayInMatchupHTML('7th Seed Game', 'E7vE8', e7, e8)}
                    ${createPlayInMatchupHTML('9th/10th Seed Game', 'E9vE10', e9, e10)}
                    ${createPlayInMatchupHTML('8th Seed Game', 'E8thSeedGame')}
                </div>`;

            playInSection.innerHTML = westHTML + eastHTML;

            const isRoundOneStarted = Array.from(seriesMap.values()).some(s => s.week === 'Round 1' && (s.team1_wins > 0 || s.team2_wins > 0));

            if (isRoundOneStarted) {
                playInContainer.innerHTML = `
                    <details id="play-in-details">
                        <summary id="play-in-summary">Play-In Tournament Results</summary>
                        <div class="play-in-content-wrapper">
                            ${playInSection.outerHTML}
                        </div>
                    </details>`;
            } else {
                playInContainer.innerHTML = playInSection.outerHTML;
            }
        }

        async function renderBracket() {
            const container = document.getElementById('bracket-container');
            const success = await fetchAllData();
            if (!success) return;

            renderPlayInTournament();

            const championId = getSeriesWinner('Finals');

            let bracketHTML = `
                <div class="bracket">
                    <div class="bracket-header-row">
                        <div class="round-title">Round 1<small class="series-format">(Best of 3)</small></div>
                        <div class="round-title">Conference Semis<small class="series-format">(Best of 3)</small></div>
                        <div class="round-title">Conference Finals<small class="series-format">(Best of 5)</small></div>
                        <div class="round-title">RKL Finals<small class="series-format">(Best of 7)</small></div>
                    </div>
                    <div class="bracket-body-row">
                        <div class="round-column">
                            <div class="conference-section">
                                <h3 class="conference-subtitle">West</h3>
                                <div class="conference-group">
                                    <div class="matchup-subgroup">
                                        ${createMatchupHTML('W1vW8')}
                                        ${createMatchupHTML('W4vW5')}
                                    </div>
                                    <div class="matchup-subgroup">
                                        ${createMatchupHTML('W3vW6')}
                                        ${createMatchupHTML('W2vW7')}
                                    </div>
                                </div>
                            </div>
                            <div class="conference-section">
                                <h3 class="conference-subtitle">East</h3>
                                <div class="conference-group">
                                    <div class="matchup-subgroup">
                                        ${createMatchupHTML('E1vE8')}
                                        ${createMatchupHTML('E4vE5')}
                                    </div>
                                    <div class="matchup-subgroup">
                                        ${createMatchupHTML('E3vE6')}
                                        ${createMatchupHTML('E2vE7')}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="round-column">
                            <div class="conference-section">
                                <div class="conference-group">
                                    <div class="matchup-subgroup">${createMatchupHTML('W-R2-T')}</div>
                                    <div class="matchup-subgroup">${createMatchupHTML('W-R2-B')}</div>
                                </div>
                            </div>
                            <div class="conference-section">
                                <div class="conference-group">
                                    <div class="matchup-subgroup">${createMatchupHTML('E-R2-T')}</div>
                                    <div class="matchup-subgroup">${createMatchupHTML('E-R2-B')}</div>
                                </div>
                            </div>
                        </div>

                        <div class="round-column">
                            <div class="conference-section">
                                <div class="conference-group">${createMatchupHTML('WCF')}</div>
                            </div>
                            <div class="conference-section">
                                <div class="conference-group">${createMatchupHTML('ECF')}</div>
                            </div>
                        </div>

                        <div class="round-column final-round">
                            ${championId ? `
                                <div class="finals-champion">
                                    <div class="champion-box is-clickable" onclick="window.location.href='schedule.html#week-Finals'">
                                        <h3>🏆 RKL Champion 🏆</h3>
                                        ${createTeamHTML(championId, getSeries('Finals'), getSeries('Finals')?.team1_id === championId ? getSeries('Finals')?.team1_seed : getSeries('Finals')?.team2_seed, championId)}
                                    </div>
                                </div>
                            ` : `
                                <div class="conference-group">${createMatchupHTML('Finals')}</div>
                            `}
                        </div>
                    </div>
                </div>`;

            container.innerHTML = bracketHTML;
        }

        document.addEventListener('DOMContentLoaded', renderBracket);
        import { httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-functions.js";
        import { functions } from '/js/firebase-init.js'; 

        const testBracketButton = document.getElementById('testBracketButton');
        const testResultDiv = document.getElementById('testResult');

        testBracketButton.addEventListener('click', async () => {
            console.log("Calling 'test_updatePlayoffBracket'...");
            testResultDiv.textContent = 'Running test...';

            const test_updatePlayoffBracket = httpsCallable(functions, 'test_updatePlayoffBracket');

            try {
                const result = await test_updatePlayoffBracket();
                console.log("Function returned:", result.data);
                testResultDiv.textContent = `Success! ${result.data.message}`;
            } catch (error) {
                console.error("Error calling function:", error);
                testResultDiv.textContent = `Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>
