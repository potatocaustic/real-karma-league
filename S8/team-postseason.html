<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">RKL S7 Postseason Profile</title> 
    <link rel="stylesheet" href="../css/global-styles.css" />
    <link rel="icon" href="../rklfavicon.ico" type="image/x-icon" />
    <script>
      // Apply theme from local storage before page loads to prevent flashing
      (function() {
        const theme = localStorage.getItem('theme');
        if (theme === 'dark') {
          document.documentElement.classList.add('dark-mode');
        }
      })();
    </script>
    
    <style id="team-icon-styles"></style>

    <style>
      /* Page-specific styles are largely inherited from team.html but can be tweaked here */
      .team-header-content {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: center;
        transition: background-color 0.3s, box-shadow 0.3s;
      }

      .team-main-info {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .team-logo-large {
        width: 120px;
        height: 120px;
        border-radius: 50% !important;
        border: 3px solid #ddd;
        object-fit: cover;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        transition: border-color 0.3s;
      }

      .team-details h2 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }
      
      .page-main-header {
        text-align: center;
        margin-bottom: 1rem;
        font-size: 2rem;
        font-weight: bold;
      }
      
      .postseason-subtitle {
        font-size: 1.5rem;
        color: #666;
        margin-bottom: 0.75rem;
        font-weight: 500;
        transition: color 0.3s;
      }

      .team-subtitle {
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 0.5rem;
        transition: color 0.3s;
      }

      .gm-info {
        font-size: 1.1rem;
        color: #007bff;
        font-weight: 500;
        transition: color 0.3s;
      }

      .team-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
      }

      .stat-card {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #ddd;
        transition: background-color 0.3s, border-color 0.3s;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #333;
        transition: color 0.3s;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.5rem;
        transition: color 0.3s;
      }
      
      .stat-rank {
        font-size: 0.8rem;
        color: #007bff;
        margin-top: 0.3rem;
        font-weight: 500;
        transition: color 0.3s;
      }
      
      .positive { color: #28a745; }
      .negative { color: #dc3545; }

      .stat-card-link {
          text-decoration: none;
          color: inherit;
          display: block; 
          border-radius: 6px; 
      }

      .stat-card-link .stat-card {
          transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
      }

      .stat-card-link:hover .stat-card {
          transform: translateY(-4px);
          box-shadow: 0 8px 16px rgba(0,0,0,0.12);
      }

      .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
        align-items: start;
      }

      .roster-section {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        height: fit-content;
        transition: background-color 0.3s, box-shadow 0.3s;
      }

      .section-header {
        background-color: #333;
        color: white;
        padding: 1.5rem;
        text-align: center;
      }

      .section-header h3 {
        color: white;
        margin: 0;
        font-size: 1.4rem;
      }

      .roster-list { padding: 0; }

      .roster-header {
        display: grid;
        grid-template-columns: 40px 1fr 80px 80px; 
        gap: 0.5rem; 
        align-items: center;
        padding: 1rem 1rem;
        background-color: #f8f9fa;
        border-bottom: 2px solid #ddd;
        font-weight: bold;
        font-size: 0.9rem;
        color: #666;
        transition: background-color 0.3s, border-color 0.3s, color 0.3s;
      }
      .roster-logo-header-col { /* For spacing */ }
      .roster-header .header-player { text-align: left; padding-left: 0; }
      .roster-header .header-rel, .roster-header .header-war { text-align: center; padding-right: 0; }
      .roster-header .sortable { cursor: pointer; transition: color 0.2s; }
      .roster-header .sortable:hover { color: #007bff; }
      .roster-header .sort-indicator { display: inline-block; margin-left: 5px; width: 1em; }

      .roster-content { padding: 0; }

      .player-item {
        display: grid;
        grid-template-columns: 40px 1fr 80px 80px; 
        gap: 0.5rem; 
        align-items: center;
        padding: 1rem 1rem;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s, border-color 0.3s;
      }
      .roster-player-logo-col {
        display: flex; align-items: center; justify-content: center;
      }
      
      .player-item:hover { background-color: #f8f9fa; }
      .player-item:last-child { border-bottom: none; }
      .player-info { display: flex; flex-direction: column; min-width: 0; padding-left: 0; }
      .player-rel, .player-war { font-weight: bold; font-size: 1.1rem; color: #333; text-align: center; min-width: 80px; padding-right: 0; transition: color 0.3s;}
      .player-name { font-weight: 500; font-size: 1.1rem; color: #007bff; text-decoration: none; cursor: pointer; transition: color 0.3s ease; }
      .player-name:hover { color: #0056b3; text-decoration: underline; }
      .all-star-badge { color: gold; text-shadow: 0 0 2px #a18000; font-size: 1em; margin-left: 5px; vertical-align: middle; }
      .rookie-badge { background-color: #6c757d; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; vertical-align: middle; }
      .player-stats { font-size: 0.9rem; color: #666; margin-top: 0.2rem; transition: color 0.3s;}

      .schedule-section {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        height: fit-content;
        min-height: 600px;
        transition: background-color 0.3s, box-shadow 0.3s;
      }

      .games-list { padding: 1.5rem; max-height: none; overflow-y: visible; }
      .game-item { display: flex; gap: 0; padding: 0; border-bottom: 1px solid #eee; transition: background-color 0.2s; margin-left: 0; position: relative; min-height: 70px; background-color: #fff; border-radius: 4px; margin-bottom: 0.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); transition: all 0.3s; }
      .game-item:hover { background-color: #f8f9fa; }
      .game-item:last-child { border-bottom: none; }
      .game-info-table { display: grid; grid-template-rows: 1fr 1fr; width: 45px; min-width: 45px; max-width: 45px; flex-shrink: 0; border-right: 1px solid #ddd; background-color: #f8f9fa; transition: background-color 0.3s, border-color 0.3s; }
      .week-cell { display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #ddd; padding: 0.5rem; transition: border-color 0.3s;}
      .date-cell { display: flex; align-items: center; justify-content: center; padding: 0.5rem; }
      .game-content-table { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 1rem; flex: 1; background-color: #fff; gap: 1rem; transition: background-color 0.3s; }
      .team-section { display: flex; align-items: center; gap: 0.75rem; min-width: 0; }
      .team-section.left { justify-content: flex-start; }
      .team-section.right { justify-content: flex-end; flex-direction: row-reverse; }
      .team-details { display: flex; flex-direction: column; min-width: 0; flex: 1; }
      .team-details.right { text-align: right; }
      .scores-section { display: flex; align-items: center; gap: 0.75rem; font-weight: bold; font-size: 1.1rem; white-space: nowrap; min-width: 120px; justify-content: center; }
      .score { min-width: 40px; text-align: center; }
      .vs-text { color: #666; font-weight: 500; font-size: 1rem; transition: color 0.3s; }
      .team-name-game { font-weight: 500; font-size: 0.95rem; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .team-record-game { font-size: 0.8rem; color: #666; line-height: 1; margin-top: 0.2rem; white-space: nowrap; transition: color 0.3s; }
      .win { color: #28a745; }
      .loss { color: #333; } 
      .upcoming { color: #333; font-weight: 500; }
      .team-matchup, .team, .team-info, .vs { display: none; }
      .game-matchup .week-badge { display: none; }
      .week-badge { background-color: #007bff; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; border: 1px solid white; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
      .date-badge { font-size: 0.65rem; color: #666; font-weight: 500; transition: color 0.3s; }
      .game-item[onclick] { cursor: pointer; transition: all 0.3s ease; }
      .game-item[onclick]:hover { background-color: #e8f5e8 !important; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
      
      .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto; }
      .modal-content { background-color: #fff; margin: 2rem auto; border-radius: 8px; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3); transition: background-color 0.3s;}
      .modal-header { background-color: #333; color: white; padding: 1.5rem; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
      .modal-header h3 { color: white; margin: 0; font-size: 1.4rem; }
      .close-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 4px; transition: background-color 0.3s; }
      .close-btn:hover { background-color: rgba(255,255,255,0.1); }
      .modal-body { padding: 2rem; }
      .game-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
      .team-breakdown { background-color: #f8f9fa; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; transition: background-color 0.3s, border-color 0.3s; }
      .team-breakdown.winner { border-color: #28a745; border-width: 2px; }
      .modal-team-header { background-color: #333; color: white; padding: 1.5rem; text-align: center; display: flex; align-items: center; justify-content: center; gap: 1rem; flex-direction: column; transition: background-color 0.3s;}
      .modal-team-header.winner { background-color: #28a745; }
      .modal-team-header h4 { color: white; }
      .team-total { background-color: #e9ecef; padding: 1rem; text-align: center; font-weight: bold; font-size: 1.1rem; border-bottom: 2px solid #ddd; transition: background-color 0.3s, border-color 0.3s;}
      .lineup-table { width: 100%; border-collapse: collapse; }
      .lineup-table th { background-color: #f8f9fa; padding: 0.8rem 0.5rem; text-align: center; font-weight: bold; border-bottom: 2px solid #ddd; font-size: 0.9rem; transition: background-color 0.3s, border-color 0.3s;}
      .lineup-table td { padding: 0.8rem 0.5rem; border-bottom: 1px solid #eee; font-size: 0.9rem; text-align: center; transition: border-color 0.3s;}
      .lineup-table th:first-child, .lineup-table td:first-child { text-align: left; }
      .captain-row { background-color: #fff3cd !important; font-weight: bold; }
      .captain-badge { background-color: #ffc107; color: #333; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: bold; margin-left: 0.5rem; }
      .captain-bonus { font-size: 0.75rem; color: #ffc107; font-weight: 500; margin-top: 0.2rem; }
      .player-name-cell { font-weight: 500; }
      .player-link { color: #007bff; text-decoration: none; font-weight: 500; transition: color 0.3s ease; }
      .player-link:hover { color: #0056b3; text-decoration: underline; }
      .points-cell { text-align: center; font-weight: bold; }
      .rank-cell { text-align: center; color: #666; transition: color 0.3s;} 
      
      .back-button { background-color: #007bff; color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 4px; text-decoration: none; font-size: 1rem; display: inline-block; margin-bottom: 2rem; transition: background-color 0.3s;}
      .back-button:hover { background-color: #0056b3; text-decoration: none; color: white; }
      .desktop-only-roster-logo { width: 30px; height: 30px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }

      /* Dark Mode Styles */
      .dark-mode .back-button { background-color: #3b82f6; }
      .dark-mode .back-button:hover { background-color: #60a5fa; }
      .dark-mode .team-header-content, .dark-mode .roster-section, .dark-mode .schedule-section { background-color: #1e1e1e; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
      .dark-mode .team-logo-large { border-color: #444; }
      .dark-mode .team-subtitle, .dark-mode .postseason-subtitle, .dark-mode .stat-label, .dark-mode .player-stats, .dark-mode .team-record-game, .dark-mode .vs-text, .dark-mode .date-badge { color: #aaa; }
      .dark-mode .gm-info, .dark-mode .stat-rank, .dark-mode .player-name { color: #8ab4f8; }
      .dark-mode .stat-card { background-color: #2c2c2c; border-color: #444; }
      .dark-mode .stat-value, .dark-mode .player-rel, .dark-mode .player-war { color: #e0e0e0; }
      .dark-mode .positive { color: #66bb6a; }
      .dark-mode .negative { color: #ef5350; }
      .dark-mode .roster-header { background-color: #2c2c2c; border-bottom-color: #444; color: #bbb; }
      .dark-mode .player-item { border-bottom-color: #333; }
      .dark-mode .player-item:hover { background-color: #2c2c2c; }
      .dark-mode .game-item, .dark-mode .game-content-table { background-color: #1e1e1e; border-bottom-color: #333; }
      .dark-mode .game-item:hover { background-color: #2c2c2c !important; }
      .dark-mode .game-info-table { background-color: #2c2c2c; border-right-color: #444; }
      .dark-mode .week-cell { border-bottom-color: #444; }
      .dark-mode .score.loss { color: #e0e0e0; }
      .dark-mode .team-name.loss, .dark-mode .team-score.loss { color: #ef5350; }
      .dark-mode .team-name.upcoming, .dark-mode .team-score.upcoming { color: #e0e0e0; }
      .dark-mode .modal-content { background-color: #1e1e1e; }
      .dark-mode .close-btn:hover { background-color: rgba(255,255,255,0.2); }
      .dark-mode .team-breakdown { background-color: #2c2c2c; border-color: #444; }
      .dark-mode .team-breakdown.winner { border-color: #66bb6a; }
      .dark-mode .modal-team-header.winner { background-color: #2e7d32; }
      .dark-mode .team-total { background-color: #333; border-bottom-color: #444; }
      .dark-mode .lineup-table th { background-color: #2c2c2c; border-bottom-color: #444; }
      .dark-mode .lineup-table td { border-color: #333; }
      .dark-mode .lineup-table tr:hover { background-color: #383838; }
      .dark-mode .captain-row { background-color: #4a4100 !important; }
      .dark-mode .player-link { color: #8ab4f8; }
      .dark-mode .player-link:hover { color: #a7c7fa; }
      .dark-mode .rank-cell { color: #aaa; }

      /* Responsive Styles */
      @media (max-width: 768px) {
        .content-grid { grid-template-columns: 1fr; }
        .team-main-info { flex-direction: column; gap: 1rem; }
        .team-logo-large { width: 80px; height: 80px; }
        .team-stats-grid { grid-template-columns: repeat(2, 1fr); }
        .player-item { padding: 0.75rem; grid-template-columns: 1fr 80px !important; }
        .roster-header { grid-template-columns: 1fr 80px !important; }
        .desktop-only-roster-logo, .header-war, .player-war { display: none; } 
        
        .game-item { padding: 0.75rem; margin-left: 0; position: relative; display: block; }
        .game-item .game-matchup { display: flex !important; } 
        .game-item .game-info-table, .game-item .game-content-table { display: none !important; }
        .game-matchup .week-badge { display: flex !important; position: absolute; top: 0.75rem; right: 0.75rem; left: auto; transform: none; width: 28px; height: 28px; font-size: 0.8rem; z-index: 2; background-color: #007bff; color: white; border-radius: 50%; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .game-matchup { display: flex; flex-direction: column; gap: 0.75rem; align-items: stretch; margin-top: 0; padding-right: 35px; }
        .team { display: flex; align-items: center; gap: 0.5rem; min-width: auto; width: 100%; }
        .team-info { display: flex; flex-direction: column; min-width: 0; flex: 1; }
        .team-name { font-weight: 500; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .team-name.win { color: #28a745; } .team-name.loss { color: #dc3545; }
        .team-record { font-size: 0.8rem; color: #666; }
        .team-score { font-weight: bold; color: #333; margin-left: auto; min-width: 35px; text-align: right; flex-shrink: 0; }
        .team-score.win { color: #28a745; } .team-score.loss { color: #dc3545; } .team-score.upcoming { color: #333; }
        .vs { display: none; }
        
        .modal-content { margin: 1rem; width: calc(100% - 2rem); }
        .modal-body { padding: 1rem; }
        .modal-header h3 { font-size: 1.1rem; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; min-width: 0; }
        .game-details-grid { grid-template-columns: 1fr !important; gap: 1rem !important; }
      }

      @media (max-width: 480px) {
        .team-stats-grid { grid-template-columns: 1fr; }
        .player-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
        .player-rel { align-self: flex-end; }
        .modal-header h3 { font-size: 1.0rem; }
      }
    </style>
  </head>
  <body>
    <header>
        <button id="theme-toggle-btn" aria-label="Toggle Theme">
            <span class="sun-icon">☀️</span>
            <span class="moon-icon">🌙</span>
        </button>
        <h1>
            <a href="/index.html" class="header-link">
                <img src="/icons/RKL.webp" alt="RKL Logo" class="header-logo" onerror="this.style.display='none'">
                <span class="header-text">Real Karma League</span>
            </a>
        </h1>
        <nav>
            <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">&#9776;</button>
            <ul id="nav-menu">
                <li class="dropdown">
                    <a href="RKL-S8.html" class="dropbtn">S8 Home &#9662;</a>
                    <div class="dropdown-content">
                        <a href="/S8/RKL-S8.html">S8 Home</a>
                        <a href="/S7/RKL-S7.html">S7 Home</a>
                    </div>
                </li>
                <li><a href="standings.html">Standings & Rankings</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0);" class="dropbtn">Stats Hub &#9662;</a>
                    <div class="dropdown-content">
                        <a href="leaderboards.html">Leaderboards</a>
                        <a href="compare.html">Comparison Tool</a>
                    </div>
                </li>
                <li><a href="schedule.html">Schedule</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0);" class="dropbtn">Draft Central &#9662;</a>
                    <div class="dropdown-content">
                        <a href="draft_capital.html">Draft Capital</a>
                        <a href="draft_results.html">Draft Results</a>
                        <a href="draft_lottery.html">Draft Lottery</a>
                    </div>
                </li>
                <li><a href="transactions.html">Transactions</a></li>
                <li><a href="teams.html">Teams</a></li>
                <li><a href="trophy-case.html">Trophy Case</a></li>
                <li><a href="/common/changelog.html">Changelog</a></li>
            </ul>
        </nav>
    </header>
    
    <main>
      <div id="navigation-buttons">
          <a href="team.html" id="reg-season-profile-btn" class="back-button" style="display: none;">View Regular Season Profile →</a>
      </div>

      <div class="team-header-content"> 
        <div class="team-main-info" id="team-main-info">
          <div class="loading">Loading team information...</div>
        </div>
        
        <div class="team-stats-grid" id="team-stats" style="display: none;">
        </div>
      </div>

      <div class="content-grid">
        <div class="roster-section">
          <div class="section-header">
            <h3>Postseason Roster</h3>
          </div>
          <div class="roster-list" id="roster-list">
            <div class="loading">Loading roster...</div>
          </div>
        </div>

        <div class="schedule-section">
          <div class="section-header">
            <h3>Postseason Schedule</h3>
          </div>
          <div class="games-list" id="team-schedule">
            <div class="loading">Loading schedule...</div>
          </div>
        </div>
      </div>

    </main>

    <div id="game-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modal-title">Game Details</h3>
          <button class="close-btn" onclick="closeGameModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div id="modal-content">
            <div class="loading">Loading game details...</div>
          </div>
        </div>
      </div>
    </div>
    
    <footer>
      <p>@caustic on Real</p>
      <a href="trade-block.html">GM Portal</a>
    </footer>

    <script type="module" src="/js/firebase-init.js"></script>
    <script type="module" src="/js/main.js"></script>

    <script type="module">
      // Correctly import all necessary services and functions from your centralized init file
      import { 
          auth, 
          db, 
          onAuthStateChanged,
          collection,
          getDocs,
          query,
          where
      } from '/js/firebase-init.js';

      document.addEventListener('DOMContentLoaded', () => {
        let teamId = null;
        let teamData = null;
        let allTeams = [];
        let allPostseasonScheduleData = [];
        let allPlayersData = [];
        let rosterSortState = { column: 'rel', direction: 'desc' };
        
        // --- All helper functions (like generateIconStylesheet, normalizeDate, etc.) remain unchanged ---
        function generateIconStylesheet(allTeams) {
            const iconStyles = allTeams.map(team => {
                if (!team.team_id) return '';
                const className = `icon-${team.team_id.replace(/[^a-zA-Z0-9]/g, '')}`; 
                return `
                    .${className} {
                        background-image: url('icons/${team.team_id}.webp');
                    }
                `;
            }).join('');

            const styleElement = document.getElementById('team-icon-styles');
            if (styleElement) {
                styleElement.innerHTML = `
                    .team-logo-css {
                        width: 24px;
                        height: 24px;
                        background-size: cover;
                        background-position: center;
                        background-repeat: no-repeat;
                        display: inline-block;
                        vertical-align: middle;
                        flex-shrink: 0;
                        border-radius: 4px;
                    }
                    ${iconStyles}
                `;
            }
        }

        function normalizeDate(dateInput) {
            if (!dateInput) return '';
            let date;
            if (typeof dateInput.toDate === 'function') {
                date = dateInput.toDate();
            } 
            else {
                let dateString = String(dateInput);
                if (dateString.includes('T')) {
                    date = new Date(dateString);
                } else if (dateString.includes('-')) {
                    date = new Date(dateString + 'T00:00:00Z');
                } else if (dateString.includes('/')) {
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        date = new Date(Date.UTC(parts[2], parts[0] - 1, parts[1]));
                    } else {
                        return '';
                    }
                } else {
                    date = new Date(dateString);
                }
            }
            if (isNaN(date.getTime())) return '';
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function formatInThousands(value) {
          const num = parseFloat(value);
          if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'k';
          }
          return Math.round(num).toLocaleString();
        }

        function formatDateMMDD(dateString) {
          const date = new Date(dateString + 'T00:00:00Z');
          const month = String(date.getUTCMonth() + 1).padStart(2, '0');
          const day = String(date.getUTCDate()).padStart(2, '0');
          return `${month}-${day}`;
        }

        function formatDateShort(dateString) {
          const date = new Date(dateString + 'T00:00:00Z');
          const month = String(date.getUTCMonth() + 1).padStart(2, '0');
          const day = String(date.getUTCDate()).padStart(2, '0');
          const year = String(date.getUTCFullYear()).slice(-2);
          return `${month}/${day}/${year}`;
        }
        
        function parseNumber(value) {
          if (value === null || typeof value === 'undefined' || String(value).trim() === '') return 0;
          const cleaned = value.toString().replace(/,/g, '');
          const parsed = parseFloat(cleaned);
          return isNaN(parsed) ? 0 : parsed;
        }

        function escapeHTML(str) {
          if (typeof str !== 'string') return str; 
          return str.replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
        }
        
        function getUrlParameter(name) {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get(name);
        }
        
        function getTeamName(teamIdToFind) { 
          const team = allTeams.find(t => t.team_id === teamIdToFind);
          return team ? team.team_name : teamIdToFind;
        }
        
        function getTeamRecordAtDate(teamIdForRecord, targetDate, schedule) { 
          const normalizedTargetDate = normalizeDate(targetDate);
          const completedGames = schedule.filter(game => {
            const normalizedGameDate = normalizeDate(game.date);
            return normalizedGameDate && normalizedGameDate <= normalizedTargetDate && 
                  game.completed === 'TRUE' && 
                  (game.team1_id === teamIdForRecord || game.team2_id === teamIdForRecord);
          });
          
          let wins = 0;
          let losses = 0;
          
          completedGames.forEach(game => {
            const winner = game.winner;
            if (winner === teamIdForRecord) {
              wins++;
            } else if (winner && (game.team1_id === teamIdForRecord || game.team2_id === teamIdForRecord)) {
              losses++;
            }
          });
          
          return `${wins}-${losses}`;
        }

        function getWeekAbbreviation(weekName) {
            if (!weekName) return 'TBD';
            const lowerCaseWeek = weekName.toLowerCase();
            if (lowerCaseWeek.includes('play-in')) return 'P';
            if (lowerCaseWeek.includes('round 1')) return '1';
            if (lowerCaseWeek.includes('round 2')) return '2';
            if (lowerCaseWeek.includes('conf finals')) return '3';
            if (lowerCaseWeek.includes('finals')) return 'F';
            return weekName.charAt(0);
        }

        window.handleRosterSort = (column) => {
          if (rosterSortState.column === column) {
              rosterSortState.direction = rosterSortState.direction === 'desc' ? 'asc' : 'desc';
          } else {
              rosterSortState.column = column;
              rosterSortState.direction = 'desc';
          }
          loadRoster();
        }
        
        // --- Data display functions (like displayTeamHeader) remain unchanged ---
        function displayTeamHeader() {
              document.getElementById('page-title').textContent = `${escapeHTML(teamData.team_name)} - Postseason Profile`;
              const regSeasonBtn = document.getElementById('reg-season-profile-btn');
              regSeasonBtn.href = `team.html?id=${teamId}`;
              regSeasonBtn.style.display = 'inline-block';


              const wins = parseInt(teamData.post_wins || 0);
              const losses = parseInt(teamData.post_losses || 0);
              const pam = parseFloat(teamData.post_pam || 0);
              
              const teamIdClassName = `icon-${teamData.team_id.replace(/[^a-zA-Z0-9]/g, '')}`;

              document.getElementById('team-main-info').innerHTML = `
                <div style="display: flex; align-items: center; gap: 1.5rem;">
                  <div class="team-logo-css team-logo-large ${teamIdClassName}" role="img" aria-label="${escapeHTML(teamData.team_name)}"></div>
                  <div class="team-details">
                    <h2>${escapeHTML(teamData.team_name)}</h2>
                    <div class="postseason-subtitle">Postseason</div>
                    <div class="team-subtitle">${escapeHTML(teamData.team_id)} • ${escapeHTML(teamData.conference)} Conference</div>
                    <div class="gm-info">General Manager: ${escapeHTML(teamData.current_gm_handle)}</div>
                  </div>
                </div>
              `;
              
              const medRank = parseFloat(teamData.post_med_starter_rank || 0); 
              const teamStatsContainer = document.getElementById('team-stats');
              teamStatsContainer.innerHTML = ''; 

              const recordCard = `<div class="stat-card"><div class="stat-value ${wins > losses ? 'positive' : losses > wins ? 'negative' : ''}">${wins}-${losses}</div><div class="stat-label">Postseason Record</div><div class="stat-rank" style="height:1em;">&nbsp;</div></div>`;
              teamStatsContainer.innerHTML += recordCard;
              
              const pamCard = `<div class="stat-card"><div class="stat-value ${pam > 0 ? 'positive' : pam < 0 ? 'negative' : ''}">${Math.round(pam).toLocaleString()}</div><div class="stat-label">Postseason PAM</div><div class="stat-rank" style="height:1em;">&nbsp;</div></div>`;
              teamStatsContainer.innerHTML += pamCard;

              const medRankCard = `<div class="stat-card"><div class="stat-value">${Math.round(medRank)}</div><div class="stat-label">Postseason Median Starter Rank</div><div class="stat-rank" style="height:1em;">&nbsp;</div></div>`;
              teamStatsContainer.innerHTML += medRankCard;

              teamStatsContainer.style.display = 'grid';
        }
        
        async function loadRoster() {
          const teamPlayers = allPlayersData
            .filter(player => player.current_team_id === teamId && player.player_status === 'ACTIVE');
          
          if (teamPlayers.length === 0) {
            document.getElementById('roster-list').innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No active players found</div>';
            return;
          }
          
          teamPlayers.sort((a, b) => {
              let valA, valB;
              if (rosterSortState.column === 'rel') {
                  valA = parseFloat(a.post_rel_median || 0);
                  valB = parseFloat(b.post_rel_median || 0);
              } else if (rosterSortState.column === 'war') {
                  valA = parseFloat(a.post_WAR || 0);
                  valB = parseFloat(b.post_WAR || 0);
              }
              const comparison = valA < valB ? -1 : (valA > valB ? 1 : 0);
              return rosterSortState.direction === 'desc' ? -comparison : comparison;
          });
          
          const teamIdClassName = `icon-${teamData.team_id.replace(/[^a-zA-Z0-9]/g, '')}`;
          const rosterHTML = teamPlayers.map(player => {
            const relMedian = parseFloat(player.post_rel_median || 0);
            const gamesPlayed = parseInt(player.post_games_played || 0);
            const isAllStar = player.all_star === '1';
            const isRookie = player.rookie === '1';
            const war = parseFloat(player.post_WAR || 0).toFixed(2);
            
            let medianRankDisplay = '-';
            const medianRank = parseInt(player.post_medrank || 0);
            if (medianRank > 0) {
                medianRankDisplay = medianRank;
            }
            const rookieBadge = isRookie ? ` <span class="rookie-badge">R</span>` : '';
            
            return `
              <div class="player-item">
                <div class="roster-player-logo-col desktop-only-roster-logo">
                  <div class="team-logo-css ${teamIdClassName}" style="width: 24px; height: 24px;"></div>
                </div>
                <div class="player-info">
                  <a href="player.html?player=${encodeURIComponent(player.player_handle)}" class="player-name">${escapeHTML(player.player_handle)}${rookieBadge}${isAllStar ? ' <span class="all-star-badge">★</span>' : ''}</a>
                  <div class="player-stats">${gamesPlayed} games • ${medianRankDisplay} med rank</div>
                </div>
                <div class="player-rel">${relMedian.toFixed(3)}</div>
                <div class="player-war">${war}</div>
              </div>`;
          }).join('');
          
          const relSortIndicator = rosterSortState.column === 'rel' ? (rosterSortState.direction === 'desc' ? ' ▼' : ' ▲') : '';
          const warSortIndicator = rosterSortState.column === 'war' ? (rosterSortState.direction === 'desc' ? ' ▼' : ' ▲') : '';

          const finalHTML = `
            <div class="roster-header">
              <span class="roster-logo-header-col desktop-only-roster-logo"></span>
              <span class="header-player">Player</span>
              <span class="header-rel sortable" onclick="handleRosterSort('rel')">REL Median<span class="sort-indicator">${relSortIndicator}</span></span>
              <span class="header-war sortable" onclick="handleRosterSort('war')">WAR<span class="sort-indicator">${warSortIndicator}</span></span>
            </div>
            <div class="roster-content">${rosterHTML}</div>`;
          
          document.getElementById('roster-list').innerHTML = finalHTML;
        }
        
        async function loadSchedule() {
          if (!allPostseasonScheduleData) {
            document.getElementById('team-schedule').innerHTML = '<div class="error">Error loading postseason schedule data</div>';
            return;
          }
          
          const teamGames = allPostseasonScheduleData
              .filter(game => game.team1_id === teamId || game.team2_id === teamId)
              .sort((a, b) => new Date(normalizeDate(a.date)) - new Date(normalizeDate(b.date)));

          
          if (teamGames.length === 0) {
            document.getElementById('team-schedule').innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No postseason games scheduled</div>';
            return;
          }
          
          const teamIdClassName = `icon-${teamId.replace(/[^a-zA-Z0-9]/g, '')}`;
          const gamesHTML = teamGames.map(game => {
            const isTeam1 = game.team1_id === teamId;
            const opponentId = isTeam1 ? game.team2_id : game.team1_id;
            const opponentName = getTeamName(opponentId);
            const isCompleted = game.completed === 'TRUE';
            const gameWeek = getWeekAbbreviation(game.week);
            const gameDateFormatted = formatDateMMDD(normalizeDate(game.date)); 
            
            let opponentRecord = getTeamRecordAtDate(opponentId, game.date, allPostseasonScheduleData);
            let teamRecord = getTeamRecordAtDate(teamId, game.date, allPostseasonScheduleData);
            
            let clickHandler = '', teamScoreText = '', oppScoreText = '', teamScoreClass = '', oppScoreClass = '', teamWon = false, oppWon = false, logoClickHandlers = '';
            
            if (isCompleted) {
              const teamScoreValue = parseFloat(isTeam1 ? game.team1_score : game.team2_score);
              const oppScoreValue = parseFloat(isTeam1 ? game.team2_score : game.team1_score);
              teamWon = teamScoreValue > oppScoreValue;
              oppWon = oppScoreValue > teamScoreValue;
              teamScoreText = formatInThousands(teamScoreValue);
              oppScoreText = formatInThousands(oppScoreValue);
              teamScoreClass = teamWon ? 'win' : 'loss';
              oppScoreClass = oppWon ? 'win' : 'loss';
              const normalizedDateForHandler = normalizeDate(game.date);
              clickHandler = `onclick="showGameDetails('${game.team1_id}', '${game.team2_id}', '${normalizedDateForHandler}')" style="cursor: pointer;"`;
            } else {
              teamScoreText = '-'; oppScoreText = '-'; teamScoreClass = 'upcoming'; oppScoreClass = 'upcoming';
              logoClickHandlers = `onclick="window.location.href='team-postseason.html?id=${opponentId}'" style="cursor: pointer;"`;
            }

            const opponentIdClassName = `icon-${opponentId.replace(/[^a-zA-Z0-9]/g, '')}`;
            
            return `
              <div class="game-item" ${clickHandler}>
                <div class="game-info-table"><div class="week-cell"><div class="week-badge">${gameWeek}</div></div><div class="date-cell"><div class="date-badge">${gameDateFormatted}</div></div></div>
                <div class="game-content-table">
                  <div class="team-section left">
                    <div class="team-logo-css ${teamIdClassName}" style="width: 32px; height: 32px; border-radius: 50%;"></div>
                    <div class="team-details"><div class="team-name-game">${escapeHTML(teamData.team_name)}</div><div class="team-record-game">${teamRecord}</div></div>
                  </div>
                  <div class="scores-section"><div class="score ${teamScoreClass}">${teamScoreText}</div><div class="vs-text">vs</div><div class="score ${oppScoreClass}">${oppScoreText}</div></div>
                  <div class="team-section right">
                    <div class="team-logo-css ${opponentIdClassName}" style="width: 32px; height: 32px; border-radius: 50%;" ${logoClickHandlers}></div>
                    <div class="team-details right"><div class="team-name-game">${escapeHTML(opponentName)}</div><div class="team-record-game">${opponentRecord}</div></div>
                  </div>
                </div>
                <div class="game-matchup"> 
                  <div class="week-badge">${gameWeek}</div> 
                  <div class="team ${teamWon ? 'winner' : oppWon ? 'loser' : 'upcoming'}">
                    <div class="team-logo-css ${teamIdClassName}" style="width: 32px; height: 32px;"></div>
                    <div class="team-info"><span class="team-name ${teamWon ? 'win' : oppWon ? 'loss' : 'upcoming'}">${escapeHTML(teamData.team_name)}</span><span class="team-record">${teamRecord}</span></div><span class="team-score ${teamScoreClass}">${teamScoreText}</span>
                  </div>
                  <span class="vs">vs</span>
                  <div class="team ${oppWon ? 'winner' : teamWon ? 'loser' : 'upcoming'}">
                    <div class="team-logo-css ${opponentIdClassName}" style="width: 32px; height: 32px;" ${logoClickHandlers}></div>
                    <div class="team-info"><span class="team-name ${oppWon ? 'win' : teamWon ? 'loss' : 'upcoming'}">${escapeHTML(opponentName)}</span><span class="team-record">${opponentRecord}</span></div><span class="team-score ${oppScoreClass}">${oppScoreText}</span>
                  </div>
                </div>
              </div>`;
          }).join('');
          document.getElementById('team-schedule').innerHTML = gamesHTML;
        }
        
        window.showGameDetails = async (team1Id, team2Id, date) => {
          const modal = document.getElementById('game-modal');
          const modalTitle = document.getElementById('modal-title');
          const modalContentEl = document.getElementById('modal-content'); 
          
          modal.style.display = 'block';
          modalTitle.textContent = `${escapeHTML(getTeamName(team1Id))} vs ${escapeHTML(getTeamName(team2Id))} - ${formatDateShort(date)}`;
          modalContentEl.innerHTML = '<div class="loading">Loading game details...</div>';
          
          const game = allPostseasonScheduleData.find(g => g.team1_id === team1Id && g.team2_id === team2Id && normalizeDate(g.date) === date);
          if (!game) { modalContentEl.innerHTML = '<div class="error">Game not found</div>'; return; }
          
          const lineupsData = await fetchCollection('post_lineups');
          if (!lineupsData) { modalContentEl.innerHTML = '<div class="error">Error loading lineup data</div>'; return; }
          
          const team1Lineups = lineupsData.filter(l => l.team_id === team1Id && normalizeDate(l.date) === date && l.started === 'TRUE').sort((a,b) => (b.captain === 'TRUE' ? 1 : 0) - (a.captain === 'TRUE' ? 1 : 0) || parseNumber(b.points_final) - parseNumber(a.points_final));
          const team2Lineups = lineupsData.filter(l => l.team_id === team2Id && normalizeDate(l.date) === date && l.started === 'TRUE').sort((a,b) => (b.captain === 'TRUE' ? 1 : 0) - (a.captain === 'TRUE' ? 1 : 0) || parseNumber(b.points_final) - parseNumber(a.points_final));
          
          const team1Total = team1Lineups.reduce((sum, p) => sum + parseNumber(p.points_final), 0);
          const team2Total = team2Lineups.reduce((sum, p) => sum + parseNumber(p.points_final), 0);
          
          const generateLineupTable = (lineupsForTable, idOfTeam, total, isWinner) => { 
            const teamDetailsForModal = allTeams.find(t => t.team_id === idOfTeam); 
            const teamRecord = teamDetailsForModal ? `${teamDetailsForModal.post_wins || 0}-${teamDetailsForModal.post_losses || 0}` : '';
            const teamIdClassName = `icon-${idOfTeam.replace(/[^a-zA-Z0-9]/g, '')}`;

            if (lineupsForTable.length === 0) return `<div class="team-breakdown ${isWinner ? 'winner' : ''}"><div class="modal-team-header ${isWinner ? 'winner' : ''}" onclick="window.location.href='team-postseason.html?id=${idOfTeam}'" style="cursor: pointer;"><div class="team-logo-css ${teamIdClassName}" style="width: 48px; height: 48px;"></div><div><h4>${escapeHTML(getTeamName(idOfTeam))}</h4><div style="font-size: 0.9rem; opacity: 0.9;">${teamRecord}</div></div></div><div class="team-total">Total: ${Math.round(total).toLocaleString()}</div><div style="padding: 2rem; text-align: center; color: #666;">No lineup data available</div></div>`;
            
            const lineupRows = lineupsForTable.map(player => {
              const isCaptain = player.captain === 'TRUE';
              const pointsRaw = parseNumber(player.points_raw);
              const globalRank = parseNumber(player.global_rank);
              const captainBonus = isCaptain ? Math.round(pointsRaw * 0.5) : 0;
              const fullPlayerData = allPlayersData.find(p => p.player_handle === player.player_handle);
              const allStarBadge = fullPlayerData && fullPlayerData.all_star === '1' ? '<span class="all-star-badge">★</span>' : '';
              const rookieBadge = fullPlayerData && fullPlayerData.rookie === '1' ? '<span class="rookie-badge">R</span>' : '';

              return `<tr class="${isCaptain ? 'captain-row' : ''}"><td class="player-name-cell"><a href="player.html?player=${encodeURIComponent(player.player_handle || 'Unknown')}" class="player-link">${escapeHTML(player.player_handle || 'Unknown')}</a>${rookieBadge}${allStarBadge}${isCaptain ? '<span class="captain-badge">C</span>' : ''}</td><td class="points-cell">${Math.round(pointsRaw).toLocaleString()}${isCaptain ? `<div class="captain-bonus">+${captainBonus.toLocaleString()}</div>` : ''}</td><td class="rank-cell">${globalRank > 0 ? Math.round(globalRank) : '-'}</td></tr>`;
            }).join('');
            
            return `<div class="team-breakdown ${isWinner ? 'winner' : ''}"><div class="modal-team-header ${isWinner ? 'winner' : ''}" onclick="window.location.href='team-postseason.html?id=${idOfTeam}'" style="cursor: pointer;"><div class="team-logo-css ${teamIdClassName}" style="width: 48px; height: 48px;"></div><div><h4>${escapeHTML(getTeamName(idOfTeam))}</h4><div style="font-size: 0.9rem; opacity: 0.9;">${teamRecord}</div></div></div><div class="team-total">Total: ${isNaN(total) ? '-' : Math.round(total).toLocaleString()}</div><table class="lineup-table"><thead><tr><th>Player</th><th>Points</th><th>Rank</th></tr></thead><tbody>${lineupRows}</tbody></table></div>`;
          };
          
          modalContentEl.innerHTML = `<div class="game-details-grid">${generateLineupTable(team1Lineups, team1Id, team1Total, game.winner === team1Id)}${generateLineupTable(team2Lineups, team2Id, team2Total, game.winner === team2Id)}</div>`;
        }
        
        window.closeGameModal = () => {
          document.getElementById('game-modal').style.display = 'none';
        }
        
        window.onclick = (event) => {
          if (event.target === document.getElementById('game-modal')) window.closeGameModal();
        }
        
        // MODIFIED: Use modular syntax for fetching data
        async function fetchCollection(collectionName) {
          try {
              const collectionRef = collection(db, collectionName);
              const snapshot = await getDocs(collectionRef);
              return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          } catch (error) {
              console.error(`Error fetching ${collectionName}:`, error);
              return [];
          }
        }

        // MODIFIED: Use modular syntax for fetching data
        async function fetchFilteredCollection(collectionName, field, operator, value) {
            try {
                const q = query(collection(db, collectionName), where(field, operator, value));
                const snapshot = await getDocs(q);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error(`Error fetching filtered ${collectionName}:`, error);
                return [];
            }
        }
        
        async function loadTeamData() {
          try {
              teamId = getUrlParameter('id');
              if (!teamId) {
                document.getElementById('team-main-info').innerHTML = '<div class="error">No team specified in URL.</div>';
                return;
              }

              const teamsPromise = fetchCollection('teams');
              const postSchedulePromise = fetchCollection('post_schedule');
              const playersPromise = fetchFilteredCollection('players', 'current_team_id', '==', teamId);
              
              const [
                teamsResult, 
                playersResult, 
                postScheduleResult, 
              ] = await Promise.all([
                teamsPromise, 
                playersPromise,
                postSchedulePromise, 
              ]);
              
              allTeams = teamsResult;
              generateIconStylesheet(allTeams);

              allPostseasonScheduleData = postScheduleResult;
              allPlayersData = playersResult;
              teamData = allTeams.find(team => team.team_id === teamId);

              if (!teamData) {
                document.getElementById('team-main-info').innerHTML = '<div class="error">Team not found for ID: ' + escapeHTML(teamId) + '</div>';
                return;
              }
              
              displayTeamHeader(); 
              
              await Promise.all([
                loadRoster(),
                loadSchedule(),
              ]);
          } catch (error) {
              console.error("A critical error occurred during data loading:", error);
              document.querySelector('main').innerHTML = `<div class="error">A critical error occurred while loading the page. Please check the console for details.</div>` + document.querySelector('main').innerHTML;
          }
        }

        let hasLoaded = false;

        // MODIFIED: Use modular onAuthStateChanged
        onAuthStateChanged(auth, user => {
            if (!hasLoaded) {
                hasLoaded = true;
                loadTeamData();
            }
        });
      });
    </script>
  </body>
</html>
