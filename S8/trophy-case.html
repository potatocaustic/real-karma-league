<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RKL Season 8 Trophy Case</title>
    <link rel="stylesheet" href="../css/global-styles.css" />
    <link rel="icon" href="../rklfavicon.ico" type="image/x-icon" />
    <script>
        // Apply theme from local storage before page loads to prevent flashing
        (function () {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    <style>
        /* Page-specific styles for trophy-case.html */
        .awards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .award-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .award-card h3 {
            color: #0056b3;
            font-size: 1.4rem;
            margin-bottom: 1rem;
            transition: color 0.3s;
        }

        .award-winner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .winner-logo {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ddd;
            transition: border-color 0.3s;
        }

        .winner-info {
            text-align: left;
        }

        .winner-name {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .winner-name a {
            text-decoration: none;
            color: #333;
            transition: color 0.3s;
        }

        .winner-name a:hover {
            color: #007bff;
            text-decoration: underline;
        }

        .winner-detail {
            font-size: 0.9rem;
            color: #666;
            transition: color 0.3s;
        }

        .winner-detail a {
            color: #666;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.3s;
        }

        .winner-detail a:hover {
            text-decoration: underline;
        }

        .winner-detail .detail-positive {
            font-weight: bold;
            color: #28a745;
        }

        .winner-stats {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 0.5rem;
            transition: border-color 0.3s;
        }

        .winner-stats a, .winner-stats span {
            color: #28a745;
            font-weight: bold;
            text-decoration: none;
            transition: color 0.3s;
        }

        .winner-stats a:hover {
            color: #155724;
            text-decoration: underline;
        }

        /* Style for negative stats, like LVP */
        .winner-stats .detail-negative {
            color: #d9534f; /* Readable red color */
        }

        .all-stars-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2.5rem;
        }

        .all-star-team {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .all-star-header {
            background-color: #333;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .all-star-header h3 {
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-size: 1.5rem;
        }

        .all-star-header .header-icon {
            height: 48px;
            width: 48px;
        }

        .all-star-list-header {
            display: grid;
            grid-template-columns: auto 1fr 65px 65px; /* Icon, Player, REL, MedRank */
            gap: 1rem;
            padding: 0.5rem 1rem;
            background-color: #f8f9fa;
            border-bottom: 2px solid #ddd;
            font-weight: bold;
            font-size: 0.9rem;
            color: #666;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }

        .all-star-list-header .player-col-header {
            text-align: left;
            grid-column: 2;
        }

        .all-star-list-header .stat-col-header {
            text-align: center;
        }

        .all-star-list {
            list-style: none;
            padding: 0;
        }

        .all-star-item {
            display: grid;
            grid-template-columns: auto 1fr 65px 65px; /* Icon, Player, REL, MedRank */
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s, border-color 0.3s;
        }

        .all-star-item:hover {
            background-color: #f8f9fa;
        }

        .all-star-item:last-child {
            border-bottom: none;
        }

        .all-star-player-info {
            display: flex;
            flex-direction: column;
        }

        .all-star-player-info a {
            text-decoration: none;
            color: #007bff;
            font-weight: 500;
            font-size: 1.1rem;
            transition: color 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .all-star-player-info a:hover {
            text-decoration: underline;
        }
        .all-star-stats {
            font-size: 0.85rem;
            color: #666;
            transition: color 0.3s;
        }

        .all-star-stat {
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        /* Dark Mode Styles */
        .dark-mode .award-card, .dark-mode .all-star-team {
            background-color: #1e1e1e;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .dark-mode .award-card h3 {
            color: #8ab4f8;
        }

        .dark-mode .winner-logo {
            border-color: #444;
        }

        .dark-mode .winner-name a {
            color: #e0e0e0;
        }

        .dark-mode .winner-name a:hover {
            color: #8ab4f8;
        }

        .dark-mode .winner-detail, .dark-mode .winner-detail a {
            color: #aaa;
        }

        .dark-mode .winner-stats {
            border-top-color: #333;
        }

        .dark-mode .winner-stats a, .dark-mode .winner-stats span {
            color: #66bb6a;
        }

        .dark-mode .winner-stats a:hover {
            color: #81c784;
        }

        .dark-mode .winner-stats .detail-negative {
            color: #f87171;
        }

        .dark-mode .all-star-list-header {
            background-color: #2c2c2c;
            border-bottom-color: #444;
            color: #bbb;
        }

        .dark-mode .all-star-item {
            border-bottom-color: #333;
        }

        .dark-mode .all-star-item:hover {
            background-color: #2c2c2c;
        }

        .dark-mode .all-star-player-info a {
            color: #8ab4f8;
        }

        .dark-mode .all-star-stats {
            color: #aaa;
        }
        
        @media (max-width: 768px) {
            .all-stars-container {
                grid-template-columns: 1fr;
            }

            .all-star-list-header {
                grid-template-columns: auto 1fr auto auto; 
            }

            .all-star-item {
                grid-template-columns: auto 1fr auto auto;
            }

            .all-star-list-header .stat-col-header, .all-star-stat {
                text-align: right; 
            }
        }
    </style>
    <style>
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);overflow-y:auto}.modal-content{background-color:#fff;margin:2rem auto;border-radius:8px;width:95%;max-width:900px;max-height:90vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,.3);transition:background-color .3s}.modal-header{background-color:#333;color:#fff;padding:1.5rem;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center}.modal-header h3{color:#fff;margin:0;font-size:1.4rem}.close-btn{background:0 0;border:none;color:#fff;font-size:1.5rem;cursor:pointer;padding:.5rem;border-radius:4px;transition:background-color .3s}.close-btn:hover{background-color:rgba(255,255,255,.1)}.modal-body{padding:2rem}.game-details-grid{display:grid;grid-template-columns:1fr 1fr;gap:2rem}.team-breakdown{background-color:#f8f9fa;border-radius:8px;overflow:hidden;border:1px solid #ddd;transition:background-color .3s,border-color .3s}.team-breakdown.winner{border-color:#28a745;border-width:2px}.modal-team-header{background-color:#333;color:#fff;padding:1rem 1.5rem;display:flex;align-items:center;justify-content:center;gap:1rem;transition:background-color .3s;cursor:pointer}.modal-team-info-wrapper{display:inline-flex;align-items:center;gap:.75rem}.modal-team-header.winner{background-color:#28a745}.modal-team-header h4{color:#fff;margin:0;font-size:1.3rem}.modal-team-record{font-size:1rem;opacity:.8}.modal-team-header .team-logo{width:40px;height:40px;border-radius:4px}.team-total{background-color:#e9ecef;padding:1rem;text-align:center;font-weight:700;font-size:1.1rem;border-bottom:2px solid #ddd;transition:background-color .3s,border-color .3s;display:flex;align-items:center;justify-content:center}.lineup-table{width:100%;border-collapse:collapse}.lineup-table th{background-color:#f8f9fa;padding:.8rem .5rem;text-align:center;font-weight:700;border-bottom:2px solid #ddd;font-size:.9rem;transition:background-color .3s,border-color .3s}.lineup-table th:first-child{text-align:left;width:50%}.lineup-table th:nth-child(2),.lineup-table th:nth-child(3){width:25%}.lineup-table td{padding:.8rem .5rem;border-bottom:1px solid #eee;font-size:.9rem;text-align:center;transition:border-color .3s}.lineup-table td:first-child{text-align:left}.lineup-table tr:hover{background-color:#fff}.captain-row{background-color:#fff3cd!important;font-weight:700}.captain-badge{background-color:#ffc107;color:#333;padding:.2rem .5rem;border-radius:12px;font-size:.7rem;font-weight:700;margin-left:.5rem}.captain-bonus{font-size:.75rem;color:#ffc107;font-weight:500;margin-top:.2rem}.player-name-cell{font-weight:500}.player-link{color:#007bff;text-decoration:none;font-weight:500;transition:color .3s ease}.player-link:hover{color:#0056b3;text-decoration:underline}.points-cell{text-align:center;font-weight:700}.rank-cell{text-align:center;color:#666}.live-indicator-modal{display:inline-block;width:10px;height:10px;background-color:#dc3545;border-radius:50%;margin-left:8px;vertical-align:middle;animation:pulse-live 1.5s infinite}@keyframes pulse-live{0%{opacity:1}50%{opacity:.4}100%{opacity:1}}.dark-mode .modal-content{background-color:#1e1e1e}.dark-mode .close-btn:hover{background-color:rgba(255,255,255,.2)}.dark-mode .team-breakdown{background-color:#2c2c2c;border-color:#444}.dark-mode .team-breakdown.winner{border-color:#66bb6a}.dark-mode .modal-team-header.winner{background-color:#2e7d32}.dark-mode .team-total{background-color:#3a3a3a;border-top:1px solid #4f4f4f;border-bottom:2px solid #4f4f4f}.dark-mode .lineup-table th{background-color:#2c2c2c;border-bottom-color:#444}.dark-mode .lineup-table td{border-color:#333}.dark-mode .lineup-table tr:hover{background-color:#383838}.dark-mode .captain-row{background-color:#4a4100!important}.dark-mode .captain-badge{background-color:#ffe082;color:#121212}.dark-mode .player-link{color:#8ab4f8}.dark-mode .player-link:hover{color:#a7c7fa}.dark-mode .rank-cell{color:#aaa}@media (max-width:768px){.modal-content{margin:1rem;width:calc(100% - 2rem)}.game-details-grid{grid-template-columns:1fr;gap:1rem}.modal-body{padding:1rem}.lineup-table th,.lineup-table td{padding:.5rem .3rem;font-size:.8rem}.modal-team-header .team-logo{width:36px;height:36px}.modal-header{padding:1rem}.modal-header h3{font-size:1.1rem;line-height:1.3;word-break:break-word;hyphens:auto}}@media (max-width:480px){.modal-header{padding:.8rem}.modal-header h3{font-size:1rem;line-height:1.2}}
    </style>
</head>
<body>
    <header>
        <button id="theme-toggle-btn" aria-label="Toggle Theme">
            <span class="sun-icon">☀️</span>
            <span class="moon-icon">🌙</span>
        </button>
        <h1>
            <img src="../icons/RKL.webp" alt="RKL Logo" class="header-logo" onerror="this.onerror=null; this.src='../rklfavicon.ico';">
            <span class="header-text">Real Karma League</span>
        </h1>
        <nav>
            <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">&#9776;</button>
            <ul id="nav-menu">
                <li><a href="RKL-S8.html">S8 Home</a></li>
                <li><a href="standings.html">Standings & Rankings</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0);" class="dropbtn">Stats Hub &#9662;</a>
                    <div class="dropdown-content">
                        <a href="leaderboards.html">Leaderboards</a>
                        <a href="compare.html">Comparison Tool</a>
                    </div>
                </li>
                <li><a href="schedule.html">Schedule</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0);" class="dropbtn">Draft Central &#9662;</a>
                    <div class="dropdown-content">
                        <a href="draft-capital.html">Draft Capital</a>
                        <a href="draft-results.html">Draft Results</a>
                        <a href="draft-lottery.html">Draft Lottery</a>
                    </div>
                </li>
                <li><a href="transactions.html">Transactions</a></li>
                <li><a href="teams.html">Teams</a></li>
                <li><a href="trophy-case.html">Trophy Case</a></li>
                <li><a href="changelog.html">Changelog</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="page-header">
            <h2>Season 8 Trophy Case</h2>
            <p>A showcase of the league's champions and award winners.</p>
        </div>

        <div id="awards-container">
            <div class="loading">Loading awards...</div>
        </div>
    </main>
    
    <div id="game-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Game Details</h3>
                <button class="close-btn" id="close-modal-btn">&times;</button>
            </div>
            <div class="modal-body" id="modal-body-content">
                 <div class="loading">Loading game details...</div>
            </div>
        </div>
    </div>

    <footer>
        <p>@caustic on Real</p>
        <a href="trade-block.html">GM Portal</a>
    </footer>

    <script src="../js/main.js" type="module"></script>
    <script type="module">
        import { db, doc, getDoc, getDocs, collection, query, where, limit } from '../js/firebase-init.js';
        import { generateLineupTable } from '../js/main.js';

        // --- CONFIGURATION ---
        const SEASON_ID = 'S8';
        const USE_DEV_COLLECTIONS = true; // Set to false for production
        const SEASON_NUMBER = SEASON_ID.replace('S', '');

        // --- GLOBAL CACHES ---
        let allTeamRecords = new Map();
        let playerStatsCache = new Map();

        // --- HELPER FUNCTIONS ---
        const getCollectionName = (baseName) => {
            const devCollections = [
                'awards', 'S8_awards', 'v2_players', 'seasonal_stats',
                'v2_teams', 'seasonal_records', 'seasons', 'games',
                'post_games', 'lineups', 'post_lineups'
            ];
            return (USE_DEV_COLLECTIONS && devCollections.includes(baseName)) ? `${baseName}_dev` : baseName;
        };

        const getPlayerSeasonalStats = async (playerId) => {
            if (playerStatsCache.has(playerId)) {
                return playerStatsCache.get(playerId);
            }
            try {
                const statsRef = doc(db, getCollectionName('v2_players'), playerId, getCollectionName('seasonal_stats'), SEASON_ID);
                const statsSnap = await getDoc(statsRef);
                if (statsSnap.exists()) {
                    const stats = statsSnap.data();
                    playerStatsCache.set(playerId, stats);
                    return stats;
                }
                return null;
            } catch (error) {
                console.error(`Failed to get stats for player ${playerId}:`, error);
                return null;
            }
        };
        
        const formatDateShort = (dateString) => {
            if (!dateString) return 'N/A';
            const parts = dateString.split('/');
            if (parts.length !== 3) return dateString; // Return original if format is wrong
            const [month, day, year] = parts;
            return `${month.padStart(2, '0')}/${day.padStart(2, '0')}/${String(year).slice(-2)}`;
        };

        const createAwardCard = (title, winnerData) => {
            if (!winnerData) return '';
            const { name, detail, nameLink, detailLink, logoId, stats, modalOnClick } = winnerData;
            const logoUrl = `../icons/${logoId}.webp`;
            const winnerNameHTML = nameLink ? `<a href="${nameLink}">${name}</a>` : name;
            const winnerDetailHTML = detailLink ? `<a href="${detailLink}">${detail}</a>` : detail;
            const statsHTML = stats ? `<div class="winner-stats">${modalOnClick ? `<a href="#" onclick="${modalOnClick}">${stats}</a>` : `<span>${stats}</span>`}</div>` : '';

            return `
                <div class="award-card">
                    <div>
                        <h3>${title}</h3>
                        <div class="award-winner">
                            <img src="${logoUrl}" alt="${name}" class="winner-logo" onerror="this.onerror=null; this.src='../icons/FA.webp';">
                            <div class="winner-info">
                                <div class="winner-name">${winnerNameHTML}</div>
                                <div class="winner-detail">${winnerDetailHTML}</div>
                            </div>
                        </div>
                    </div>
                    ${statsHTML}
                </div>`;
        };

        const tbdCardHTML = (title) => `
            <div class="award-card">
                <h3>${title}</h3>
                <div class="award-winner" style="flex-grow: 1; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: #999;">
                    TBD
                </div>
            </div>`;

        // --- CORE LOGIC ---
        async function loadTrophyCase() {
            const awardsContainer = document.getElementById('awards-container');
            try {
                // 1. Fetch all data concurrently
                const awardsCollectionRef = collection(db, getCollectionName('awards'), `season_${SEASON_NUMBER}`, getCollectionName(`S${SEASON_NUMBER}_awards`));
                const teamsCollectionRef = collection(db, getCollectionName('v2_teams'));

                const [awardsSnap, teamsSnap] = await Promise.all([
                    getDocs(awardsCollectionRef),
                    getDocs(teamsCollectionRef)
                ]);

                // 2. Cache Team Records
                const teamRecordPromises = teamsSnap.docs.map(teamDoc => {
                    const recordRef = doc(db, getCollectionName('v2_teams'), teamDoc.id, getCollectionName('seasonal_records'), SEASON_ID);
                    return getDoc(recordRef);
                });
                const teamRecordSnaps = await Promise.all(teamRecordPromises);
                
                teamRecordSnaps.forEach(recordSnap => {
                    if (recordSnap.exists()) {
                        allTeamRecords.set(recordSnap.ref.parent.parent.id, recordSnap.data());
                    }
                });
                
                // 3. Process Awards into a Map
                const awardsMap = new Map(awardsSnap.docs.map(doc => [doc.id, doc.data()]));

                // 4. Render Page Structure
                awardsContainer.innerHTML = `
                    <div class="awards-grid" id="top-awards"></div>
                    <div class="all-stars-container">
                        ${await renderAllStarTeam('Eastern', awardsMap.get('all-stars-eastern')?.players)}
                        ${await renderAllStarTeam('Western', awardsMap.get('all-stars-western')?.players)}
                    </div>
                    <div class="all-stars-container">
                        ${await renderAllStarTeam('Rising Stars East', awardsMap.get('rising-stars-eastern')?.players, true)}
                        ${await renderAllStarTeam('Rising Stars West', awardsMap.get('rising-stars-western')?.players, true)}
                    </div>
                `;
                
                // 5. Render Top Awards Grid
                await renderTopAwards(awardsMap);

            } catch (error) {
                console.error("Error loading trophy case:", error);
                awardsContainer.innerHTML = `<div class="error">Failed to load trophy case data. Please try again later.</div>`;
            }
        }

        async function renderTopAwards(awardsMap) {
            const topAwardsContainer = document.getElementById('top-awards');
            let topAwardsHTML = '';

            const awardOrder = [
                { id: 'league-champion', title: '🏆 League Champions 🏆', type: 'team' },
                { id: 'finals-mvp', title: 'Finals MVP', type: 'player' },
                { id: 'mvp', title: 'League MVP', type: 'player' },
                { id: 'regular-season-title', title: 'Regular Season Title', type: 'team' },
                { id: 'gm-of-the-year', title: 'GM of the Year', type: 'gm' },
                { id: 'rookie-of-the-year', title: 'Rookie of the Year', type: 'player' },
                { id: 'sixth-man', title: 'Sixth Man of the Year', type: 'player' },
                { id: 'most-improved', title: 'Most Improved Player', type: 'player' },
                { id: 'lvp', title: 'League LVP', type: 'player' },
                { id: 'best_performance_team', title: 'Best Performance (Team)', type: 'perf_team' },
                { id: 'best_performance_player', title: 'Best Performance (Player)', type: 'perf_player' }
            ];

            for (const awardInfo of awardOrder) {
                const awardData = awardsMap.get(awardInfo.id);
                if (awardData) {
                    let cardData = {};
                    const teamRecord = allTeamRecords.get(awardData.team_id);
                    const teamName = teamRecord?.team_name || 'Unknown';
                    const teamLink = `team.html?id=${awardData.team_id}`;

                    if (awardInfo.type === 'player' || awardInfo.type === 'gm') {
                        const playerStats = await getPlayerSeasonalStats(awardData.player_id);
                        const statsString = playerStats ? `REL: ${playerStats.rel_median.toFixed(3)} | Med Rank: ${Math.round(playerStats.medrank)}` : '';
                        cardData = {
                            name: awardData.player_handle || awardData.gm_handle,
                            detail: teamName,
                            nameLink: awardInfo.type === 'player' ? `player.html?player=${encodeURIComponent(awardData.player_handle)}` : null,
                            detailLink: teamLink,
                            logoId: awardData.team_id,
                            stats: awardInfo.id === 'lvp' ? `<span class="detail-negative">${statsString}</span>` : statsString
                        };
                    } else if (awardInfo.type === 'team') {
                        cardData = {
                            name: teamName,
                            detail: `Best Record: ${teamRecord?.wins}-${teamRecord?.losses}`,
                            nameLink: teamLink,
                            logoId: awardData.team_id,
                            stats: `PAM: ${Math.round(teamRecord?.pam || 0).toLocaleString()} | Med Rank: ${Math.round(teamRecord?.med_starter_rank || 0)}`
                        };
                    } else if (awardInfo.type.startsWith('perf')) {
                         const gameIdentifier = awardInfo.type === 'perf_player' ? 
                            `findGame('${awardData.date}', '${awardData.player_id}', null)` : 
                            `findGame('${awardData.date}', null, '${awardData.team_id}')`;
                        
                        cardData = {
                            name: awardData.player_handle || teamName,
                            detail: `Week ${awardData.week || '?'} on ${formatDateShort(awardData.date)}`,
                            nameLink: awardInfo.type === 'perf_player' ? `player.html?player=${encodeURIComponent(awardData.player_handle)}` : teamLink,
                            logoId: awardData.team_id,
                            stats: `<span class="detail-positive">+${(awardData.value * 100).toFixed(1)}%</span> over median`,
                            modalOnClick: `${gameIdentifier}; return false;`
                        };
                    }
                     topAwardsHTML += createAwardCard(awardInfo.title, cardData);
                } else {
                    topAwardsHTML += tbdCardHTML(awardInfo.title);
                }
            }
            topAwardsContainer.innerHTML = topAwardsHTML;
        }

        async function renderAllStarTeam(title, players, isRisingStar = false) {
            if (!players || players.length === 0) return '';
            
            const iconName = title.includes('Eastern') || title.includes('East') ? (isRisingStar ? 'RSE' : 'EAST') 
                           : (isRisingStar ? 'RSW' : 'WEST');

            const playerItems = await Promise.all(players.map(async (p) => {
                const stats = await getPlayerSeasonalStats(p.player_id);
                const relMedian = stats?.rel_median?.toFixed(3) || 'N/A';
                const medRank = Math.round(stats?.medrank) || 'N/A';
                
                return `
                    <li class="all-star-item">
                        <img src="../icons/${p.team_id}.webp" class="winner-logo" onerror="this.onerror=null; this.src='../icons/FA.webp';">
                        <div class="all-star-player-info">
                            <a href="player.html?player=${encodeURIComponent(p.player_handle)}">${p.player_handle}</a>
                        </div>
                        <div class="all-star-stat">${relMedian}</div>
                        <div class="all-star-stat">${medRank}</div>
                    </li>`;
            }));

            return `
                <div class="all-star-team">
                    <div class="all-star-header">
                        <h3>
                            <img src="../icons/${iconName}.png" alt="${title}" class="header-icon">
                            ${title}
                        </h3>
                    </div>
                    <div class="all-star-list-header">
                        <span class="player-col-header">Player</span>
                        <span class="stat-col-header">REL</span>
                        <span class="stat-col-header">MedRank</span>
                    </div>
                    <ul class="all-star-list">${playerItems.join('')}</ul>
                </div>`;
        }
        
        // --- MODAL LOGIC ---
        window.findGame = async (date, playerId, teamId) => {
            const modal = document.getElementById('game-modal');
            const modalBody = document.getElementById('modal-body-content');
            modal.style.display = 'block';
            modalBody.innerHTML = '<div class="loading">Finding game...</div>';

            try {
                let gameId, gameCollection;
                // Find game_id from lineups collection
                const lineupsRef = collection(db, getCollectionName('seasons'), SEASON_ID, getCollectionName('lineups'));
                const postLineupsRef = collection(db, getCollectionName('seasons'), SEASON_ID, getCollectionName('post_lineups'));

                const q = playerId ? 
                    query(lineupsRef, where("date", "==", date), where("player_id", "==", playerId), limit(1)) :
                    query(lineupsRef, where("date", "==", date), where("team_id", "==", teamId), limit(1));

                let lineupSnap = await getDocs(q);
                if (lineupSnap.empty) { // Check postseason if regular season comes up empty
                    const postQ = playerId ? 
                        query(postLineupsRef, where("date", "==", date), where("player_id", "==", playerId), limit(1)) :
                        query(postLineupsRef, where("date", "==", date), where("team_id", "==", teamId), limit(1));
                    lineupSnap = await getDocs(postQ);
                }

                if (lineupSnap.empty) {
                    throw new Error("Could not find a matching lineup to identify the game.");
                }

                const lineupData = lineupSnap.docs[0].data();
                gameId = lineupData.game_id;
                gameCollection = lineupData.game_type === 'regular' ? getCollectionName('games') : getCollectionName('post_games');
                
                await showGameDetails(gameId, gameCollection);

            } catch (error) {
                console.error("Error finding game:", error);
                modalBody.innerHTML = `<div class="error">${error.message}</div>`;
            }
        };

        async function showGameDetails(gameId, gameCollection) {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body-content');
            modalBody.innerHTML = '<div class="loading">Loading game details...</div>';
            
            try {
                // 1. Fetch game and lineups
                const gameRef = doc(db, getCollectionName('seasons'), SEASON_ID, gameCollection, gameId);
                const lineupsCollectionName = gameCollection === getCollectionName('games') ? getCollectionName('lineups') : getCollectionName('post_lineups');
                const lineupsQuery = query(collection(db, getCollectionName('seasons'), SEASON_ID, lineupsCollectionName), where("game_id", "==", gameId));

                const [gameSnap, lineupsSnap] = await Promise.all([getDoc(gameRef), getDocs(lineupsQuery)]);

                if (!gameSnap.exists()) throw new Error("Game not found.");
                
                const game = gameSnap.data();
                const allLineups = lineupsSnap.docs.map(d => d.data());

                // 2. Get Team Info
                const team1 = { id: game.team1_id, ...allTeamRecords.get(game.team1_id) };
                const team2 = { id: game.team2_id, ...allTeamRecords.get(game.team2_id) };

                modalTitle.textContent = `${team1.team_name} vs ${team2.team_name} (Week ${game.week} - ${formatDateShort(game.date)})`;

                // 3. Generate HTML using the imported function
                const team1Lineups = allLineups.filter(l => l.team_id === game.team1_id);
                const team2Lineups = allLineups.filter(l => l.team_id === game.team2_id);
                
                const team1Html = generateLineupTable(team1Lineups, team1, game.winner === game.team1_id);
                const team2Html = generateLineupTable(team2Lineups, team2, game.winner === game.team2_id);

                modalBody.innerHTML = `<div class="game-details-grid">${team1Html}${team2Html}</div>`;

            } catch (error) {
                console.error("Error showing game details:", error);
                modalBody.innerHTML = `<div class="error">Could not load game details.</div>`;
            }
        }
        
        function setupModalControls() {
            const modal = document.getElementById('game-modal');
            const closeBtn = document.getElementById('close-modal-btn');
            closeBtn.onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTrophyCase();
            setupModalControls();
        });

    </script>
</body>
</html>