<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RKL Season 8 Trophy Case</title>
    <link rel="stylesheet" href="/css/global-styles.css" />
    <link rel="stylesheet" href="/css/trophy-case.css" />
    <link rel="icon" href="/rklfavicon.ico" type="image/x-icon" />
    <script>
        window.firebasePageConfig = {
            useProdCollections: true 
        };
    </script>
    <script>
        (function () {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>
    <header>
        <button id="theme-toggle-btn" aria-label="Toggle Theme">
            <span class="sun-icon">‚òÄÔ∏è</span>
            <span class="moon-icon">üåô</span>
        </button>
        <h1>
            <a href="/index.html" class="header-link">
                <img src="/icons/RKL.webp" alt="RKL Logo" class="header-logo" onerror="this.style.display='none'">
                <span class="header-text">Real Karma League</span>
            </a>
        </h1>
        <nav>
            <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">&#9776;</button>
            <ul id="nav-menu">
                <li class="dropdown">
                    <a href="RKL-S8.html" class="dropbtn">S8 Home &#9662;</a>
                    <div class="dropdown-content">
                        <a href="/S8/RKL-S8.html">S8 Home</a>
                        <a href="/S7/RKL-S7.html">S7 Home</a>
                    </div>
                </li>
                <li><a href="standings.html">Standings & Rankings</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0);" class="dropbtn">Stats Hub &#9662;</a>
                    <div class="dropdown-content">
                        <a href="leaderboards.html">Leaderboards</a>
                        <a href="compare.html">Comparison Tool</a>
                    </div>
                </li>
                <li><a href="schedule.html">Schedule</a></li>
                <li class="dropdown">
                    <a href="javascript:void(0);" class="dropbtn">Draft Central &#9662;</a>
                    <div class="dropdown-content">
                        <a href="draft-capital.html">Draft Capital</a>
                        <a href="draft-results.html">Draft Results</a>
                        <a href="draft-lottery.html">Draft Lottery</a>
                        <a href="draft-prospects.html">Draft Prospects</a>
                    </div>
                </li>
                <li><a href="transactions.html">Transactions</a></li>
                <li><a href="teams.html">Teams</a></li>
                <li><a href="trophy-case.html">Trophy Case</a></li>
                <li><a href="/common/changelog.html">Changelog</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="page-header">
            <h2>Season 8 Trophy Case</h2>
            <p>A showcase of the league's champions and award winners.</p>
        </div>

        <div id="awards-container">
            <div class="loading">Loading awards...</div>
        </div>
    </main>
    
    <div id="game-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Game Details</h3>
                <button class="close-btn" id="close-modal-btn">&times;</button>
            </div>
            <div class="modal-body" id="modal-body-content">
                 <div class="loading">Loading game details...</div>
            </div>
        </div>
    </div>

    <footer>
        <p>@caustic on Real</p>
        <a href="/common/trade-block.html">GM Portal</a>
    </footer>

    <script src="../js/main.js" type="module"></script>
    <script type="module">
        import { db, doc, getDoc, getDocs, collection, query, where, limit, collectionGroup } from '../js/firebase-init.js';
        import { generateLineupTable } from '../js/main.js';

        const SEASON_ID = 'S8';
        const USE_DEV_COLLECTIONS = false;
        const SEASON_NUMBER = SEASON_ID.replace('S', '');

        let allTeamRecords = new Map();
        let playerStatsCache = new Map();

        const getCollectionName = (baseName) => {
            const devCollections = [
                'awards', 'S8_awards', 'v2_players', 'seasonal_stats',
                'v2_teams', 'seasonal_records', 'seasons', 'games',
                'post_games', 'lineups', 'post_lineups', 'daily_scores',
                `S${SEASON_NUMBER}_daily_scores`
            ];
            return (USE_DEV_COLLECTIONS && devCollections.includes(baseName)) ? `${baseName}_dev` : baseName;
        };

        const getPlayerSeasonalStats = (playerId) => {
            return playerStatsCache.has(playerId) ? playerStatsCache.get(playerId) : null;
        };

        const createAwardCard = (title, winnerData) => {
            if (!winnerData) return '';
            const { name, detail, nameLink, detailLink, logoId, stats, modalOnClick } = winnerData;
            const logoUrl = `../icons/${logoId}.webp`;
            const winnerNameHTML = nameLink ? `<a href="${nameLink}">${name}</a>` : name;
            const winnerDetailHTML = detailLink ? `<a href="${detailLink}">${detail}</a>` : detail;
            const statsHTML = stats ? `<div class="winner-stats">${modalOnClick ? `<a href="#" onclick="${modalOnClick}">${stats}</a>` : `<span>${stats}</span>`}</div>` : '';

            return `
                <div class="award-card">
                    <div>
                        <h3>${title}</h3>
                        <div class="award-winner">
                            <img src="${logoUrl}" alt="${name}" class="winner-logo" onerror="this.onerror=null; this.src='/icons/FA.webp';">
                            <div class="winner-info">
                                <div class="winner-name">${winnerNameHTML}</div>
                                <div class="winner-detail">${winnerDetailHTML}</div>
                            </div>
                        </div>
                    </div>
                    ${statsHTML}
                </div>`;
        };

        const tbdCardHTML = (title) => `
            <div class="award-card">
                <h3>${title}</h3>
                <div class="award-winner" style="flex-grow: 1; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: #999;">
                    TBD
                </div>
            </div>`;

        // --- CORE LOGIC ---
        async function loadTrophyCase() {
            const awardsContainer = document.getElementById('awards-container');
            try {
                const awardsCollectionRef = collection(db, getCollectionName('awards'), `season_${SEASON_NUMBER}`, getCollectionName(`S${SEASON_NUMBER}_awards`));
                const teamRecordsQuery = query(collectionGroup(db, getCollectionName('seasonal_records')));
                const playerStatsQuery = query(collectionGroup(db, getCollectionName('seasonal_stats')));

                const [awardsSnap, teamRecordsSnap, playerStatsSnap] = await Promise.all([
                    getDocs(awardsCollectionRef),
                    getDocs(teamRecordsQuery),
                    getDocs(playerStatsQuery)
                ]);

                teamRecordsSnap.docs.forEach(doc => {
                    if (doc.id === SEASON_ID) {
                        const teamId = doc.ref.parent.parent.id;
                        allTeamRecords.set(teamId, doc.data());
                    }
                });

                playerStatsSnap.docs.forEach(doc => {
                    if (doc.id === SEASON_ID) {
                        const playerId = doc.ref.parent.parent.id;
                        playerStatsCache.set(playerId, doc.data());
                    }
                });

                const awardsMap = new Map(awardsSnap.docs.map(doc => [doc.id, doc.data()]));

                const topAwardsHTML = await renderTopAwards(awardsMap);
                const allStarsHTML = `
                    <div class="all-stars-container">
                        ${renderAllStarTeam('Eastern Conference All-Stars', awardsMap.get('all-stars-eastern')?.players)}
                        ${renderAllStarTeam('Western Conference All-Stars', awardsMap.get('all-stars-western')?.players)}
                    </div>
                `;
                const risingStarsHTML = `
                     <div class="all-stars-container">
                        ${renderAllStarTeam('Rising Stars East', awardsMap.get('rising-stars-eastern')?.players, true)}
                        ${renderAllStarTeam('Rising Stars West', awardsMap.get('rising-stars-western')?.players, true)}
                    </div>
                `;
                
                awardsContainer.innerHTML = topAwardsHTML + allStarsHTML + risingStarsHTML;

            } catch (error) {
                console.error("Error loading trophy case:", error);
                awardsContainer.innerHTML = `<div class="error">Failed to load trophy case data. Please try again later.</div>`;
            }
        }

        async function renderTopAwards(awardsMap) {
            let html = '<div class="awards-grid">';
            const awardOrder = [
                { id: 'league-champion', title: 'üèÜ League Champions üèÜ' }, { id: 'finals-mvp', title: 'Finals MVP' },
                { id: 'mvp', title: 'League MVP' }, { id: 'regular-season-title', title: 'Regular Season Title' },
                { id: 'gm-of-the-year', title: 'GM of the Year' }, { id: 'rookie-of-the-year', title: 'Rookie of the Year' },
                { id: 'sixth-man', title: 'Sixth Man of the Year' }, { id: 'most-improved', title: 'Most Improved Player' },
                { id: 'lvp', title: 'League LVP' }, { id: 'best_performance_team', title: 'Best Performance (Team)' },
                { id: 'best_performance_player', title: 'Best Performance (Player)' }
            ];

            for (const awardInfo of awardOrder) {
                const awardData = awardsMap.get(awardInfo.id);
                if (!awardData) {
                    html += tbdCardHTML(awardInfo.title);
                    continue;
                }

                let cardData = {};
                const teamRecord = allTeamRecords.get(awardData.team_id);
                const teamName = teamRecord?.team_name || 'Unknown';
                const teamLink = `team.html?id=${awardData.team_id}`;

                switch (awardInfo.id) {
                    case 'league-champion':
                        cardData = { name: teamName, detail: '(Combined Record)', nameLink: teamLink, logoId: awardData.team_id, stats: `Record: ${awardData.champ_wins}-${awardData.champ_losses} | PAM: ${Math.round(awardData.champ_pam || 0).toLocaleString()} | Med Rank: ${Math.round(awardData.champ_medrank || 0)}`};
                        break;
                    case 'finals-mvp':
                        cardData = { name: awardData.player_handle, detail: teamName, nameLink: `player.html?handle=${encodeURIComponent(awardData.player_handle)}`, detailLink: teamLink, logoId: awardData.team_id, stats: `REL Median: ${(awardData.fmvp_rel_median || 0).toFixed(3)} | Med Rank: ${Math.round(awardData.fmvp_medrank || 0)}`};
                        break;
                    case 'regular-season-title':
                        cardData = { name: teamName, detail: 'Best Record', nameLink: teamLink, logoId: awardData.team_id, stats: `Record: ${teamRecord?.wins}-${teamRecord?.losses} | PAM: ${Math.round(teamRecord?.pam || 0).toLocaleString()} | Med Rank: ${Math.round(teamRecord?.med_starter_rank || 0)}`};
                        break;
                    case 'gm-of-the-year':
                        cardData = { name: awardData.gm_handle, detail: teamName, detailLink: teamLink, logoId: awardData.team_id, stats: `Record: ${teamRecord?.wins}-${teamRecord?.losses} | PAM: ${Math.round(teamRecord?.pam || 0).toLocaleString()} | Med Rank: ${Math.round(teamRecord?.med_starter_rank || 0)}`};
                        break;
                    case 'best_performance_team': {
                        const dailyScoresRef = collection(db, getCollectionName('daily_scores'), `season_${SEASON_NUMBER}`, getCollectionName(`S${SEASON_NUMBER}_daily_scores`));
                        const q = query(dailyScoresRef, where("date", "==", awardData.date), where("team_id", "==", awardData.team_id), limit(1));
                        const dailyScoreSnap = await getDocs(q);
                        const dailyScoreData = dailyScoreSnap.empty ? {} : dailyScoreSnap.docs[0].data();
                        cardData = { name: awardData.team_name, detail: `Week ${dailyScoreData.week || '?'} - ${Math.round(dailyScoreData.score || 0).toLocaleString()} Points`, nameLink: teamLink, logoId: awardData.team_id, stats: `<span class="detail-positive">+${(awardData.value * 100).toFixed(1)}%</span> over median`, modalOnClick: `findGameForTeam('${awardData.date}', '${awardData.team_id}'); return false;`};
                        break;
                    }
                    case 'best_performance_player': {
                        const lineupsRef = collection(db, getCollectionName('seasons'), SEASON_ID, getCollectionName('lineups'));
                        const postLineupsRef = collection(db, getCollectionName('seasons'), SEASON_ID, getCollectionName('post_lineups'));
                        let lineupSnap = await getDocs(query(lineupsRef, where("date", "==", awardData.date), where("player_id", "==", awardData.player_id), limit(1)));
                        let foundIn = 'regular season';
                        if (lineupSnap.empty) { foundIn = 'postseason'; lineupSnap = await getDocs(query(postLineupsRef, where("date", "==", awardData.date), where("player_id", "==", awardData.player_id), limit(1))); }
                        const lineupData = lineupSnap.empty ? {} : lineupSnap.docs[0].data();
                        const gameCollection = foundIn === 'regular season' ? getCollectionName('games') : getCollectionName('post_games');
                        cardData = { name: awardData.player_handle, detail: `Week ${lineupData.week || '?'} - ${Math.round(lineupData.points_adjusted || 0).toLocaleString()} Points`, nameLink: `player.html?handle=${encodeURIComponent(awardData.player_handle)}`, logoId: awardData.team_id, stats: `<span class="detail-positive">+${(awardData.value * 100).toFixed(1)}%</span> over median`, modalOnClick: lineupData.game_id ? `showGameDetails('${lineupData.game_id}', '${gameCollection}'); return false;` : `alert('Game data not found.'); return false;`};
                        break;
                    }
                    default: {
                        const playerStats = getPlayerSeasonalStats(awardData.player_id);
                        const statsString = playerStats ? `REL Median: ${playerStats.rel_median.toFixed(3)} | Med Rank: ${Math.round(playerStats.medrank)}` : '';
                        cardData = { name: awardData.player_handle, detail: teamName, nameLink: `player.html?handle=${encodeURIComponent(awardData.player_handle)}`, detailLink: teamLink, logoId: awardData.team_id, stats: awardInfo.id === 'lvp' ? `<span class="detail-negative">${statsString}</span>` : statsString};
                    }
                }
                html += createAwardCard(awardInfo.title, cardData);
            }
            html += '</div>'; // close awards-grid
            return html;
        }

        function renderAllStarTeam(title, players, isRisingStar = false) {
            if (!players || players.length === 0) return '';
            const iconName = title.includes('Eastern') ? (isRisingStar ? 'RSE' : 'EAST') : (isRisingStar ? 'RSW' : 'WEST');
            
            const playerItems = players.map(p => {
                const stats = getPlayerSeasonalStats(p.player_id);
                const relMedian = stats?.rel_median?.toFixed(3) || 'N/A';
                const war = stats?.WAR?.toFixed(2) || 'N/A';
                const gem = stats?.GEM?.toFixed(2) || 'N/A';
                const medRank = Math.round(stats?.medrank) || 'N/A';
                const isAllStar = stats?.all_star === '1';
                const isRookie = stats?.rookie === '1';
                let badgesHTML = '';
                if(isAllStar) badgesHTML += `<span class="all-star-badge">‚òÖ</span>`;
                if(isRookie) badgesHTML += `<span class="rookie-badge">R</span>`;
                
                return `
                    <li class="all-star-item">
                        <img src="../icons/${p.team_id}.webp" class="winner-logo" onerror="this.onerror=null; this.src='../icons/FA.webp';">
                        <div class="all-star-player-info">
                            <a href="player.html?handle=${encodeURIComponent(p.player_handle)}"><span class="player-name-truncate">${p.player_handle}</span> ${badgesHTML}</a>
                            <div class="all-star-stats">Med Rank: ${medRank}</div>
                        </div>
                        <div class="all-star-stat">${relMedian}</div>
                        <div class="all-star-stat">${war}</div>
                        <div class="all-star-stat">${gem}</div>
                    </li>`;
            }).join('');

            return `
                <div class="all-star-team">
                    <div class="all-star-header"><h3><img src="../icons/${iconName}.png" alt="${title}" class="header-icon">${title}</h3></div>
                    <div class="all-star-list-header">
                        <span class="player-col-header">Player</span>
                        <span class="stat-col-header">REL Med</span>
                        <span class="stat-col-header">WAR</span>
                        <span class="stat-col-header">GEM</span>
                    </div>
                    <ul class="all-star-list">${playerItems}</ul>
                </div>`;
        }
        
        window.findGameForTeam = async (date, teamId) => {
            const modalBody = document.getElementById('modal-body-content');
            document.getElementById('game-modal').style.display = 'block';
            modalBody.innerHTML = '<div class="loading">Finding game...</div>';
            try {
                const gamesRef = collection(db, getCollectionName('seasons'), SEASON_ID, getCollectionName('games'));
                const q = query(gamesRef, where("date", "==", date));
                const gamesSnap = await getDocs(q);
                const gameDoc = gamesSnap.docs.find(doc => doc.data().team1_id === teamId || doc.data().team2_id === teamId);
                if (!gameDoc) throw new Error("Could not find matching game for this performance.");
                await showGameDetails(gameDoc.id, getCollectionName('games'));
            } catch(error) {
                console.error("Error finding team game:", error);
                modalBody.innerHTML = `<div class="error">${error.message}</div>`;
            }
        };

        window.showGameDetails = async (gameId, gameCollection) => {
            const modal = document.getElementById('game-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body-content');
            modal.style.display = 'block';
            modalBody.innerHTML = '<div class="loading">Loading game details...</div>';
            
            try {
                if(!gameId || gameId === 'undefined') throw new Error("Game ID is missing or undefined.");
                const gameRef = doc(db, getCollectionName('seasons'), SEASON_ID, gameCollection, gameId);
                const lineupsCollectionName = gameCollection === getCollectionName('games') ? getCollectionName('lineups') : getCollectionName('post_lineups');
                const lineupsQuery = query(collection(db, getCollectionName('seasons'), SEASON_ID, lineupsCollectionName), where("game_id", "==", gameId), where("starter", "==", "1"));
                const [gameSnap, lineupsSnap] = await Promise.all([getDoc(gameRef), getDocs(lineupsQuery)]);
                if (!gameSnap.exists()) throw new Error("Game not found.");
                
                const game = gameSnap.data();

                const allPlayerIdsInGame = lineupsSnap.docs.map(doc => doc.data().player_id);
                const uniquePlayerIds = [...new Set(allPlayerIdsInGame)];

                const playerStatsPromises = uniquePlayerIds.map(playerId => 
                    getDoc(doc(db, getCollectionName('v2_players'), playerId, getCollectionName('seasonal_stats'), SEASON_ID))
                );
                const playerStatsDocs = await Promise.all(playerStatsPromises);
                
                const playerSeasonalStats = new Map();
                playerStatsDocs.forEach((docSnap, index) => {
                    if (docSnap.exists()) {
                        playerSeasonalStats.set(uniquePlayerIds[index], docSnap.data());
                    }
                });

                const allLineups = lineupsSnap.docs.map(d => {
                    const lineupData = d.data();
                    return { ...lineupData, ...playerSeasonalStats.get(lineupData.player_id) };
                });
                const team1 = { id: game.team1_id, ...allTeamRecords.get(game.team1_id) };
                const team2 = { id: game.team2_id, ...allTeamRecords.get(game.team2_id) };
                modalTitle.textContent = `${team1.team_name} vs ${team2.team_name} (Week ${game.week})`;
                const team1Lineups = allLineups.filter(l => l.team_id === game.team1_id);
                const team2Lineups = allLineups.filter(l => l.team_id === game.team2_id);
                modalBody.innerHTML = `<div class="game-details-grid">${generateLineupTable(team1Lineups, team1, game.winner === game.team1_id)}${generateLineupTable(team2Lineups, team2, game.winner === game.team2_id)}</div>`;
            } catch (error) {
                console.error("Error showing game details:", error);
                modalBody.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }
        
        function setupModalControls() {
            const modal = document.getElementById('game-modal');
            const closeBtn = document.getElementById('close-modal-btn');
            closeBtn.onclick = () => modal.style.display = 'none';
            window.onclick = (event) => { if (event.target === modal) modal.style.display = 'none'; };
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadTrophyCase();
            setupModalControls();
        });
    </script>
</body>
</html>
