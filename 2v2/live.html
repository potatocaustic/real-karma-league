<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2v2 Live Scores</title>
  <link rel="stylesheet" href="/css/global-styles.css">
  <link rel="icon" href="/rklfavicon.ico" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    (function () {
      const theme = localStorage.getItem('theme');
      if (theme === 'dark') {
        document.documentElement.classList.add('dark-mode');
      }
    })();
  </script>
  <script>
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
  <style>
    .games-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 1.5rem;
    }

    .game-card {
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1.5rem;
      border-left: 4px solid #dc3545;
      transition: background-color 0.3s, border-color 0.3s;
    }

    .game-teams {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .team {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0;
    }

    .team.winner {
      font-weight: bold;
      color: #28a745;
    }

    .team-name {
      font-size: 1rem;
      font-weight: 500;
    }

    .team-score {
      font-weight: bold;
      color: #333;
      font-size: 1.2rem;
    }

    .team-score.winner {
      color: #28a745;
    }

    .game-details {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #ddd;
    }

    .game-details-header {
      cursor: pointer;
      padding: 0.5rem;
      background-color: #e9ecef;
      border-radius: 4px;
      text-align: center;
      font-weight: 500;
      margin-bottom: 0.75rem;
      transition: background-color 0.2s;
    }

    .game-details-header:hover {
      background-color: #dee2e6;
    }

    .team-roster {
      margin-bottom: 1.5rem;
    }

    .roster-title {
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #666;
      font-size: 0.95rem;
    }

    .player-row {
      padding: 0.5rem 0.75rem;
      background-color: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 0.4rem;
      font-size: 0.9rem;
      transition: background-color 0.3s;
    }

    .roster-content {
      display: none;
    }

    .roster-content.show {
      display: block;
    }

    /* Dark mode styles */
    .dark-mode .game-card {
      background-color: #2c2c2c;
      border-color: #444;
    }

    .dark-mode .game-card {
      border-left-color: #ef5350;
    }

    .dark-mode .team-score {
      color: #e0e0e0;
    }

    .dark-mode .team.winner,
    .dark-mode .team-score.winner {
      color: #66bb6a;
    }

    .dark-mode .roster-title {
      color: #aaa;
    }

    .dark-mode .player-row {
      background-color: #333;
      color: #fff;
    }

    .dark-mode .game-details {
      border-top-color: #444;
    }

    .dark-mode .game-details-header {
      background-color: #3a3a3a;
    }

    .dark-mode .game-details-header:hover {
      background-color: #444;
    }

    @media (max-width: 768px) {
      .games-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <button id="theme-toggle-btn" aria-label="Toggle Theme">
      <span class="sun-icon">‚òÄÔ∏è</span>
      <span class="moon-icon">üåô</span>
    </button>
    <h1>
      <a href="/index.html" class="header-link">
        <img src="/icons/RKL.webp" alt="RKL Logo" class="header-logo" onerror="this.style.display='none'">
        <span class="header-text">Real Karma League</span>
      </a>
    </h1>
    <nav>
      <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">&#9776;</button>
      <ul id="nav-menu">
        <li><a href="/index.html">Home</a></li>
        <li><a href="/2v2/live.html">2v2 Live Scores</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <div class="page-header">
      <h2>2v2 Tourney Live Scores</h2>
      <p>Live matchup scores for today's games</p>
    </div>
    <div class="loading" id="loading-indicator">Loading...</div>
    <div class="games-grid" id="games-container"></div>
  </main>
  <footer>
    <p>@caustic on Real</p>
    <a href="/gm/dashboard.html">GM Portal</a>
  </footer>
  <script>
    const scheduleCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSpWzfvc-MwID3Tj-SkourUAzBYqwfDOK6SJTBpyfgplNEtzpDxOGqgV09ztCUq9v_3p5olQdoMoMO6/pub?output=csv';
    const rosterCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS4_SVg1vjgXMH3UN4KTz9WJqKMa5Ot0PXj9whT1MDW1fBTAY-fKTjGziUb9TALcU-hFpu6AiBxaZ7C/pub?output=csv';
    const WORKER_URL = 'https://rkl-karma-proxy.caustic.workers.dev/';
    const karmaCache = new Map();

    function getTodayString() {
      const now = new Date();
      const options = {
        timeZone: 'America/New_York',
        year: 'numeric',
        month: 'numeric',
        day: 'numeric',
        hour: 'numeric',
        hour12: false
      };
      const formatter = new Intl.DateTimeFormat('en-US', options);
      const parts = formatter.formatToParts(now);
      
      const estDateParts = {};
      for (const part of parts) {
        if (part.type !== 'literal') {
          estDateParts[part.type] = part.value;
        }
      }

      // Handle 24-hour clock case where '24' means '0'
      let estHour = parseInt(estDateParts.hour, 10);
      if (estHour === 24) estHour = 0;
      
      // Create a date object based on the EST year, month, and day
      // Note: month is 0-indexed for new Date(), but 1-indexed from formatter
      const est = new Date(
        parseInt(estDateParts.year),
        parseInt(estDateParts.month) - 1,
        parseInt(estDateParts.day)
      );

      // If the hour in EST is before 7 AM, roll the date back by one day
      if (estHour < 7) {
        est.setDate(est.getDate() - 1);
      }
      
      return `${est.getMonth() + 1}/${est.getDate()}`;
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      return lines.slice(1).map(line => {
        const values = line.split(',').map(p => p.trim());
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i]);
        return obj;
      });
    }

    async function fetchKarma(userId) {
      if (karmaCache.has(userId)) return karmaCache.get(userId);
      try {
        const res = await fetch(`${WORKER_URL}?userId=${encodeURIComponent(userId)}`);
        const data = await res.json();
        const val = parseFloat(data?.stats?.karmaDelta || 0);
        karmaCache.set(userId, val);
        return val;
      } catch {
        return 0;
      }
    }

    async function limitedMap(array, limit, asyncFn, onProgress) {
      const results = [];
      let index = 0;
      const executing = new Set();

      for (const item of array) {
        const p = asyncFn(item).then(res => {
          results.push(res);
          if (onProgress) onProgress(++index, array.length);
        });
        executing.add(p);
        p.finally(() => executing.delete(p));
        if (executing.size >= limit) await Promise.race(executing);
      }
      await Promise.all(executing);
      return results;
    }

    async function processTeam(players) {
      let teamTotal = 0;
      const rows = await limitedMap(players, 10, async p => {
        const userId = p['User ID']?.trim();
        const userAt = p['User @']?.trim() || 'Unknown';
        const role = (p['role'] || '').toLowerCase();
        const deduction = parseFloat(p['deductions'] || 0);

        if (!userId || userId.toLowerCase() === 'not found') return `${userAt}: missing`;

        const base = await fetchKarma(userId);
        const adjusted = base - deduction;
        const boosted = role === 'captain' ? adjusted * 1.5 : adjusted;

        teamTotal += boosted;

        const rounded = Math.round(adjusted);
        const label = role === 'captain'
          ? `${userAt} (c): ${rounded} ‚Üí ${Math.round(boosted)}`
          : `${userAt}: ${rounded}`;

        return `<div class="player-row">${label}</div>`;
      });
      return { rows, total: Math.round(teamTotal) };
    }

    function createGameHTML(team1, team2, t1Total, t2Total, t1Rows, t2Rows, index) {
      const detailsId = `details-${index}`;
      const isWinner1 = t1Total > t2Total;
      const isWinner2 = t2Total > t1Total;

      return `
        <div class="game-card">
          <div class="game-teams">
            <div class="team ${isWinner1 ? 'winner' : ''}">
              <span class="team-name">${team1}</span>
              <span class="team-score ${isWinner1 ? 'winner' : ''}">${t1Total}</span>
            </div>
            <div class="team ${isWinner2 ? 'winner' : ''}">
              <span class="team-name">${team2}</span>
              <span class="team-score ${isWinner2 ? 'winner' : ''}">${t2Total}</span>
            </div>
          </div>
          <div class="game-details">
            <div class="game-details-header" onclick="
              const content = document.getElementById('${detailsId}');
              content.classList.toggle('show');
            ">
              View Player Details ‚ñº
            </div>
            <div class="roster-content" id="${detailsId}">
              <div class="team-roster">
                <div class="roster-title">${team1}</div>
                ${t1Rows.join('')}
              </div>
              <div class="team-roster">
                <div class="roster-title">${team2}</div>
                ${t2Rows.join('')}
              </div>
            </div>
          </div>
        </div>`;
    }

    async function loadGames() {
      const loading = document.getElementById('loading-indicator');
      const container = document.getElementById('games-container');

      try {
        const [scheduleRes, rosterRes] = await Promise.all([
          axios.get(scheduleCsvUrl),
          axios.get(rosterCsvUrl)
        ]);

        const today = getTodayString();
        const games = parseCSV(scheduleRes.data).filter(g => g.Date?.trim() === today);
        const players = parseCSV(rosterRes.data).filter(p => p['playing?']?.toLowerCase() === 'yes');

        for (let i = 0; i < games.length; i++) {
          const game = games[i];
          const t1 = game['Team 1'];
          const t2 = game['Team 2'];
          const t1Players = players.filter(p => p.Team === t1);
          const t2Players = players.filter(p => p.Team === t2);

          const [t1Data, t2Data] = await Promise.all([
            processTeam(t1Players),
            processTeam(t2Players)
          ]);

          container.innerHTML += createGameHTML(t1, t2, t1Data.total, t2Data.total, t1Data.rows, t2Data.rows, i);
        }

        loading.style.display = 'none';
      } catch (e) {
        loading.textContent = 'Failed to load game data.';
        console.error(e);
      }
    }

    loadGames();
  </script>
  <script src="/js/main.js" type="module" defer></script>
</body>
</html>
